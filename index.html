<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 Geïntegreerd Leerling Management Systeem</title>
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	
    <style>
               * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        /* Login Screen Styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .login-header {
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-header p {
            color: #666;
            font-size: 1.1rem;
        }

        .login-modes {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .login-mode-btn {
            padding: 1.5rem;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
        }

        .login-mode-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1rem;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pin-input {
            text-align: center;
            font-size: 2rem !important;
            letter-spacing: 0.5rem;
            font-weight: bold;
        }

        .login-btn {
            width: 100%;
            padding: 1.2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .back-btn {
            background: #718096;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #4a5568;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 2px solid #feb2b2;
        }

        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 2px solid #9ae6b4;
        }

        /* App Container */
        .app-container {
            display: none;
            height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        /* Logout Button */
        .logout-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(220, 38, 38, 0.9);
            transform: translateY(-2px);
        }

        /* Cloud Sync Status */
        .cloud-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .cloud-status.online {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid rgba(72, 187, 120, 0.5);
        }

        .cloud-status.offline {
            background: rgba(245, 101, 101, 0.2);
            border: 2px solid rgba(245, 101, 101, 0.5);
        }

        .cloud-status.syncing {
            background: rgba(237, 137, 54, 0.2);
            border: 2px solid rgba(237, 137, 54, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Mode Toggle - Adjusted for teacher mode */
        .mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .mode-btn:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Cloud Sync Panel */
        .cloud-sync-panel {
            background: #e6f7ff;
            border: 2px solid #1890ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .cloud-sync-panel h3 {
            color: #1890ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .sync-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #d9d9d9;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sync-toggle.enabled {
            border-color: #52c41a;
            background: #f6ffed;
        }

        .sync-toggle input[type="checkbox"] {
            margin: 0;
        }

        /* PIN Management Styles */
        .pin-management {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .pin-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .pin-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pin-display {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            background: #f7fafc;
            padding: 0.5rem;
            border-radius: 4px;
            min-width: 60px;
            text-align: center;
        }

        /* Student Dashboard Sidebar */
        .dashboard-sidebar {
            width: 400px;
            background: linear-gradient(180deg, #2d1b69 0%, #0f0f23 100%);
            border-right: 2px solid #4a4a6a;
            overflow-y: auto;
            display: none;
            height: 200vh;
            flex-direction: column;
        }

        .dashboard-sidebar.active {
            display: flex;
        }

        .student-profile {
            background: linear-gradient(135deg, #6a4c93, #9c27b0);
            padding: 0.75rem;
            text-align: center;
            border-bottom: 2px solid #4a4a6a;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            margin: 0 auto 0.75rem;
            object-fit: cover;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .student-avatar:hover {
            transform: scale(1.05);
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .student-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .student-title {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Energy Level in Sidebar */
        .energy-section {
            padding: 0.75rem;
            background: rgba(0, 188, 212, 0.1);
            border-bottom: 1px solid #4a4a6a;
        }

        .energy-section h3 {
            margin-bottom: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .energy-display {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
        }

        .energy-level {
            font-size: 1.5rem;
            margin: 0.3rem 0;
            cursor: pointer;
        }

        /* Skills Progress in Sidebar */
        .skills-section {
            padding: 0.75rem;
            border-bottom: 1px solid #4a4a6a;
        }

        .skills-section h3 {
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            text-align: center;
        }

        .skill-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .skill-label {
            font-weight: bold;
            width: 3rem;
            font-size: 0.9rem;
        }

        .skill-bar {
            flex: 1;
            height: 1rem;
            background: #333;
            border-radius: 0.5rem;
            margin: 0 0.5rem;
            overflow: hidden;
        }

        .skill-fill {
            height: 100%;
            transition: width 0.8s ease-in-out;
        }

        .skill-zb .skill-fill { background: linear-gradient(90deg, #2196f3, #03a9f4); }
        .skill-zm .skill-fill { background: linear-gradient(90deg, #e91e63, #9c27b0); }
        .skill-sb .skill-fill { background: linear-gradient(90deg, #ffeb3b, #ffc107); }
        .skill-rv .skill-fill { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .skill-vb .skill-fill { background: linear-gradient(90deg, #ff9800, #f57c00); }

        .skill-percentage {
            min-width: 40px;
            text-align: right;
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* Task Progress in Sidebar */
        .tasks-section {
            padding: 0.75rem;
            background: rgba(72, 187, 120, 0.1);
            border-bottom: 1px solid #4a4a6a;
            max-height: 200px;
            overflow-y: auto;
        }

        .tasks-section h3 {
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            text-align: center;
        }

        .task-mini {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.4rem;
            background: rgba(72, 187, 120, 0.2);
            padding: 0.4rem;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .task-mini:hover {
            background: rgba(72, 187, 120, 0.3);
            transform: translateX(5px);
        }

        .task-mini.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .task-status {
            font-size: 1rem;
        }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            font-size: 0.8rem;
        }

        .task-subject {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Sidebar Tokens */
        .sidebar-tokens {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            max-height: 300px;
            overflow-y: auto;
        }

        .sidebar-tokens h3 {
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .token-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            justify-content: center;
        }

        .sidebar-token {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .sidebar-token:hover {
            transform: scale(1.1);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-token.empty {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
        }

        /* Milestones in Sidebar */
        .milestones-section {
            padding: 0.75rem;
            background: rgba(255, 215, 0, 0.1);
            flex-grow: 1;
            min-height: 120px;
            max-height: 350px;
            overflow-y: auto;
        }

        .milestones-section h3 {
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            text-align: center;
        }

        .milestone-mini {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.4rem;
            background: rgba(255, 215, 0, 0.2);
            padding: 0.4rem;
            border-radius: 0.4rem;
        }

        .milestone-badge {
            font-size: 1.2rem;
        }

        .milestone-info {
            flex: 1;
        }

        .milestone-name {
            font-weight: bold;
            font-size: 0.8rem;
        }

        .milestone-level {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .admin-content {
            flex: 1;
            display: none;
            flex-direction: column;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        /* Statistics Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card.tasks {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .stat-card.compliments {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .stat-card.skills {
            background: linear-gradient(135deg, #4299e1, #3182ce);
        }

        .stat-card.milestones {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #2d3748;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
            min-height: 60px;
        }

        .tab-button {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            background: none;
            border: none;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            white-space: nowrap;
        }

        .tab-button:hover {
            background: #f7fafc;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }
		
		/* Fix voor alle tab content ruimte */
.tab-content {
    margin-top: 0 !important;
}

.tab-content .main-content-panel {
    margin-top: 0 !important;
    padding-top: 20px !important;
}

        .tab-content.active {
            display: block;
        }

        /* Main Content Panel */
        .main-content-panel {
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Student Dashboard Mode */
        .student-dashboard {
            padding: 2rem;
            display: none;
        }

        .student-dashboard.active {
            display: block;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .dashboard-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .student-selector {
            max-width: 400px;
            margin: 0 auto 2rem;
        }

        .student-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
        }

        .student-select option {
            background: #2d1b69;
            color: white;
        }

        /* Dashboard Content */
        .dashboard-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .dashboard-panel {
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .dashboard-panel h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
        }

        /* Task Styles */
        .task-grid {
            display: grid;
            gap: 1rem;
        }

        .task-card {
            background: #f8f9ff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .task-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .task-card.completed {
            background: #f0fff4;
            border-color: #48bb78;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .task-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .task-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .task-actions {
            display: flex;
            gap: 8px;
        }

        /* Token Grid */
        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 2rem;
        }

        .token-option {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .token-option:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .token-visual {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 10px;
        }

        .token-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .token-skill-boost {
            font-size: 0.8rem;
            color: #666;
        }

        /* Milestones Display */
        .milestones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .milestone-card {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #2d3748;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            border: 3px solid #ffd700;
            transition: all 0.3s;
        }

        .milestone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(255, 215, 0, 0.4);
        }

        .milestone-card .milestone-badge {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .milestone-card .milestone-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .milestone-card .milestone-skill {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .milestone-card .milestone-level {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1rem;
            padding: 0.5rem 1rem;
            margin-top: 1rem;
            font-weight: bold;
        }

        /* Forms and Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
        }

        .forms-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .forms-container .add-student-form,
        .forms-container .add-task-form,
        .forms-container .add-compliment-form {
            flex: 1;
            margin-bottom: 0;
        }

        .add-student-form, .add-task-form, .add-compliment-form {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            border: 2px dashed #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            margin-bottom: 15px;
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            color: #2d3748;
        }

        .modal h3 {
            margin-bottom: 20px;
            text-align: center;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #48bb78;
        }

        .notification.error {
            background: #f56565;
        }

        .notification.warning {
            background: #ed8936;
        }

        .notification.milestone {
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            color: #2d3748;
            border: 2px solid #ffd700;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        /* Sidebar View Buttons */
        .sidebar-view-btn {
            transition: all 0.3s ease;
        }

        .sidebar-view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            filter: brightness(1.1);
        }

        /* Sidebar section hover effects */
        .tasks-section h3:hover,
        .skills-section h3:hover,
        .sidebar-tokens h3:hover,
        .milestones-section h3:hover {
            transform: translateX(3px);
        }

        /* Personal Goals */
        .personal-goal {
            background: rgba(156, 39, 176, 0.1);
            border: 2px solid rgba(156, 39, 176, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .personal-goal-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .personal-goal-text {
            font-size: 0.9rem;
            color: #6b21a8;
            font-style: italic;
        }
		/* Portfolio Styles */
.portfolio-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 10px;
    margin-bottom: 1.5rem;
}

.portfolio-stat-card {
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    color: white;
    font-weight: bold;
}

.portfolio-activities {
    background: #f8f9ff;
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
}

.portfolio-activity {
    padding: 8px 0;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.9rem;
}

.portfolio-activity:last-child {
    border-bottom: none;
}

.portfolio-activity-meta {
    color: #666;
    font-size: 0.8rem;
    margin-top: 2px;
}


        /* Responsive Design */
        @media (max-width: 768px) {
            .login-container {
                padding: 1rem;
            }
            
            .login-box {
                padding: 2rem;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .dashboard-sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }
            
            .mode-toggle {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
                justify-content: center;
            }
            
            .dashboard-content {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .forms-container {
                flex-direction: column;
                gap: 15px;
            }

            .tab-navigation {
                overflow-x: auto;
            }

            .tab-button {
                min-width: 100px;
                font-size: 0.85rem;
            }

            .cloud-status {
                position: relative;
                top: auto;
                left: auto;
                transform: none;
                margin-bottom: 1rem;
                justify-self: center;
            }
        }

        /* Presentation Styles */
        .presentation-students-grid {
            display: grid;
            gap: 25px;
            margin-top: 30px;
        }

        .presentation-students-grid.grid-1 {
            grid-template-columns: 1fr;
            max-width: 600px;
            margin: 30px auto 0;
        }

        .presentation-students-grid.grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .presentation-students-grid.grid-3 {
            grid-template-columns: repeat(3, 1fr);
        }

        .presentation-students-grid.grid-4 {
    grid-template-columns: repeat(4, 1fr);
}

.presentation-students-grid.grid-5 {
    grid-template-columns: repeat(5, 1fr);
}

.presentation-students-grid.grid-6 {
    grid-template-columns: repeat(6, 1fr);
}

        .presentation-student-card {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border: 3px solid #e2e8f0;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .presentation-student-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .presentation-student-name {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
        }

        .presentation-tokens {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            min-height: 140px;
            align-content: flex-start;
        }

        .presentation-token {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            border: 4px solid #fff;
            box-shadow: 0 6px 18px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .presentation-token:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .presentation-stats {
            margin-top: 15px;
            font-size: 1.1rem;
            color: #666;
            font-weight: 600;
        }

        /* Timeline Styles */
        .timeline-container {
            position: relative;
        }

        .timeline-date-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin: 25px 0 15px 0;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .timeline-item {
            position: relative;
            background: #f8f9ff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0 15px 40px;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -52px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
        }

        .timeline-student-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .timeline-description {
            color: #4a5568;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .timeline-time {
            font-size: 0.85rem;
            color: #718096;
            font-weight: 500;
        }
		
		/* Personal Goals Styles */
.personal-goals-grid {
    display: grid;
    gap: 15px;
    margin-top: 15px;
}

.personal-goal-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
}

.personal-goal-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.personal-goal-card.completed {
    background: linear-gradient(135deg, #48bb78, #38a169);
}

.personal-goal-card.overdue {
    background: linear-gradient(135deg, #f56565, #e53e3e);
}

.goal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.goal-title {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 8px;
    line-height: 1.3;
}

.goal-category {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.goal-description {
    margin-bottom: 15px;
    opacity: 0.9;
    line-height: 1.4;
    font-size: 0.95rem;
}

.goal-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    font-size: 0.85rem;
}

.goal-deadline {
    background: rgba(255, 255, 255, 0.15);
    padding: 4px 8px;
    border-radius: 6px;
    font-weight: 600;
}

.goal-priority {
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
}

.goal-actions {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.3s;
}

.personal-goal-card:hover .goal-actions {
    opacity: 1;
}

.goal-action-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 6px 8px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background 0.3s;
}

.goal-action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.goal-status {
    position: absolute;
    top: -5px;
    left: 20px;
    background: #ffd700;
    color: #2d3748;
    padding: 4px 12px;
    border-radius: 0 0 10px 10px;
    font-size: 0.8rem;
    font-weight: bold;
}

.goal-status.completed {
    background: #48bb78;
    color: white;
}

.goal-status.overdue {
    background: #f56565;
    color: white;
}

.add-goal-card {
    background: rgba(255, 255, 255, 0.1);
    border: 2px dashed rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    color: rgba(255, 255, 255, 0.7);
}

.add-goal-card:hover {
    border-color: rgba(255, 255, 255, 0.6);
    color: rgba(255, 255, 255, 0.9);
    transform: translateY(-3px);
}

.add-goal-icon {
    font-size: 3rem;
    margin-bottom: 10px;
}
/* Evidence Upload Styling */
.evidence-upload-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    background: #f8f9ff;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.evidence-upload-area:hover {
    background: #f0f8ff;
    border-color: #5a67d8;
}

.evidence-upload-area.dragover {
    background: #e6f3ff;
    border-color: #4299e1;
    transform: scale(1.02);
}

.evidence-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.evidence-item {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
}

.evidence-item:hover {
    border-color: #667eea;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.evidence-preview {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.evidence-file-icon {
    width: 100%;
    height: 120px;
    background: #f0f9ff;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    margin-bottom: 10px;
    color: #667eea;
}

.evidence-title {
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
    font-size: 0.9rem;
}

.evidence-meta {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 10px;
}

.evidence-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
}

.evidence-item:hover .evidence-remove {
    opacity: 1;
}

.evidence-download {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.3s;
}

.evidence-download:hover {
    background: #5a67d8;
    transform: translateY(-1px);
}
/* Timeline Styles for Goals */
.goal-timeline-container {
    position: relative;
}

.goal-timeline-item {
    transition: all 0.3s ease;
}

.goal-timeline-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.goal-timeline-item details summary {
    transition: color 0.3s;
}

.goal-timeline-item details summary:hover {
    color: #5a67d8;
}

.goal-timeline-item details[open] summary {
    margin-bottom: 8px;
}

// === PERSOONLIJKE DOELEN PORTFOLIO FUNCTIES ===

// Logboek functie voor doelen
function showGoalLogbook(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    // Ensure logbookEntries array exists
    if (!goal.logbookEntries) {
        goal.logbookEntries = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">📝 Logboek - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>🎯 ${goal.logbookEntries.length} entries</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>✍️ Nieuwe Logboek Entry</h4>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Wat heb je gedaan voor dit doel?</label>
                    <textarea id="goalLogbookContent" style="width: 100%; height: 80px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Beschrijf wat je vandaag hebt gedaan om dit doel te bereiken..."></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Hoe voel je je over je voortgang?</label>
                    <textarea id="goalLogbookReflection" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat ging goed? Wat was moeilijk? Hoe voel je je?"></textarea>
                </div>
                <button class="btn btn-success" onclick="saveGoalLogbookEntry('${goalId}', this.closest('.modal'))">
                    💾 Entry Opslaan
                </button>
            </div>
            
            <div class="goal-content-section">
                <h4>📚 Eerdere Logboek Entries (${goal.logbookEntries.length})</h4>
                <div class="goal-entries-list">
                    ${goal.logbookEntries.length > 0 ? 
                        goal.logbookEntries.slice().reverse().map(entry => `
                            <div class="goal-entry">
                                <div class="goal-entry-header">
                                    <span class="goal-entry-date">📅 ${new Date(entry.date).toLocaleDateString('nl-NL')} om ${entry.time}</span>
                                    <div class="goal-entry-actions">
                                        <button class="goal-action-btn" onclick="deleteGoalEntry('${goalId}', '${entry.id}', 'logbookEntries', this.closest('.modal'))" title="Verwijderen">🗑️</button>
                                    </div>
                                </div>
                                <div class="goal-entry-content">
                                    <strong>Activiteit:</strong><br>${entry.content}<br><br>
                                    ${entry.reflection ? `<strong>Reflectie:</strong><br>${entry.reflection}` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen logboek entries</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
// Evaluatie functie voor doelen
function showGoalEvaluation(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    // Ensure evaluations array exists
    if (!goal.evaluations) {
        goal.evaluations = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">📊 Evaluatie - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>📊 ${goal.evaluations.length} evaluaties</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>📈 Nieuwe Voortgang Evaluatie</h4>
                
                <div class="evaluation-rating">
                    <label style="font-weight: bold;">Hoe schat je je voortgang in? (1-5 sterren)</label>
                    <div class="rating-stars" id="goalProgressRating">
                        <span class="rating-star" onclick="setGoalRating(1)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(2)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(3)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(4)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(5)">⭐</span>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Voortgang percentage (0-100%)</label>
                    <input type="range" id="goalProgressSlider" class="progress-slider" min="0" max="100" value="50" 
                           onchange="updateProgressDisplay(this.value)">
                    <div class="progress-display" id="progressDisplay">50%</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Wat gaat goed?</label>
                    <textarea id="goalEvalPositive" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat loopt goed met dit doel? Welke vooruitgang zie je?"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Wat kan beter?</label>
                    <textarea id="goalEvalChallenges" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat zijn de uitdagingen? Waar loop je tegenaan?"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Volgende stappen</label>
                    <textarea id="goalEvalNextSteps" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat ga je de komende tijd doen om verder te komen?"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="saveGoalEvaluation('${goalId}', this.closest('.modal'))">
                    📊 Evaluatie Opslaan
                </button>
            </div>
            
            <div class="goal-content-section">
                <h4>📈 Eerdere Evaluaties (${goal.evaluations.length})</h4>
                <div class="goal-entries-list">
                    ${goal.evaluations.length > 0 ? 
                        goal.evaluations.slice().reverse().map(evaluation => `
                            <div class="goal-entry">
                                <div class="goal-entry-header">
                                    <span class="goal-entry-date">📅 ${new Date(evaluation.date).toLocaleDateString('nl-NL')} om ${evaluation.time}</span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: #ffd700;">${'⭐'.repeat(evaluation.rating || 3)}</span>
                                        <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">${evaluation.progress || 0}%</span>
                                        <button class="goal-action-btn" onclick="deleteGoalEntry('${goalId}', '${evaluation.id}', 'evaluations', this.closest('.modal'))" title="Verwijderen">🗑️</button>
                                    </div>
                                </div>
                                <div class="goal-entry-content">
                                    ${evaluation.positive ? `<strong>✅ Gaat goed:</strong><br>${evaluation.positive}<br><br>` : ''}
                                    ${evaluation.challenges ? `<strong>⚠️ Uitdagingen:</strong><br>${evaluation.challenges}<br><br>` : ''}
                                    ${evaluation.nextSteps ? `<strong>🎯 Volgende stappen:</strong><br>${evaluation.nextSteps}` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen evaluaties</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Initialize rating
    setGoalRating(3);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
// Reflectie functie voor doelen
function showGoalReflection(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    // Ensure reflections array exists
    if (!goal.reflections) {
        goal.reflections = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">🤔 Reflectie - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>🤔 ${goal.reflections.length} reflecties</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>💭 Nieuwe Reflectie</h4>
                <p style="color: #667eea; font-style: italic; margin-bottom: 15px;">
                    Neem de tijd om na te denken over je doel en je ervaring ermee.
                </p>
                
                <div class="reflection-questions">
                    <div class="reflection-question">
                        <label>🎯 Waarom is dit doel belangrijk voor jou?</label>
                        <textarea id="goalReflectionWhy" placeholder="Wat motiveert je om dit doel te bereiken? Wat betekent het voor je?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>📈 Wat heb je geleerd tijdens het werken aan dit doel?</label>
                        <textarea id="goalReflectionLearned" placeholder="Welke inzichten heb je gekregen? Wat heb je over jezelf ontdekt?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>💪 Welke sterke punten heb je gebruikt?</label>
                        <textarea id="goalReflectionStrengths" placeholder="Welke talenten, vaardigheden of eigenschappen hebben je geholpen?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>🌟 Wat zou je anders doen als je opnieuw begon?</label>
                        <textarea id="goalReflectionDifferent" placeholder="Welke aanpak zou je kiezen? Wat zou je eerder weten?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>🚀 Hoe ga je deze ervaring gebruiken voor toekomstige doelen?</label>
                        <textarea id="goalReflectionFuture" placeholder="Wat neem je mee? Hoe past dit in je verdere ontwikkeling?"></textarea>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveGoalReflection('${goalId}', this.closest('.modal'))" style="margin-top: 15px;">
                    💭 Reflectie Opslaan
                </button>
            </div>
            
            <div class="goal-content-section">
                <h4>🤔 Eerdere Reflecties (${goal.reflections.length})</h4>
                <div class="goal-entries-list">
                    ${goal.reflections.length > 0 ? 
                        goal.reflections.slice().reverse().map(reflection => `
                            <div class="goal-entry">
                                <div class="goal-entry-header">
                                    <span class="goal-entry-date">📅 ${new Date(reflection.date).toLocaleDateString('nl-NL')} om ${reflection.time}</span>
                                    <div class="goal-entry-actions">
                                        <button class="goal-action-btn" onclick="deleteGoalEntry('${goalId}', '${reflection.id}', 'reflections', this.closest('.modal'))" title="Verwijderen">🗑️</button>
                                    </div>
                                </div>
                                <div class="goal-entry-content">
                                    ${reflection.why ? `<strong>🎯 Waarom belangrijk:</strong><br>${reflection.why}<br><br>` : ''}
                                    ${reflection.learned ? `<strong>📈 Geleerd:</strong><br>${reflection.learned}<br><br>` : ''}
                                    ${reflection.strengths ? `<strong>💪 Sterke punten:</strong><br>${reflection.strengths}<br><br>` : ''}
                                    ${reflection.different ? `<strong>🌟 Anders doen:</strong><br>${reflection.different}<br><br>` : ''}
                                    ${reflection.future ? `<strong>🚀 Voor de toekomst:</strong><br>${reflection.future}` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen reflecties</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
// Helper functies voor de goal portfolio
function saveGoalLogbookEntry(goalId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    const content = document.getElementById('goalLogbookContent').value.trim();
    const reflection = document.getElementById('goalLogbookReflection').value.trim();
    
    if (!content) {
        showNotification('Voer in wat je hebt gedaan!', 'error');
        document.getElementById('goalLogbookContent').focus();
        return;
    }
    
    const now = new Date();
    const entry = {
        id: generateId(),
        content: content,
        reflection: reflection,
        date: now.toISOString(),
        time: now.toTimeString().split(' ')[0].substring(0, 5)
    };
    
    if (!goal.logbookEntries) goal.logbookEntries = [];
    goal.logbookEntries.push(entry);
    
    addToTimeline(`📝 Logboek entry toegevoegd voor doel: ${goal.title}`, currentStudent.id);
	// Refresh de tijdlijn als die open staat
setTimeout(() => {
    const openModal = document.querySelector('.goal-detail-modal');
    if (openModal && openModal.innerHTML.includes('📅 Tijdlijn')) {
        openModal.remove();
        showGoalTimeline(goalId);
    }
}, 100);
    saveData();
    updatePortfolioSummary();
    
    showNotification('Logboek entry opgeslagen!', 'success');
    
    // Refresh modal content
    modal.remove();
    setTimeout(() => showGoalLogbook(goalId), 100);
}

function saveGoalEvaluation(goalId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    const rating = window.currentGoalRating || 3;
    const progress = document.getElementById('goalProgressSlider').value;
    const positive = document.getElementById('goalEvalPositive').value.trim();
    const challenges = document.getElementById('goalEvalChallenges').value.trim();
    const nextSteps = document.getElementById('goalEvalNextSteps').value.trim();
    
    if (!positive && !challenges && !nextSteps) {
        showNotification('Vul minimaal één evaluatie veld in!', 'error');
        return;
    }
    
    const now = new Date();
    const evaluation = {
        id: generateId(),
        rating: rating,
        progress: parseInt(progress),
        positive: positive,
        challenges: challenges,
        nextSteps: nextSteps,
        date: now.toISOString(),
        time: now.toTimeString().split(' ')[0].substring(0, 5)
    };
    
    if (!goal.evaluations) goal.evaluations = [];
    goal.evaluations.push(evaluation);
    
    addToTimeline(`📊 Voortgang geëvalueerd voor doel: ${goal.title} (${progress}%, ${rating}⭐)`, currentStudent.id);
	// Refresh de tijdlijn als die open staat
setTimeout(() => {
    const openModal = document.querySelector('.goal-detail-modal');
    if (openModal && openModal.innerHTML.includes('📅 Tijdlijn')) {
        openModal.remove();
        showGoalTimeline(goalId);
    }
}, 100);
    saveData();
    updatePortfolioSummary();
    
    showNotification('Evaluatie opgeslagen!', 'success');
    
    // Refresh modal content
    modal.remove();
    setTimeout(() => showGoalEvaluation(goalId), 100);
}

function saveGoalReflection(goalId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    const why = document.getElementById('goalReflectionWhy').value.trim();
    const learned = document.getElementById('goalReflectionLearned').value.trim();
    const strengths = document.getElementById('goalReflectionStrengths').value.trim();
    const different = document.getElementById('goalReflectionDifferent').value.trim();
    const future = document.getElementById('goalReflectionFuture').value.trim();
    
    if (!why && !learned && !strengths && !different && !future) {
        showNotification('Vul minimaal één reflectie vraag in!', 'error');
        return;
    }
    
    const now = new Date();
    const reflection = {
        id: generateId(),
        why: why,
        learned: learned,
        strengths: strengths,
        different: different,
        future: future,
        date: now.toISOString(),
        time: now.toTimeString().split(' ')[0].substring(0, 5)
    };
    
    if (!goal.reflections) goal.reflections = [];
    goal.reflections.push(reflection);
    
    addToTimeline(`🤔 Reflectie toegevoegd voor doel: ${goal.title}`, currentStudent.id);
	// Refresh de tijdlijn als die open staat
setTimeout(() => {
    const openModal = document.querySelector('.goal-detail-modal');
    if (openModal && openModal.innerHTML.includes('📅 Tijdlijn')) {
        openModal.remove();
        showGoalTimeline(goalId);
    }
}, 100);
    saveData();
    updatePortfolioSummary();
    
    showNotification('Reflectie opgeslagen!', 'success');
    
    // Refresh modal content
    modal.remove();
    setTimeout(() => showGoalReflection(goalId), 100);
}

function deleteGoalEntry(goalId, entryId, arrayName, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (confirm('Weet je zeker dat je deze entry wilt verwijderen?')) {
        if (goal[arrayName]) {
            goal[arrayName] = goal[arrayName].filter(entry => entry.id !== entryId);
            
            saveData();
            updatePortfolioSummary();
            
            showNotification('Entry verwijderd!', 'success');
            
            // Refresh modal content
            const goalIdForRefresh = goalId;
            modal.remove();
            setTimeout(() => {
                if (arrayName === 'logbookEntries') showGoalLogbook(goalIdForRefresh);
                else if (arrayName === 'evaluations') showGoalEvaluation(goalIdForRefresh);
                else if (arrayName === 'reflections') showGoalReflection(goalIdForRefresh);
            }, 100);
        }
    }
}

function setGoalRating(rating) {
    window.currentGoalRating = rating;
    
    const stars = document.querySelectorAll('#goalProgressRating .rating-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.style.color = '#ffd700';
            star.classList.add('active');
        } else {
            star.style.color = '#ddd';
            star.classList.remove('active');
        }
    });
}

function updateProgressDisplay(value) {
    document.getElementById('progressDisplay').textContent = value + '%';
}


/* === NIEUWE CSS VOOR PERSOONLIJKE DOELEN UITBREIDING === */
/* Voeg toe NA regel 1287 (na bestaande .personal-goal-card styling) */

/* Goal Action Buttons - Uitgebreid */
.goal-main-actions {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s;
}

.goal-extra-actions {
    margin-top: 15px;
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
}

.goal-extra-btn {
    background: rgba(255, 255, 255, 0.3);
    border: none;
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 600;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 5px;
}

.goal-extra-btn:hover {
    background: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.goal-extra-btn.complete-btn {
    background: linear-gradient(135deg, #48bb78, #38a169) !important;
    color: white !important;
    font-weight: bold !important;
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4) !important;
    border: 2px solid rgba(255, 255, 255, 0.3) !important;
}

.goal-extra-btn.complete-btn:hover {
    background: linear-gradient(135deg, #38a169, #2f855a) !important;
    transform: translateY(-3px) !important;
    box-shadow: 0 6px 16px rgba(72, 187, 120, 0.6) !important;
}
.goal-extra-btn.has-content {
    background: rgba(255, 255, 255, 0.6);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
}

/* Goal Detail Modals */
.goal-detail-modal .modal-content {
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
}

.goal-info-header {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.goal-info-title {
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 8px;
}

.goal-info-meta {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    font-size: 0.9rem;
    opacity: 0.9;
}

.goal-content-section {
    background: #f8f9ff;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.goal-entries-list {
    max-height: 300px;
    overflow-y: auto;
}

.goal-entry {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid #667eea;
}

.goal-entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.goal-entry-date {
    font-size: 0.8rem;
    color: #666;
    font-weight: 600;
}

.goal-entry-content {
    line-height: 1.5;
    color: #333;
}

.goal-entry-actions {
    margin-top: 10px;
    display: flex;
    gap: 5px;
}

/* Reflectie specifieke styling */
.reflection-questions {
    display: grid;
    gap: 15px;
}

.reflection-question {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 15px;
}

.reflection-question label {
    display: block;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 8px;
}

.reflection-question textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    resize: vertical;
    font-family: inherit;
}

/* Evaluatie specifieke styling */
.evaluation-rating {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 15px 0;
}

.rating-stars {
    display: flex;
    gap: 5px;
}

.rating-star {
    font-size: 2rem;
    cursor: pointer;
    color: #ddd;
    transition: color 0.2s;
}

.rating-star:hover,
.rating-star.active {
    color: #ffd700;
}

.progress-slider {
    width: 100%;
    margin: 15px 0;
}

.progress-display {
    text-align: center;
    font-size: 1.2rem;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
}
/* Reflection Cards Styles */
.reflection-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.reflection-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}

.reflection-card:hover {
    border-color: #667eea;
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.reflection-card-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 10px;
}

.reflection-card-title {
    font-weight: bold;
    color: #2d3748;
    margin-bottom: 5px;
}

.reflection-card-meta {
    font-size: 0.8rem;
    color: #666;
}

.reflection-card-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(239, 68, 68, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s;
}

.reflection-card:hover .reflection-card-remove {
    opacity: 1;
}

.upload-reflection-area {
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    background: #f8f9ff;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-reflection-area:hover {
    background: #f0f8ff;
    border-color: #5a67d8;
}

.upload-reflection-area.dragover {
    background: #e6f3ff;
    border-color: #4299e1;
    transform: scale(1.02);
}
/* Fix voor reflection tab layout */
#reflection-tab .form-row {
    display: flex;
    gap: 5px;
    align-items: end;
}

#reflection-tab .form-group {
    flex: 1;
	
	/* Verberg reflection content in student mode */
.student-dashboard.active ~ #reflection-tab {
    display: none !important;

}
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <!-- Welcome Screen -->
            <div id="welcomeScreen">
                <div class="login-header">
                    <h1>🎯 Leerling Management</h1>
                    <p>Kies je loginmethode om door te gaan</p>
                </div>
                
                <div class="login-modes">
                    <button class="login-mode-btn" onclick="showStudentLogin()">
                        👤 Leerling Inloggen
                    </button>
                    <button class="login-mode-btn" onclick="showTeacherLogin()">
                        👩‍🏫 Leraar Inloggen
                    </button>
                </div>
            </div>

            <!-- Student Login Form -->
            <div class="login-form" id="studentLoginForm">
                <h2 style="text-align: center; margin-bottom: 2rem;">👤 Leerling Login</h2>
                
                <div id="studentLoginError" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label for="studentSelect">Selecteer je naam:</label>
                    <select id="studentSelect">
                        <option value="">Kies je naam...</option>
                    </select>
                </div>
                
                <div class="form-group" id="pinGroup" style="display: none;">
                    <label for="studentPin">Voer je PIN in:</label>
                    <input type="password" id="studentPin" class="pin-input" maxlength="4" placeholder="••••">
                </div>
                
                <button class="login-btn" id="studentLoginBtn" onclick="loginStudent()" disabled>
                    🔑 Inloggen
                </button>
                
                <button class="back-btn" onclick="showWelcome()">
                    ← Terug
                </button>
            </div>

            <!-- Teacher Login Form -->
            <div class="login-form" id="teacherLoginForm">
                <h2 style="text-align: center; margin-bottom: 2rem;">👩‍🏫 Leraar Login</h2>
                
                <div id="teacherLoginError" class="error-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label for="teacherPassword">Leraar Wachtwoord:</label>
                    <input type="password" id="teacherPassword" placeholder="Voer wachtwoord in">
                </div>
                
                <button class="login-btn" onclick="loginTeacher()">
                    🔑 Inloggen als Leraar
                </button>
                
                <button class="back-btn" onclick="showWelcome()">
                    ← Terug
                </button>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container" id="appContainer">
        <!-- Logout Button -->
        <button class="logout-btn" onclick="logout()">
            🚪 Uitloggen
        </button>

        <!-- Cloud Sync Status -->
        <div class="cloud-status" id="cloudStatus">
            <span id="cloudIcon">☁️</span>
            <span id="cloudText">Initialiseren...</span>
        </div>

        <!-- Mode Toggle (Only for Teachers) -->
        <div class="mode-toggle" id="modeToggle" style="display: none;">
            <button class="mode-btn active" onclick="switchMode('admin')" id="adminModeBtn">
                ⚙️ Admin Modus
            </button>
            <button class="mode-btn" onclick="switchMode('student')" id="studentModeBtn">
                👤 Student Dashboard
            </button>
        </div>

        <!-- Student Dashboard Sidebar -->
        <div class="dashboard-sidebar" id="dashboardSidebar">
            <!-- Student Profile -->
            <div class="student-profile" id="studentProfile">
                <img class="student-avatar" id="studentAvatar" src="" alt="" onclick="currentStudent && uploadStudentCharacter(currentStudent.id)" title="Klik om karakter te wijzigen">
                <div class="student-name" id="studentName">-</div>
                <div class="student-title" id="studentTitle">Leerling</div>
                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.7); margin-top: 0.5rem;">
                    📸 Klik op avatar om karakter te wijzigen
                </div>
            </div>

            <!-- Energy Level -->
            <div class="energy-section" id="energySection">
                <h3>⚡ Energie</h3>
                <div class="energy-display">
                    <div class="energy-level" id="energyLevel" onclick="cycleEnergyLevel()">😐</div>
                    <div id="energyText">Normaal (3)</div>
                </div>
            </div>

            <!-- Task Progress -->
            <div class="tasks-section" id="tasksSection">
                <h3 style="cursor: pointer; transition: all 0.3s ease;" onclick="showTasksView()" onmouseover="this.style.background='rgba(72, 187, 120, 0.3)'" onmouseout="this.style.background=''">📋 MIJN TAKEN</h3>
                <div id="sidebarTasks"></div>
                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="sidebar-view-btn" onclick="showTasksView()" style="background: rgba(72, 187, 120, 0.8); color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                        📋 Alle Taken
                    </button>
                </div>
            </div>

            <!-- Skills Progress -->
            <div class="skills-section" id="skillsSection">
                <h3 style="cursor: pointer; transition: all 0.3s ease;" onclick="showSkillsView()" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background=''">VAARDIGHEDEN</h3>
                
                <div class="skill-item skill-zb">
                    <div class="skill-label">ZB</div>
                    <div class="skill-bar">
                        <div class="skill-fill" id="skill-zb" style="width: 0%"></div>
                    </div>
                    <div class="skill-percentage" id="skill-zb-percent">0%</div>
                </div>

                <div class="skill-item skill-zm">
                    <div class="skill-label">ZM</div>
                    <div class="skill-bar">
                        <div class="skill-fill" id="skill-zm" style="width: 0%"></div>
                    </div>
                    <div class="skill-percentage" id="skill-zm-percent">0%</div>
                </div>

                <div class="skill-item skill-sb">
                    <div class="skill-label">SB</div>
                    <div class="skill-bar">
                        <div class="skill-fill" id="skill-sb" style="width: 0%"></div>
                    </div>
                    <div class="skill-percentage" id="skill-sb-percent">0%</div>
                </div>

                <div class="skill-item skill-rv">
                    <div class="skill-label">RV</div>
                    <div class="skill-bar">
                        <div class="skill-fill" id="skill-rv" style="width: 0%"></div>
                    </div>
                    <div class="skill-percentage" id="skill-rv-percent">0%</div>
                </div>

                <div class="skill-item skill-vb">
                    <div class="skill-label">VB</div>
                    <div class="skill-bar">
                        <div class="skill-fill" id="skill-vb" style="width: 0%"></div>
                    </div>
                    <div class="skill-percentage" id="skill-vb-percent">0%</div>
                </div>

                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="sidebar-view-btn" onclick="showSkillsView()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                        📊 Detailweergave
                    </button>
                </div>
            </div>

            <!-- Tokens in Sidebar -->
            <div class="sidebar-tokens" id="sidebarTokens">
                <h3 style="cursor: pointer; transition: all 0.3s ease;" onclick="showTokensView()" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'" onmouseout="this.style.background=''">🎨 TOKENS</h3>
                <div id="tokenRows"></div>
                <div style="text-align: center; margin-top: 1rem; font-size: 0.9rem;">
                    <span id="tokenCount">0</span> tokens
                </div>
                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="sidebar-view-btn" onclick="showTokensView()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease;">
                        🎨 Token Collectie
                    </button>
                </div>
            </div>

            <!-- Milestones in Sidebar -->
            <div class="milestones-section" id="milestonesSection">
                <h3 style="cursor: pointer; transition: all 0.3s ease;" onclick="showMilestonesView()" onmouseover="this.style.background='rgba(255, 215, 0, 0.3)'" onmouseout="this.style.background=''">🏆 MIJLPALEN</h3>
                <div id="sidebarMilestones"></div>
                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="sidebar-view-btn" onclick="showMilestonesView()" style="background: rgba(255, 215, 0, 0.8); color: #2d3748; border: none; padding: 0.3rem 0.8rem; border-radius: 0.5rem; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; font-weight: bold;">
                        🏆 Alle Mijlpalen
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Student Dashboard Mode -->
            <div class="student-dashboard" id="studentDashboard">
                <div class="dashboard-header">
                    <div class="dashboard-title" id="dashboardTitle">🎯 Student Dashboard</div>
                    <div class="student-selector" id="teacherStudentSelector" style="display: none;">
                        <select class="student-select" id="dashboardStudentSelector">
                            <option value="">Selecteer een leerling...</option>
                        </select>
                    </div>
                </div>

                <div class="dashboard-content">
                    <!-- Sidebar View Panel - Hidden by default -->
                    <div class="dashboard-panel" id="sidebarViewPanel" style="display: none; grid-column: 1 / -1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 id="sidebarViewTitle">📋 Detailweergave</h3>
                            <button class="btn btn-info btn-small" onclick="closeSidebarView()">✖️ Sluiten</button>
                        </div>
                        <div id="sidebarViewContent"></div>
                    </div>
					
					<!-- Portfolio Panel -->
<div class="dashboard-panel" id="portfolioPanel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3>📁 Mijn Portfolio</h3>
        <button class="btn btn-success btn-small" onclick="showFullPortfolio()" title="Bekijk volledig portfolio">
            📊 Volledig Overzicht
        </button>
    </div>
    <div id="portfolioContent">
        <p style="text-align: center; color: #666;">Portfolio wordt geladen...</p>
    </div>
</div>

                    <!-- My Tasks Panel -->
                    <div class="dashboard-panel" id="myTasksPanel">
                        <h3>📋 Mijn Taken</h3>
                        <div id="studentTasks"></div>
                    </div>

                    <!-- Token Collection/Assignment Panel -->
                    <div class="dashboard-panel" id="tokenAssignmentPanel">
                        <h3 id="tokenPanelTitle">🎨 Token Toekenning</h3>
                        <p style="text-align: center; color: #666; margin-bottom: 1.5rem;" id="tokenPanelDescription">
                            Tokens verhogen automatisch vaardigheden en kunnen mijlpalen opleveren!
                        </p>
                        <div class="token-grid" id="dashboardTokenGrid"></div>
                    </div>

                    <!-- Milestones Panel -->
                    <div class="dashboard-panel" id="milestonesPanel">
                        <h3>🏆 Behaalde Mijlpalen</h3>
                        <div id="dashboardMilestones"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Mode Content -->
            <div class="admin-content" id="adminContent">
                <div class="header">
                    <h1>🎯 Geïntegreerd Leerling Management Systeem</h1>
                    <p>Volledig geïntegreerd systeem met taken, vaardigheden, en student dashboards</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div>Leerlingen</div>
                        </div>
						<div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
    <div class="stat-number" id="totalReflectionCards">0</div>
    <div>Reflectiekaartjes</div>
</div>
                        <div class="stat-card tasks">
                            <div class="stat-number" id="totalTasks">0</div>
                            <div>Actieve Taken</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalGroups">0</div>
                            <div>Groepen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTokens">0</div>
                            <div>Uitgegeven Tokens</div>
                        </div>
                        <div class="stat-card compliments">
                            <div class="stat-number" id="totalCompliments">0</div>
                            <div>Feedback Items</div>
                        </div>
                        <div class="stat-card skills">
                            <div class="stat-number" id="totalSkills">0</div>
                            <div>Vaardigheden</div>
                        </div>
                        <div class="stat-card milestones">
                            <div class="stat-number" id="totalMilestones">0</div>
                            <div>Mijlpalen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="avgTokens">0</div>
                            <div>Gem. Tokens</div>
                        </div>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="tab-navigation">
                      <button class="tab-button active" onclick="switchTab('manage')">🛠️ Beheer</button>
                    <button class="tab-button" onclick="switchTab('tasks')">📋 Taken</button>
                    <button class="tab-button" onclick="switchTab('logbook')">📝 Logboek</button>
                    <button class="tab-button" onclick="switchTab('feedback')">💬 Feedback</button>
                    <button class="tab-button" onclick="switchTab('groups')">👥 Groepen</button>
                    <button class="tab-button" onclick="switchTab('milestones')">🏆 Mijlpalen</button>
                    <button class="tab-button" onclick="switchTab('reflection')">🎴 Reflectiekaartjes</button>
                    <button class="tab-button" onclick="switchTab('presentation')">📺 Presentatie</button>
                    <button class="tab-button" onclick="switchTab('timeline')">📅 Tijdlijn</button>
                </div>

                <!-- Tab Contents -->
                <div class="tab-content active" id="manage-tab">
                    <div class="main-content-panel">
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="addStudentForm()">➕ Nieuwe Leerling</button>
                            <button class="btn btn-info" onclick="exportData()">📤 Export Data</button>
                            <button class="btn btn-warning" onclick="importData()">📥 Import Data</button>
                     <button class="btn btn-info" onclick="showDataProtectionTips()">🛡️ Veiligheid Tips</button>
<button class="btn btn-info" onclick="cleanupStorage()">🧹 Veilig Opschonen</button>
<button class="btn btn-warning" onclick="resetStudentProgress()">🔄 Reset Student Voortgang</button>
<button class="btn btn-danger" onclick="resetAllData()">🗑️ Reset Alles</button>
                        </div>

                        <!-- Cloud Sync Management Section -->
                        <div class="cloud-sync-panel">
                            <h3>☁️ Cloud Synchronisatie</h3>
                            <p style="color: #1890ff;">
    ✅ <strong>NIEUWE VEILIGHEIDSMAATREGELEN:</strong> Auto-sync nu elke 30 sec...
</p>
<div style="background: #fff3cd; border: 1px solid #ffeaa7;">
    <strong>⚠️ BELANGRIJKE TIPS:</strong><br>
    • Gebruik "Handmatig Synchroniseren" voor updates<br>
    • "Download van Cloud" ALLEEN als zeker dat anderen gestopt zijn
</div>
                            <div class="sync-controls">
                                <div class="sync-toggle" id="syncToggle" onclick="toggleCloudSync()">
                                    <input type="checkbox" id="cloudSyncCheckbox">
                                    <span>Cloud Sync inschakelen</span>
                                </div>
                                <button class="btn btn-info btn-small" onclick="manualSync()" id="manualSyncBtn" disabled>
                                    🔄 Handmatig Synchroniseren
                                </button>
                                <button class="btn btn-warning btn-small" onclick="downloadFromCloud()" id="downloadBtn" disabled>
                                    📥 Download van Cloud
                                </button>
                                <button class="btn btn-success btn-small" onclick="uploadToCloud()" id="uploadBtn" disabled>
                                    📤 Upload naar Cloud
                                </button>
                            </div>
                            <div id="syncStatus" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;">
                                <div id="syncStatusText"></div>
                            </div>
                        </div>

                        <!-- PIN Management Section -->
                        <div class="pin-management">
                            <h3>🔐 PIN Beheer</h3>
                            <p style="color: #92400e; margin-bottom: 15px;">
                                Beheer de 4-cijferige PINs voor leerling toegang. Deel deze PINs met leerlingen zodat ze kunnen inloggen.
                            </p>
                            <div class="pin-list" id="pinList"></div>
                        </div>

                        <!-- Quick Forms -->
                        <div class="forms-container">
                            <div class="add-student-form">
                                <h3>➕ Nieuwe Leerling</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Naam:</label>
                                        <input type="text" id="newStudentName" placeholder="Jan Jansen">
                                    </div>
                                    <button class="btn btn-success" onclick="addStudent()">Toevoegen</button>
                                </div>
                            </div>

                            <div class="add-compliment-form">
                                <h3>💬 Nieuw Compliment</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Compliment:</label>
                                        <input type="text" id="complimentText" placeholder="Geweldig werk!">
                                    </div>
                                    <button class="btn btn-success" onclick="addCompliment()">Toevoegen</button>
                                </div>
                            </div>
                        </div>

                        <!-- Students List -->
                        <div id="studentsList"></div>
                    </div>
                </div>

                <div class="tab-content" id="tasks-tab">
                    <div class="main-content-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>📋 Taken Beheer</h2>
                                <p>Maak taken aan en wijs ze toe aan leerlingen</p>
                            </div>
                            <button class="btn btn-success" onclick="showTaskForm()">➕ Nieuwe Taak</button>
                        </div>

                        <div id="tasksList"></div>
                    </div>
                </div>

                <div class="tab-content" id="logbook-tab">
                    <div class="main-content-panel">
                        <h2>📝 Logboek Overzicht</h2>
                        <p>Bekijk alle logboek entries van leerlingen</p>
                        <div id="logbookContent"></div>
                    </div>
                </div>

                <div class="tab-content" id="feedback-tab">
                    <div class="main-content-panel">
                        <h2>💬 Feedback Beheer</h2>
                        <p>Geef feedback op uitgevoerde taken</p>
                        <div id="feedbackContent"></div>
                    </div>
                </div>

                <div class="tab-content" id="skills-tab">
                    <div class="main-content-panel">
                        <h2>🎯 Vaardigheden Beheer</h2>
                        <div id="skillsContent">
                            <p>Vaardigheden worden automatisch verhoogd door tokens. Hier kun je handmatig aanpassingen maken.</p>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="groups-tab">
                    <div class="main-content-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>👥 Groepen Beheer</h2>
                                <p>Maak groepen aan en wijs leerlingen toe voor groepswerk</p>
                            </div>
                            <button class="btn btn-success" onclick="showGroupForm()">➕ Nieuwe Groep</button>
                        </div>

                        <div id="groupForm" style="display: none; background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 2px dashed #667eea;">
                            <h3 id="groupFormTitle">Nieuwe Groep</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Groep Naam:</label>
                                    <input type="text" id="groupName" placeholder="Team Rood, Groep A...">
                                </div>
                                <div class="form-group">
                                    <label>Beschrijving:</label>
                                    <input type="text" id="groupDescription" placeholder="Korte beschrijving...">
                                </div>
                                <button class="btn btn-success" onclick="saveGroup()">Opslaan</button>
                                <button class="btn" onclick="cancelGroupForm()" style="background: #666; color: white;">Annuleren</button>
                            </div>
                        </div>

                        <div id="groupsList"></div>
                    </div>
                </div>

                <div class="tab-content" id="milestones-tab">
                    <div class="main-content-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>🏆 Mijlpalen Beheer</h2>
                                <p>Beheer de mijlpalen die leerlingen kunnen behalen</p>
                            </div>
                            <button class="btn btn-success" onclick="addMilestoneForm()">➕ Nieuwe Mijlpaal</button>
                        </div>

                        <div id="milestoneForm" style="display: none; background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 id="milestoneFormTitle">Nieuwe Mijlpaal</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Naam:</label>
                                    <input type="text" id="milestoneName" placeholder="Mijlpaal naam">
                                </div>
                                <div class="form-group">
                                    <label>Vaardigheid:</label>
                                    <select id="milestoneSkill">
                                        <option value="zb">Zelfbewustzijn</option>
                                        <option value="zm">Zelfmanagement</option>
                                        <option value="sb">Sociaal Bewustzijn</option>
                                        <option value="rv">Relatievaardigheden</option>
                                        <option value="vb">Verantwoordelijk Beslissen</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Badge:</label>
                                    <input type="text" id="milestoneBadge" placeholder="🏆" maxlength="2">
                                </div>
                                <button class="btn btn-success" onclick="saveMilestone()">Opslaan</button>
                                <button class="btn" onclick="cancelMilestoneForm()" style="background: #666; color: white;">Annuleren</button>
                            </div>
                        </div>

                        <div id="milestonesList"></div>
                    </div>
                </div>

                <div class="tab-content" id="presentation-tab">
                    <div class="main-content-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>📺 Presentatie Modus</h2>
                                <p>Klik op een leerling om tokens toe te kennen</p>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
    <!-- Weergave Filter -->
<div style="display: flex; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
    <span style="font-weight: 600; color: #2d3748; margin-right: 10px;">Weergave:</span>
    <button class="btn btn-small presentation-view-btn active" onclick="setPresentationView('individual')" style="background: #667eea; color: white;">👤 Individueel</button>
    <button class="btn btn-small presentation-view-btn" onclick="setPresentationView('groups')" style="background: #e2e8f0; color: #2d3748;">👥 Groepen</button>
    <button class="btn btn-small presentation-view-btn" onclick="setPresentationView('mixed')" style="background: #e2e8f0; color: #2d3748;">🔀 Gemengd</button>
</div>
    <!-- Grid Filter -->
    <div style="display: flex; gap: 10px; align-items: center; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <span style="font-weight: 600; color: #2d3748; margin-right: 10px;">Grid:</span>
        <button class="btn btn-small" onclick="setGridSize(1)" style="background: #e2e8f0; color: #2d3748;">1</button>
        <button class="btn btn-small active" onclick="setGridSize(2)" style="background: #667eea; color: white;">2</button>
        <button class="btn btn-small" onclick="setGridSize(3)" style="background: #e2e8f0; color: #2d3748;">3</button>
        <button class="btn btn-small" onclick="setGridSize(4)" style="background: #e2e8f0; color: #2d3748;">4</button>
    </div>
</div>
                        </div>
                        <div id="presentationStudents" class="presentation-students-grid grid-2"></div>
                    </div>
                </div>

                <div class="tab-content" id="timeline-tab">
                    <div class="main-content-panel">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h2>📅 Tijdlijn Overzicht</h2>
                                <p>Bekijk de geschiedenis van taken, tokens, vaardigheden en feedback</p>
                            </div>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <select id="timelineFilter" style="padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1rem;">
                                    <option value="">Alle leerlingen</option>
                                </select>
                                <button class="btn btn-info" onclick="exportTimeline()">📤 Export Tijdlijn</button>
                            </div>
                        </div>
                        <div id="timelineContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
	<div class="tab-content" id="reflection-tab">
    <div class="main-content-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h2>🎴 Reflectiekaartjes Beheer</h2>
                <p>Upload en organiseer reflectiekaartjes per CASEL vaardigheid en subdoel</p>
            </div>
            <button class="btn btn-success" onclick="showReflectionCardForm()">➕ Nieuwe Kaartjes Uploaden</button>
        </div>

        <!-- Vaardigheid selectie -->
        <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <div class="form-row">
                <div class="form-group">
                    <label>Selecteer Vaardigheid:</label>
                    <select id="reflectionSkillSelect" onchange="updateReflectionSubgoals()">
                        <option value="">Kies een vaardigheid...</option>
                        <option value="zb">Zelfbewustzijn</option>
                        <option value="zm">Zelfmanagement</option>
                        <option value="sb">Sociaal Bewustzijn</option>
                        <option value="rv">Relatievaardigheden</option>
                        <option value="vb">Verantwoordelijk Beslissen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Selecteer Subdoel:</label>
                    <select id="reflectionSubgoalSelect" onchange="loadReflectionCards()">
                        <option value="">Eerst vaardigheid kiezen...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Kaartjes grid -->
        <div id="reflectionCardsContainer">
            <p style="text-align: center; color: #666; padding: 2rem;">Selecteer een vaardigheid en subdoel om kaartjes te bekijken</p>
        </div>
    </div>
</div>

    <!-- Task Form Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h3 id="taskModalTitle">Nieuwe Taak</h3>
            <div class="form-group">
                <label>Titel:</label>
                <input type="text" id="taskTitle" placeholder="Taak titel">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Vak:</label>
                    <select id="taskSubject">
                        <option value="Wiskunde">Wiskunde</option>
                        <option value="Nederlands">Nederlands</option>
                        <option value="Engels">Engels</option>
                        <option value="Geschiedenis">Geschiedenis</option>
                        <option value="Aardrijkskunde">Aardrijkskunde</option>
                        <option value="Biologie">Biologie</option>
                        <option value="Natuurkunde">Natuurkunde</option>
                        <option value="Scheikunde">Scheikunde</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type:</label>
                    <select id="taskType">
                        <option value="daily">Dag taak</option>
                        <option value="weekly">Week taak</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Doel:</label>
                <input type="text" id="taskGoal" placeholder="Leerdoel van deze taak">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Pagina's:</label>
                    <input type="text" id="taskPages" placeholder="bijv. 45-48">
                </div>
                <div class="form-group">
                    <label>Tijd:</label>
                    <input type="time" id="taskTime">
                </div>
                <div class="form-group">
                    <label>Datum:</label>
                    <input type="date" id="taskDate">
                </div>
            </div>
            <div class="form-group">
                <label>Toegewezen aan:</label>
                <div id="taskStudentAssignment" style="max-height: 150px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px;"></div>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveTask()">Opslaan</button>
                <button class="btn" onclick="closeTaskModal()" style="background: #666; color: white;">Annuleren</button>
            </div>
        </div>
    </div>
	
	<!-- Student Task Form Modal -->
<div class="modal" id="studentTaskModal">
    <div class="modal-content">
        <h3 id="studentTaskModalTitle">📋 Mijn Taak Inplannen</h3>
        <p style="color: #667eea; text-align: center; margin-bottom: 20px;">
            Plan je eigen studie-activiteit en verdien vaardigheidspunten!
        </p>
        
        <div class="form-group">
            <label>Wat ga je doen? <span style="color: red;">*</span></label>
            <input type="text" id="studentTaskTitle" placeholder="Bijvoorbeeld: Wiskunde hoofdstuk 5 herhalen">
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Vak:</label>
                <select id="studentTaskSubject">
                    <option value="Wiskunde">Wiskunde</option>
                    <option value="Nederlands">Nederlands</option>
                    <option value="Engels">Engels</option>
                    <option value="Geschiedenis">Geschiedenis</option>
                    <option value="Aardrijkskunde">Aardrijkskunde</option>
                    <option value="Biologie">Biologie</option>
                    <option value="Natuurkunde">Natuurkunde</option>
                    <option value="Scheikunde">Scheikunde</option>
                    <option value="Studie">Algemene Studie</option>
                    <option value="Huiswerk">Huiswerk</option>
                </select>
            </div>
            <div class="form-group">
                <label>Wanneer:</label>
                <input type="date" id="studentTaskDate">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Hoeveel tijd:</label>
                <select id="studentTaskDuration">
                    <option value="15">15 minuten</option>
                    <option value="30" selected>30 minuten</option>
                    <option value="45">45 minuten</option>
                    <option value="60">1 uur</option>
                    <option value="90">1,5 uur</option>
                    <option value="120">2 uur</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tijd van dag:</label>
                <input type="time" id="studentTaskTime">
            </div>
        </div>
        
        <div class="form-group">
            <label>Mijn leerdoel (optioneel):</label>
            <textarea id="studentTaskGoal" rows="2" placeholder="Wat wil je bereiken met deze studie-activiteit?"></textarea>
        </div>
        
        <div class="form-group">
            <label>Pagina's/Materiaal (optioneel):</label>
            <input type="text" id="studentTaskPages" placeholder="Bijvoorbeeld: Pagina 45-50, hoofdstuk 3">
        </div>
        
        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea;">
            <strong>💡 Beloning:</strong> Voor het aanmaken van eigen taken krijg je vaardigheidspunten en mogelijk een token!
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button class="btn btn-success" onclick="saveStudentTask()">📅 Taak Inplannen</button>
            <button class="btn" onclick="closeStudentTaskModal()" style="background: #666; color: white;">Annuleren</button>
        </div>
    </div>
</div>

    <!-- Logbook Modal -->
    <div class="modal" id="logbookModal">
        <div class="modal-content">
            <h3>📝 Logboek Entry</h3>
            <div id="logbookTaskInfo" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            <div class="form-group">
                <label>Wat heb je gedaan? Wat heb je geleerd? <span style="color: red;">*</span></label>
                <textarea id="logbookContentInput" rows="4" placeholder="Beschrijf wat je hebt gedaan tijdens deze taak..." required></textarea>
            </div>
            <div class="form-group">
                <label>Reflectie (optioneel):</label>
                <textarea id="logbookReflection" rows="3" placeholder="Wat ging goed? Wat was moeilijk? Wat wil je volgende keer anders doen?"></textarea>
            </div>
            <div class="form-group">
                <label>Persoonlijk Leerdoel (optioneel):</label>
                <textarea id="logbookPersonalGoal" rows="2" placeholder="Wat wil jij specifiek leren of bereiken met deze taak?"></textarea>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveLogbookEntry()">Opslaan</button>
                <button class="btn" onclick="closeLogbookModal()" style="background: #666; color: white;">Annuleren</button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal" id="feedbackModal">
        <div class="modal-content">
            <h3>💬 Feedback Geven</h3>
            <div id="feedbackTaskInfo" style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;"></div>
            <div class="form-group">
                <label>Beoordeling (1-5 sterren):</label>
                <div id="ratingSelector" style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
                    <button onclick="setRating(1)" style="font-size: 2rem; background: none; border: none; cursor: pointer;">⭐</button>
                    <button onclick="setRating(2)" style="font-size: 2rem; background: none; border: none; cursor: pointer;">⭐</button>
                    <button onclick="setRating(3)" style="font-size: 2rem; background: none; border: none; cursor: pointer;">⭐</button>
                    <button onclick="setRating(4)" style="font-size: 2rem; background: none; border: none; cursor: pointer;">⭐</button>
                    <button onclick="setRating(5)" style="font-size: 2rem; background: none; border: none; cursor: pointer;">⭐</button>
                </div>
                <div id="ratingDisplay" style="text-align: center; font-weight: bold; margin-bottom: 15px;">3/5 sterren</div>
            </div>
            <div class="form-group">
                <label>Feedback tekst:</label>
                <textarea id="feedbackText" rows="4" placeholder="Geef constructieve feedback op de uitgevoerde taak..."></textarea>
            </div>
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-success" onclick="saveFeedback()">Feedback Opslaan</button>
                <button class="btn" onclick="closeFeedbackModal()" style="background: #666; color: white;">Annuleren</button>
            </div>
        </div>
    </div>
	<!-- Personal Goal Modal -->
<div class="modal" id="personalGoalModal">
    <div class="modal-content">
        <h3 id="goalModalTitle">🎯 Nieuw Persoonlijk Doel</h3>
        <div class="form-group">
            <label>Doel Titel: <span style="color: red;">*</span></label>
            <input type="text" id="goalTitle" placeholder="Wat wil je bereiken?" maxlength="100">
        </div>
        <div class="form-group">
            <label>Beschrijving:</label>
            <textarea id="goalDescription" rows="3" placeholder="Beschrijf je doel en waarom het belangrijk voor je is..." maxlength="500"></textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Categorie:</label>
                <select id="goalCategory">
                    <option value="academic">📚 Academisch</option>
                    <option value="skill">🎯 Vaardigheid</option>
                    <option value="personal">💡 Persoonlijk</option>
                    <option value="social">🤝 Sociaal</option>
                    <option value="creative">🎨 Creatief</option>
                    <option value="other">📌 Anders</option>
                </select>
            </div>
            <div class="form-group">
                <label>Deadline:</label>
                <input type="date" id="goalDeadline">
            </div>
        </div>
        <div class="form-group">
            <label>Prioriteit:</label>
            <div style="display: flex; gap: 15px; justify-content: center; margin: 10px 0;">
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="goalPriority" value="low" checked>
                    <span style="color: #48bb78;">🟢 Laag</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="goalPriority" value="medium">
                    <span style="color: #ed8936;">🟡 Gemiddeld</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                    <input type="radio" name="goalPriority" value="high">
                    <span style="color: #f56565;">🔴 Hoog</span>
                </label>
            </div>
        </div>
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button class="btn btn-success" onclick="savePersonalGoal()">🎯 Doel Opslaan</button>
            <button class="btn" onclick="closePersonalGoalModal()" style="background: #666; color: white;">Annuleren</button>
        </div>
    </div>
</div>
<!-- Reflection Cards Upload Modal -->
<div class="modal" id="reflectionCardModal">
    <div class="modal-content" style="max-width: 700px;">
        <h3 id="reflectionModalTitle">🎴 Reflectiekaartjes Uploaden</h3>
        
        <div class="form-group">
            <label>Selecteer Vaardigheid:</label>
            <select id="uploadSkillSelect" onchange="updateUploadSubgoals()">
                <option value="">Kies een vaardigheid...</option>
                <option value="zb">Zelfbewustzijn</option>
                <option value="zm">Zelfmanagement</option>
                <option value="sb">Sociaal Bewustzijn</option>
                <option value="rv">Relatievaardigheden</option>
                <option value="vb">Verantwoordelijk Beslissen</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Selecteer Subdoel:</label>
            <select id="uploadSubgoalSelect">
                <option value="">Eerst vaardigheid kiezen...</option>
            </select>
        </div>
        
        <div class="upload-reflection-area" onclick="document.getElementById('reflectionFiles').click()" 
             ondrop="handleReflectionDrop(event)" ondragover="handleReflectionDragOver(event)" 
             ondragleave="handleReflectionDragLeave(event)">
            <h3>📁 Kaartjes Uploaden</h3>
            <p>Klik hier of sleep afbeeldingen naar dit gebied</p>
            <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                Ondersteunde formaten: JPG, PNG, GIF | Maximaal 10 kaartjes per keer
            </p>
            <input type="file" id="reflectionFiles" style="display: none;" multiple accept="image/*" 
                   onchange="handleReflectionFiles(this.files)">
        </div>
        
        <div id="uploadPreview" style="display: none;">
            <h4>Te uploaden kaartjes:</h4>
            <div id="previewGrid" class="reflection-cards-grid" style="max-height: 300px; overflow-y: auto;">
                <!-- Preview images will be shown here -->
            </div>
        </div>
        
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
            <button class="btn btn-success" onclick="saveReflectionCards()" id="saveReflectionBtn" disabled>
                💾 Kaartjes Opslaan
            </button>
            <button class="btn" onclick="closeReflectionCardModal()" style="background: #666; color: white;">
                ❌ Annuleren
            </button>
        </div>
    </div>
</div>

 <!-- Scripts in de juiste volgorde laden -->
    <script src="js/data/storage.js"></script>
    <script src="js/data/sync.js"></script>
    <!-- Voeg andere modules toe als je ze maakt -->
    
    <!-- Hoofdscript als laatste -->
    <script src="js/main.js"></script>

    <script>
	// Debug functie - voeg toe na je andere functies
function forceUpdateStudentLogin() {
    console.log('🔧 Force updating student login with', students.length, 'students');
    console.log('📋 Available students:', students.map(s => s.name));
    
    const selector = document.getElementById('studentSelect');
    if (selector) {
        selector.innerHTML = '<option value="">Kies je naam...</option>';
        
        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = student.name;
            selector.appendChild(option);
        });
        
        console.log('✅ Student selector updated with', selector.children.length - 1, 'students');
    } else {
        console.log('❌ Student selector element not found');
    }
}
        // Supabase Configuration
        const SUPABASE_URL = 'https://vsynvrkgcycvoaonnwmj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzeW52cmtnY3ljdm9hb25ud21qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MTUwNDgsImV4cCI6MjA2NDE5MTA0OH0.xaz2weA-4JDnnhuPcemvBzfuSbYBMZfAxgKlRNPbvsk';

        // Initialize Supabase client
        let supabase = null;
        let cloudSyncEnabled = false;
        let cloudSyncStatus = 'offline';

        // Global Authentication Variables
        let currentUser = null;
        let userRole = null; // 'student' or 'teacher'
        let teacherPassword = 'leraar123'; // Default teacher password
		
		  console.log('1. Variables loaded');

        // Global state
        let currentMode = 'admin';
        let students = [];
        let tasks = [];
        let subjects = ['Wiskunde', 'Nederlands', 'Engels', 'Geschiedenis', 'Aardrijkskunde', 'Biologie', 'Natuurkunde', 'Scheikunde'];
        let logbookEntries = [];
        let feedbackEntries = [];
        let personalGoals = [];
        let milestones = [];
        let customTokens = [];
        let timeline = [];
        let currentStudent = null;
        let editingMilestoneId = null;
        let currentGridSize = 2;
        let currentSelectedStudent = null;
		let currentPresentationView = 'individual'; // Nieuwe variabele
        let groups = [];
		let reflectionCards = {}; // Structuur: { 'zb-gevoelens': [{id, title, image, description}] }
        let reflectionAnswers = {}; // Structuur: { 'studentId-cardId': { who: '', what: '', when: '', where: '', why: '', how: '' } }
        let editingTaskId = null;
        let currentLogbookTask = null;
        let currentFeedbackTask = null;
        let currentRating = 3;
console.log('2. Before functions');
        // Token types with skill progression and task bonuses
        const tokenTypes = [
            { 
                id: 'star', 
                name: 'Ster', 
                emoji: '⭐', 
                color: '#ffd700', 
                skills: { zb: 8, zm: 2 },
                description: 'Verhoogt Zelfbewustzijn (+8) en Zelfmanagement (+2)'
            },
            { 
                id: 'heart', 
                name: 'Hart', 
                emoji: '❤️', 
                color: '#ff6b6b', 
                skills: { sb: 10 },
                description: 'Verhoogt Sociaal Bewustzijn (+10)'
            },
            { 
                id: 'trophy', 
                name: 'Trofee', 
                emoji: '🏆', 
                color: '#ffd700', 
                skills: { vb: 8, zb: 2 },
                description: 'Verhoogt Verantwoordelijk Beslissen (+8) en Zelfbewustzijn (+2)'
            },
            { 
                id: 'thumbsup', 
                name: 'Duim Omhoog', 
                emoji: '👍', 
                color: '#4ecdc4', 
                skills: { rv: 10 },
                description: 'Verhoogt Relatievaardigheden (+10)'
            },
            { 
                id: 'smile', 
                name: 'Lach', 
                emoji: '😊', 
                color: '#ffe66d', 
                skills: { zm: 8, sb: 2 },
                description: 'Verhoogt Zelfmanagement (+8) en Sociaal Bewustzijn (+2)'
            },
            { 
                id: 'rocket', 
                name: 'Raket', 
                emoji: '🚀', 
                color: '#ff6b6b', 
                skills: { zb: 6, zm: 4 },
                description: 'Verhoogt Zelfbewustzijn (+6) en Zelfmanagement (+4)'
            }
        ];

        // Task-to-skill mapping for automatic progression
    
const taskSkillMapping = {
    'Wiskunde': { zm: 8, vb: 2 },        // Zelfmanagement + Beslissen
    'Nederlands': { zb: 6, rv: 4 },      // Zelfbewustzijn + Relaties
    'Engels': { zb: 5, rv: 5 },          // Zelfbewustzijn + Relaties
    'Geschiedenis': { vb: 8, zb: 2 },    // Beslissen + Zelfbewustzijn
    'Aardrijkskunde': { vb: 6, sb: 4 },  // Beslissen + Sociaal Bewustzijn
    'Biologie': { zm: 6, vb: 4 },        // Zelfmanagement + Beslissen
    'Natuurkunde': { zm: 8, vb: 2 },     // Zelfmanagement + Beslissen
    'Scheikunde': { zm: 8, vb: 2 },      // Zelfmanagement + Beslissen
    'Groepswerk': { rv: 10, sb: 5 },     // Relaties + Sociaal Bewustzijn
    'Presentatie': { zb: 8, rv: 2 },     // Zelfbewustzijn + Relaties
    'Studie': { zm: 6, zb: 4 },          // Algemene studie-vaardigheden
    'Huiswerk': { zm: 5, vb: 3, zb: 2 }  // Mixed skills voor huiswerk
};

        // Skill definitions
        const skillDefinitions = {
            zb: { name: 'Zelfbewustzijn', code: 'zb' },
            zm: { name: 'Zelfmanagement', code: 'zm' },
            sb: { name: 'Sociaal Bewustzijn', code: 'sb' },
            rv: { name: 'Relatievaardigheden', code: 'rv' },
            vb: { name: 'Verantwoordelijk Beslissen', code: 'vb' }
        };
// Subdoelen per vaardigheid voor reflectiekaartjes
const skillSubgoals = {
    zb: ['Gevoelens herkennen', 'Emoties benoemen', 'Zelfbeeld', 'Sterke punten', 'Persoonlijke waarden'],
    zm: ['Impulsen beheersen', 'Doelen stellen', 'Stress management', 'Zelfmotivatie', 'Discipline'],
    sb: ['Empathie', 'Perspectief nemen', 'Diversiteit waarderen', 'Sociale signalen', 'Context begrijpen'],
    rv: ['Communicatie', 'Samenwerking', 'Conflictoplossing', 'Hulp zoeken', 'Leiderschap'],
    vb: ['Ethische keuzes', 'Gevolgen inschatten', 'Veiligheid', 'Constructieve keuzes', 'Verantwoordelijkheid']
};

        
async function initSupabase() {
    try {
        // Check of Supabase CDN geladen is
        if (typeof window.supabase === 'undefined') {
            throw new Error('Supabase CDN niet geladen');
        }
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Supabase client initialized');
        
        // Verificeer database schema
        const schemaValid = await verifyDatabaseSchema();
        if (!schemaValid) {
            console.warn('⚠️ Database schema niet compleet');
            updateCloudStatus('offline', 'Database tabel niet gevonden');
            return false;
        }
        
        // Test connectie
        const { data, error } = await supabase
            .from('learning_system_data')
            .select('id')
            .limit(1);
            
        if (error) {
            console.error('❌ Supabase connection test failed:', error);
            updateCloudStatus('offline', 'Connectie test mislukt');
            return false;
        }
        
        console.log('✅ Supabase connection verified');
        updateCloudStatus('online', 'Cloud verbinding succesvol');
        
        // Check if cloud sync was previously enabled
        const previouslyEnabled = localStorage.getItem('cloudSyncEnabled') === 'true';
        if (previouslyEnabled) {
            cloudSyncEnabled = true;
            document.getElementById('cloudSyncCheckbox').checked = true;
            document.getElementById('syncToggle').classList.add('enabled');
            document.getElementById('manualSyncBtn').disabled = false;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('uploadBtn').disabled = false;
        }
        
        return true;
    } catch (error) {
        console.error('❌ Failed to initialize Supabase:', error);
        updateCloudStatus('offline', 'Cloud niet beschikbaar: ' + error.message);
        return false;
    }
}
async function verifyDatabaseSchema() {
    try {
        // Test of de tabel bestaat
        const { data, error } = await supabase
            .from('learning_system_data')
            .select('id')
            .limit(1);
            
        if (error && error.code === '42P01') {
            console.warn('⚠️ Tabel learning_system_data bestaat niet');
            return false;
        }
        return true;
    } catch (error) {
        console.error('❌ Database schema verification failed:', error);
        return false;
    }
}

        async function enableCloudSync() {
            try {
                cloudSyncEnabled = true;
                localStorage.setItem('cloudSyncEnabled', 'true');
                
                // Update UI
                document.getElementById('cloudSyncCheckbox').checked = true;
                document.getElementById('syncToggle').classList.add('enabled');
                document.getElementById('manualSyncBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('uploadBtn').disabled = false;
                
                updateCloudStatus('online', 'Cloud sync actief');
                
                // Perform initial sync
                await downloadFromCloud();
                
                console.log('✅ Cloud sync enabled');
                showNotification('Cloud synchronisatie ingeschakeld!', 'success');
                
                return true;
            } catch (error) {
                console.error('❌ Failed to enable cloud sync:', error);
                updateCloudStatus('offline', 'Fout bij inschakelen');
                showNotification('Fout bij inschakelen cloud sync: ' + error.message, 'error');
                return false;
            }
        }

        async function disableCloudSync() {
            cloudSyncEnabled = false;
            localStorage.setItem('cloudSyncEnabled', 'false');
            
            // Update UI
            document.getElementById('cloudSyncCheckbox').checked = false;
            document.getElementById('syncToggle').classList.remove('enabled');
            document.getElementById('manualSyncBtn').disabled = true;
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('uploadBtn').disabled = true;
            
            updateCloudStatus('offline', 'Cloud sync uitgeschakeld');
            
            console.log('🔄 Cloud sync disabled');
            showNotification('Cloud synchronisatie uitgeschakeld', 'warning');
        }

        async function toggleCloudSync() {
            if (!cloudSyncEnabled) {
                await enableCloudSync();
            } else {
                await disableCloudSync();
            }
        }

       async function uploadToCloud() {
    if (!supabase || !cloudSyncEnabled) {
        showNotification('Cloud sync niet beschikbaar!', 'error');
        return false;
    }

    try {
        updateCloudStatus('syncing', 'Uploaden naar cloud...');
        
        // Test connectiviteit eerst
        if (!navigator.onLine) {
            throw new Error('Geen internetverbinding');
        }
        
        //  // Verzamel ALLE data die gesynchroniseerd moet worden
        const data = {
		
		
		
		
		
		
		
		
		
		
		
		
            students,
            tasks,
            subjects,
            logbookEntries,
            feedbackEntries,
            personalGoals,
            milestones,
            customTokens,
            timeline: timeline.slice(0, 50),
            groups,
            reflectionCards,
            reflectionAnswers,
            settings: {
                currentGridSize,
                teacherPassword,
                currentPresentationView
   },
		  

														
																	
																			
		 

						   
						  
            metadata: {
                version: '4.0',
                lastSaved: new Date().toISOString(),
												   
                dataSize: JSON.stringify({
                    students: students.length,
                    tasks: tasks.length,
                    logbookEntries: logbookEntries.length,
                    feedbackEntries: feedbackEntries.length,
                    timeline: timeline.length
                })
            }
        };

        console.log('📤 Uploading data:', {
            students: students.length,
            tasks: tasks.length,
            groups: groups.length,
            timeline: timeline.length
        });

        const { error } = await supabase
            .from('learning_system_data')
            .upsert([{ 
                id: 1, 
                data: data, 
                updated_at: new Date().toISOString(),
                data_version: '4.0',
                client_info: {
                    userAgent: navigator.userAgent,
                    timestamp: new Date().toISOString()
														   
                }
            }]);

        if (error) throw error;

											  
									  
								
									  
									  

        updateCloudStatus('online', 'Geüpload naar cloud');
        showNotification('Gegevens succesvol geüpload naar cloud!', 'success');
        console.log('✅ Data successfully uploaded to cloud');
        return true;


    } catch (error) {
        console.error('❌ Upload failed:', error);
        updateCloudStatus('offline', 'Upload mislukt: ' + error.message);
        
        // Specifieke error messages
        if (error.message.includes('Failed to fetch')) {
            showNotification('Netwerkfout: Controleer je internetverbinding', 'error');
        } else if (error.code === '401') {
            showNotification('Authenticatiefout: Ongeldige API sleutel', 'error');
        } else if (error.code === '42P01') {
            showNotification('Database tabel niet gevonden. Maak eerst de tabel aan.', 'error');
        } else {
            showNotification('Fout bij uploaden: ' + error.message, 'error');
        }
        return false;
    }
}

      async function downloadFromCloud() {
    if (!supabase || !cloudSyncEnabled) {
        showNotification('Cloud sync niet beschikbaar!', 'error');
        return false;
    }

    try {
        updateCloudStatus('syncing', 'Downloaden van cloud...');

        const { data, error } = await supabase
            .from('learning_system_data')
            .select('*')
            .eq('id', 1)
            .single();

        if (error) {
            if (error.code === 'PGRST116') {
                console.log('📋 No cloud data found, uploading current data...');
                await uploadToCloud();
                return true;
            }
            throw error;
        }

        if (data && data.data) {
            const cloudData = data.data;
            
            console.log('📥 Downloading data:', {
                students: cloudData.students?.length || 0,
                tasks: cloudData.tasks?.length || 0,
                groups: cloudData.groups?.length || 0
            });
            
            // Merge cloud data met lokale data
            if (cloudData.students) students = cloudData.students;
            if (cloudData.tasks) tasks = cloudData.tasks;
            if (cloudData.subjects) subjects = cloudData.subjects;
            if (cloudData.logbookEntries) logbookEntries = cloudData.logbookEntries;
            if (cloudData.feedbackEntries) feedbackEntries = cloudData.feedbackEntries;
            if (cloudData.personalGoals) personalGoals = cloudData.personalGoals;
            if (cloudData.milestones) milestones = cloudData.milestones;
            if (cloudData.customTokens) customTokens = cloudData.customTokens;
            if (cloudData.timeline) timeline = cloudData.timeline;
            if (cloudData.groups) groups = cloudData.groups;
            if (cloudData.reflectionCards) reflectionCards = cloudData.reflectionCards;
            if (cloudData.reflectionAnswers) reflectionAnswers = cloudData.reflectionAnswers;
            if (cloudData.settings) {
                currentGridSize = cloudData.settings.currentGridSize || 2;
                teacherPassword = cloudData.settings.teacherPassword || 'leraar123';
                currentPresentationView = cloudData.settings.currentPresentationView || 'individual';
            }

            // Save to localStorage as backup
            saveData();
            
            // ✅ BELANGRIJKE FIX: Refresh ALL UI components
            console.log('🔄 Refreshing UI with cloud data...');
            updateStatistics();
            renderStudentsList();
            renderTasksList();
            renderMilestonesList();
            updateDashboardStudentSelector();
            renderGroupsList();
            renderPinList();
            
            // ✅ EXTRA BELANGRIJK: Update student login selector
            updateStudentSelector();
            
            // ✅ FORCE UPDATE NA CLOUD SYNC - NIEUWE TOEVOEGING
            setTimeout(() => {
                forceUpdateStudentLogin();
                console.log('✅ Student selector geforceerd bijgewerkt:', students.length, 'studenten');
            }, 200);
            
            updateCloudStatus('online', 'Gedownload van cloud');
            showNotification('Gegevens succesvol gedownload van cloud!', 'success');
            console.log('✅ Data downloaded from cloud');
            console.log('📊 UI updated - Students available:', students.length);
            console.log('📋 Student names:', students.map(s => s.name));
            return true;
        }

    } catch (error) {
        console.error('❌ Download failed:', error);
        updateCloudStatus('offline', 'Download mislukt');
        showNotification('Fout bij downloaden: ' + error.message, 'error');
        return false;
    }
}

        function updateCloudStatus(status, message) {
            cloudSyncStatus = status;
            const statusElement = document.getElementById('cloudStatus');
            const iconElement = document.getElementById('cloudIcon');
            const textElement = document.getElementById('cloudText');
            
            // Update status display
            statusElement.className = `cloud-status ${status}`;
            
            switch (status) {
                case 'online':
                    iconElement.textContent = '☁️';
                    break;
                case 'offline':
                    iconElement.textContent = '⚫';
                    break;
                case 'syncing':
                    iconElement.textContent = '🔄';
                    break;
                default:
                    iconElement.textContent = '☁️';
            }
            
            textElement.textContent = message;
            
            // Update sync status panel if visible
            const syncStatus = document.getElementById('syncStatus');
            const syncStatusText = document.getElementById('syncStatusText');
            if (syncStatus && syncStatusText) {
                syncStatus.style.display = 'block';
                syncStatus.style.background = status === 'online' ? '#f6ffed' : 
                                             status === 'syncing' ? '#fff7e6' : '#fff2f0';
                syncStatus.style.borderColor = status === 'online' ? '#52c41a' : 
                                               status === 'syncing' ? '#fa8c16' : '#ff4d4f';
                syncStatusText.textContent = message;
                syncStatusText.style.color = status === 'online' ? '#52c41a' : 
                                             status === 'syncing' ? '#fa8c16' : '#ff4d4f';
            }
        }

        // Auto-sync when data changes (if cloud sync is enabled)
       // ✅ VERBETERDE AUTO-SYNC met conflict preventie
async function autoSync() {
    // ALLEEN LERAREN EN ALLEEN ALS ER GEEN HANDMATIGE SYNC BEZIG IS
    if (cloudSyncEnabled && cloudSyncStatus === 'online' && userRole === 'teacher' && !window.manualSyncInProgress) {
        // Debounced auto-sync to avoid too frequent uploads
        clearTimeout(window.autoSyncTimeout);
        window.autoSyncTimeout = setTimeout(async () => {
            try {
                console.log('🔄 Auto-sync triggered');
                await uploadToCloud();
            } catch (error) {
                console.error('❌ Auto-sync failed:', error);
                // Geen notification voor auto-sync fails (stil falen)
            }
        }, 2000); // ✅ VERHOOGD: Wait 10 seconds after last change (was 2 sec)
    }
}

// ✅ NIEUWE HANDMATIGE SYNC FUNCTIE
async function manualSync() {
    if (!cloudSyncEnabled) {
        showNotification('Cloud sync is uitgeschakeld!', 'error');
        return;
    }

    if (window.manualSyncInProgress) {
        showNotification('Sync al bezig...', 'warning');
        return;
    }

    try {
        window.manualSyncInProgress = true;
        
        // Stop auto-sync tijdelijk
        clearTimeout(window.autoSyncTimeout);
        
        updateCloudStatus('syncing', 'Handmatige sync bezig...');
        
        // Download eerst om laatste wijzigingen op te halen
        console.log('📥 Manual sync: downloading latest data first...');
        await downloadFromCloud();
        
        // Dan upload met merge
        console.log('📤 Manual sync: uploading merged data...');
        await uploadToCloud();
        
        showNotification('✅ Handmatige sync voltooid!', 'success');
        
    } catch (error) {
        console.error('❌ Manual sync failed:', error);
        updateCloudStatus('offline', 'Handmatige sync mislukt');
        showNotification('Handmatige sync mislukt: ' + error.message, 'error');
    } finally {
        window.manualSyncInProgress = false;
    }
}

        // Authentication Functions
        function showWelcome() {
            document.getElementById('welcomeScreen').style.display = 'block';
            document.getElementById('studentLoginForm').classList.remove('active');
            document.getElementById('teacherLoginForm').classList.remove('active');
            clearLoginErrors();
        }

        function showStudentLogin() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('studentLoginForm').classList.add('active');
    updateStudentSelector();
	
	
	
	
	
	
	
	
	
    clearLoginErrors();
}

        function showTeacherLogin() {
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('teacherLoginForm').classList.add('active');
            clearLoginErrors();
        }

        function updateStudentSelector() {
            const selector = document.getElementById('studentSelect');
            selector.innerHTML = '<option value="">Kies je naam...</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                selector.appendChild(option);
            });

            selector.addEventListener('change', function() {
                const pinGroup = document.getElementById('pinGroup');
                const loginBtn = document.getElementById('studentLoginBtn');
                
                if (this.value) {
                    pinGroup.style.display = 'block';
                    document.getElementById('studentPin').focus();
                    updateLoginButton();
                } else {
                    pinGroup.style.display = 'none';
                    loginBtn.disabled = true;
                }
								  
										  
									 
	  
            });

            document.getElementById('studentPin').addEventListener('input', updateLoginButton);
            document.getElementById('studentPin').addEventListener('keypress', function(e) {
   
   
						  
													 
															 
																	
		
						 
											 
                if (e.key === 'Enter' && !document.getElementById('studentLoginBtn').disabled) {
                    loginStudent();
                }
            });
									 
        }
		
		
		
		
		
		
		
		
		
		
		

        function updateLoginButton() {
            const studentId = document.getElementById('studentSelect').value;
            const pin = document.getElementById('studentPin').value;
            const loginBtn = document.getElementById('studentLoginBtn');
            
            loginBtn.disabled = !studentId || pin.length !== 4;
        }

        function loginStudent() {
            const studentId = document.getElementById('studentSelect').value;
            const pin = document.getElementById('studentPin').value;
            
            if (!studentId || pin.length !== 4) {
                showLoginError('studentLoginError', 'Selecteer je naam en voer je 4-cijferige PIN in.');
                return;
            }

            const student = students.find(s => s.id === studentId);
            if (!student) {
                showLoginError('studentLoginError', 'Leerling niet gevonden.');
                return;
            }

            if (!student.pin || student.pin !== pin) {
                showLoginError('studentLoginError', 'Onjuiste PIN. Vraag je leraar om je PIN.');
                document.getElementById('studentPin').value = '';
                document.getElementById('studentPin').focus();
                return;
            }

            // Successful student login
            currentUser = student;
            userRole = 'student';
            currentStudent = student;
            
            // Hide login screen and show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Hide all admin controls for students
            document.getElementById('modeToggle').style.display = 'none';
            document.getElementById('adminContent').style.display = 'none';
			// Hide all admin controls for students
document.getElementById('modeToggle').style.display = 'none';
document.getElementById('adminContent').style.display = 'none';
document.getElementById('tokenAssignmentPanel').style.display = 'block';

// ← VOEG HIER DE NIEUWE CODE TOE:
// Hide reflection cards tab for students
const reflectionTab = document.querySelector('button[onclick="switchTab(\'reflection\')"]');
if (reflectionTab) reflectionTab.style.display = 'none';

// Show student dashboard and sidebar
document.getElementById('studentDashboard').classList.add('active');
            document.getElementById('tokenAssignmentPanel').style.display = 'block';
            
            // Show student dashboard and sidebar
            document.getElementById('studentDashboard').classList.add('active');
            document.getElementById('dashboardSidebar').classList.add('active');
            document.getElementById('teacherStudentSelector').style.display = 'none';
            
            // Set appropriate dashboard title
            document.getElementById('dashboardTitle').textContent = `🎯 Mijn Dashboard`;
            
            // Update student interface
            updateSidebar();
            updateDashboardTokenGrid();
            updateDashboardMilestones();
			updatePortfolioSummary();
            renderStudentTasks();
            
            showNotification(`Welkom terug, ${student.name}!`, 'success');
            addToTimeline(`🔐 Leerling login: ${student.name}`, student.id);
        }

        function loginTeacher() {
            const password = document.getElementById('teacherPassword').value;
            
            if (!password) {
                showLoginError('teacherLoginError', 'Voer het leraar wachtwoord in.');
                return;
            }

            if (password !== teacherPassword) {
                showLoginError('teacherLoginError', 'Onjuist wachtwoord.');
                document.getElementById('teacherPassword').value = '';
                document.getElementById('teacherPassword').focus();
                return;
            }

            // Successful teacher login
            currentUser = { name: 'Leraar', role: 'teacher' };
            userRole = 'teacher';
            
            // Hide login screen and show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Show teacher controls and admin interface
            document.getElementById('modeToggle').style.display = 'flex';
            document.getElementById('adminContent').style.display = 'flex';
            document.getElementById('teacherStudentSelector').style.display = 'block';
            document.getElementById('tokenAssignmentPanel').style.display = 'block';
            
            // Hide student dashboard initially
            document.getElementById('studentDashboard').classList.remove('active');
            document.getElementById('dashboardSidebar').classList.remove('active');
            
            // Initialize teacher mode (admin by default)
            currentMode = 'admin';
            document.getElementById('adminModeBtn').classList.add('active');
            document.getElementById('studentModeBtn').classList.remove('active');
            
            // Update dashboard student selector for teacher use
            updateDashboardStudentSelector();
            
            showNotification('Welkom leraar! Volledige toegang geactiveerd.', 'success');
            addToTimeline('🔐 Leraar login', null);
        }

        function logout() {
            if (confirm('Weet je zeker dat je wilt uitloggen?')) {
                // Reset authentication state
                currentUser = null;
                userRole = null;
                currentStudent = null;
                
                // Clear forms
                document.getElementById('studentSelect').value = '';
                document.getElementById('studentPin').value = '';
                document.getElementById('teacherPassword').value = '';
                document.getElementById('pinGroup').style.display = 'none';
                clearLoginErrors();
                
                // Show login screen and hide app
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appContainer').classList.remove('active');
                
                // Reset to welcome screen
                showWelcome();
                
                showNotification('Succesvol uitgelogd', 'success');
            }
        }

        function showLoginError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function clearLoginErrors() {
            document.getElementById('studentLoginError').style.display = 'none';
            document.getElementById('teacherLoginError').style.display = 'none';
        }

        // PIN Management Functions
        function generateRandomPin() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function renderPinList() {
            const container = document.getElementById('pinList');
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Geen leerlingen om PINs voor te beheren</p>';
                return;
            }

            container.innerHTML = students.map(student => {
                const pin = student.pin || '----';
                const hasPin = !!student.pin;
                
                return `
                    <div class="pin-item">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">${student.name}</div>
                            <div style="font-size: 0.9rem; color: #666;">
                                Status: ${hasPin ? '✅ PIN ingesteld' : '⚠️ Geen PIN'}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div class="pin-display" style="${!hasPin ? 'color: #999;' : ''}">${pin}</div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-warning btn-small" onclick="generateNewPin('${student.id}')" title="Nieuwe PIN genereren">
                                    🎲 Nieuw
                                </button>
                                <button class="btn btn-info btn-small" onclick="editPin('${student.id}')" title="PIN handmatig instellen">
                                    ✏️ Wijzig
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateNewPin(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const newPin = generateRandomPin();
            student.pin = newPin;
            
            saveData();
            renderPinList();
            
            showNotification(`Nieuwe PIN voor ${student.name}: ${newPin}`, 'success');
            addToTimeline(`🔐 Nieuwe PIN gegenereerd voor: ${student.name}`, studentId);
        }

        function editPin(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            const currentPin = student.pin || '';
            const newPin = prompt(`PIN voor ${student.name}:\n(4 cijfers, laat leeg om te verwijderen)`, currentPin);
            
            if (newPin === null) return; // Cancelled
            
            if (newPin === '') {
                // Remove PIN
                delete student.pin;
                showNotification(`PIN verwijderd voor ${student.name}`, 'warning');
                addToTimeline(`🔐 PIN verwijderd voor: ${student.name}`, studentId);
            } else if (newPin.length === 4 && /^\d{4}$/.test(newPin)) {
                // Valid 4-digit PIN
                student.pin = newPin;
                showNotification(`PIN ingesteld voor ${student.name}: ${newPin}`, 'success');
                addToTimeline(`🔐 PIN ingesteld voor: ${student.name}`, studentId);
            } else {
                showNotification('PIN moet precies 4 cijfers zijn!', 'error');
                return;
            }
            
            saveData();
            renderPinList();
        }
		// Reflectiekaartjes Management
function updateReflectionSubgoals() {
    const skillSelect = document.getElementById('reflectionSkillSelect');
    const subgoalSelect = document.getElementById('reflectionSubgoalSelect');
    const selectedSkill = skillSelect.value;
    
    subgoalSelect.innerHTML = '<option value="">Kies een subdoel...</option>';
    
    if (selectedSkill && skillSubgoals[selectedSkill]) {
        skillSubgoals[selectedSkill].forEach(subgoal => {
            const option = document.createElement('option');
            option.value = subgoal;
            option.textContent = subgoal;
            subgoalSelect.appendChild(option);
        });
    }
    
    // Clear cards container
    document.getElementById('reflectionCardsContainer').innerHTML = 
        '<p style="text-align: center; color: #666; padding: 2rem;">Selecteer een subdoel om kaartjes te bekijken</p>';
}

function loadReflectionCards() {
    const skillSelect = document.getElementById('reflectionSkillSelect');
    const subgoalSelect = document.getElementById('reflectionSubgoalSelect');
    const skill = skillSelect.value;
    const subgoal = subgoalSelect.value;
    
    if (!skill || !subgoal) {
        document.getElementById('reflectionCardsContainer').innerHTML = 
            '<p style="text-align: center; color: #666; padding: 2rem;">Selecteer een vaardigheid en subdoel om kaartjes te bekijken</p>';
        return;
    }
    
    const key = `${skill}-${subgoal}`;
    const cards = reflectionCards[key] || [];
    
    renderReflectionCards(cards, key);
}

function renderReflectionCards(cards, key) {
    const container = document.getElementById('reflectionCardsContainer');
    
    if (cards.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🎴</div>
                <h3>Nog geen reflectiekaartjes</h3>
                <p style="margin: 1rem 0;">Upload je eerste kaartjes voor deze combinatie!</p>
                <button class="btn btn-success" onclick="showReflectionCardForm()">
                    ➕ Kaartjes Uploaden
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>${cards.length} kaartje(s) gevonden</h3>
            <button class="btn btn-success" onclick="showReflectionCardForm()">➕ Meer Kaartjes Toevoegen</button>
        </div>
        <div class="reflection-cards-grid">
            ${cards.map(card => `
                <div class="reflection-card">
                    <button class="reflection-card-remove" onclick="removeReflectionCard('${key}', '${card.id}')" title="Verwijderen">×</button>
                    <img src="${card.image}" alt="${card.title}" class="reflection-card-image">
                    <div class="reflection-card-title">${card.title}</div>
                    <div class="reflection-card-meta">${card.description || 'Geen beschrijving'}</div>
                </div>
            `).join('')}
        </div>
    `;
}

// Update showReflectionCardForm functie
function showReflectionCardForm() {
    // Pre-fill met huidige selectie als die er is
    const currentSkill = document.getElementById('reflectionSkillSelect').value;
    const currentSubgoal = document.getElementById('reflectionSubgoalSelect').value;
    
    document.getElementById('uploadSkillSelect').value = currentSkill;
    updateUploadSubgoals();
    document.getElementById('uploadSubgoalSelect').value = currentSubgoal;
    
    // Reset upload state
    pendingReflectionUploads = [];
    document.getElementById('uploadPreview').style.display = 'none';
    document.getElementById('saveReflectionBtn').disabled = true;
    
    // Show modal
    document.getElementById('reflectionCardModal').classList.add('show');
}

function closeReflectionCardModal() {
    document.getElementById('reflectionCardModal').classList.remove('show');
    pendingReflectionUploads = [];
}

function updateUploadSubgoals() {
    const skillSelect = document.getElementById('uploadSkillSelect');
    const subgoalSelect = document.getElementById('uploadSubgoalSelect');
    const selectedSkill = skillSelect.value;
    
    subgoalSelect.innerHTML = '<option value="">Kies een subdoel...</option>';
    
    if (selectedSkill && skillSubgoals[selectedSkill]) {
        skillSubgoals[selectedSkill].forEach(subgoal => {
            const option = document.createElement('option');
            option.value = subgoal;
            option.textContent = subgoal;
            subgoalSelect.appendChild(option);
        });
    }
}

// Global variabele voor pending uploads
let pendingReflectionUploads = [];

function handleReflectionFiles(files) {
    const skill = document.getElementById('uploadSkillSelect').value;
    const subgoal = document.getElementById('uploadSubgoalSelect').value;
    
    if (!skill || !subgoal) {
        alert('Selecteer eerst een vaardigheid en subdoel!');
        return;
    }
    
    if (files.length > 10) {
        alert('Maximaal 10 kaartjes per keer toegestaan!');
        return;
    }
    
    pendingReflectionUploads = [];
    let processedFiles = 0;
    
    Array.from(files).forEach((file, index) => {
        if (!file.type.startsWith('image/')) {
            alert(`Bestand "${file.name}" is geen afbeelding en wordt overgeslagen.`);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const cardData = {
                id: generateId(),
                title: `Kaart ${index + 1}`,
                image: e.target.result,
                description: '',
                fileName: file.name
            };
            
            pendingReflectionUploads.push(cardData);
            processedFiles++;
            
            if (processedFiles === files.length) {
                showUploadPreview();
            }
        };
        reader.readAsDataURL(file);
    });
}
function saveReflectionCards() {
    const skill = document.getElementById('uploadSkillSelect').value;
    const subgoal = document.getElementById('uploadSubgoalSelect').value;
    
    if (!skill || !subgoal) {
        alert('Selecteer een vaardigheid en subdoel!');
        return;
    }
    
    if (pendingReflectionUploads.length === 0) {
        alert('Geen kaartjes om op te slaan!');
        return;
    }
    
    // Valideer dat alle kaartjes een titel hebben
    const emptyTitles = pendingReflectionUploads.filter(card => !card.title.trim());
    if (emptyTitles.length > 0) {
        alert('Alle kaartjes moeten een titel hebben!');
        return;
    }
    
    const key = `${skill}-${subgoal}`;
    
    // Initialiseer array als deze nog niet bestaat
    if (!reflectionCards[key]) {
        reflectionCards[key] = [];
    }
    
    // Voeg alle nieuwe kaartjes toe
    pendingReflectionUploads.forEach(card => {
        reflectionCards[key].push({
            id: card.id,
            title: card.title.trim(),
            image: card.image,
            description: card.description.trim(),
            createdAt: new Date().toISOString(),
            skill: skill,
            subgoal: subgoal
        });
    });
    
    // Opslaan in localStorage
    saveData();
    
    // Update de timeline
    addToTimeline(`🎴 ${pendingReflectionUploads.length} reflectiekaart(en) toegevoegd voor ${skillDefinitions[skill].name} - ${subgoal}`, null);
    
    // Sluit modal
    closeReflectionCardModal();
    
    // Update de huidige weergave als we in dezelfde categorie zitten
    const currentSkill = document.getElementById('reflectionSkillSelect').value;
    const currentSubgoal = document.getElementById('reflectionSubgoalSelect').value;
    
    if (currentSkill === skill && currentSubgoal === subgoal) {
        loadReflectionCards();
    }
    
    // Success melding
    showNotification(`✅ ${pendingReflectionUploads.length} reflectiekaart(en) succesvol opgeslagen!`, 'success');
    
    // Update statistieken
    updateStatistics();
}
function showReflectionCards(skillCode) {
    const skillData = skillDefinitions[skillCode];
    const subgoals = skillSubgoals[skillCode] || [];
    
    if (subgoals.length === 0) {
        showSidebarView(`🎴 ${skillData.name} Reflectie`, 
            '<p style="text-align: center; color: #666;">Geen subdoelen beschikbaar voor deze vaardigheid.</p>');
        return;
    }
    
    let content = `
        <div style="margin-bottom: 2rem;">
            <p style="text-align: center; color: #667eea; font-size: 1.1rem; margin-bottom: 2rem;">
                Kies een subdoel om de bijbehorende reflectiekaartjes te bekijken
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
    `;
    
    subgoals.forEach(subgoal => {
        const key = `${skillCode}-${subgoal}`;
        const cards = reflectionCards[key] || [];
        const cardCount = cards.length;
        
        content += `
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease;" 
                 onclick="showSubgoalReflectionCards('${skillCode}', '${subgoal}')"
                 onmouseover="this.style.transform='translateY(-3px)'" 
                 onmouseout="this.style.transform='translateY(0)'">
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 10px;">${subgoal}</div>
                <div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px;">
                    ${cardCount > 0 ? `🎴 ${cardCount} kaart${cardCount === 1 ? '' : 'jes'}` : '📭 Geen kaartjes'}
                </div>
            </div>
        `;
    });
    
    content += '</div></div>';
    
    showSidebarView(`🎴 ${skillData.name} Reflectie`, content);
}

function showSubgoalReflectionCards(skillCode, subgoal) {
    const skillData = skillDefinitions[skillCode];
    const key = `${skillCode}-${subgoal}`;
    const cards = reflectionCards[key] || [];
    
    if (cards.length === 0) {
        const content = `
            <div style="text-align: center; padding: 3rem; color: #666;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">📭</div>
                <h3>Geen reflectiekaartjes</h3>
                <p style="margin: 1rem 0;">Er zijn nog geen reflectiekaartjes toegevoegd voor <strong>${subgoal}</strong>.</p>
                <button class="btn btn-info" onclick="showReflectionCards('${skillCode}')">
                    ← Terug naar subdoelen
                </button>
            </div>
        `;
        showSidebarView(`🎴 ${skillData.name} - ${subgoal}`, content);
        return;
    }
    
    let content = `
        <div style="margin-bottom: 2rem;">
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-info btn-small" onclick="showReflectionCards('${skillCode}')">
                    ← Terug naar subdoelen
                </button>
            </div>
            <p style="text-align: center; color: #667eea; margin-bottom: 2rem;">
                ${cards.length} reflectiekaart${cards.length === 1 ? '' : 'jes'} voor <strong>${subgoal}</strong>
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
    `;
    
    cards.forEach(card => {
        content += `
            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; transition: all 0.3s ease; cursor: pointer;"
                 onclick="showReflectionCardDetail('${card.id}', '${skillCode}', '${subgoal}')"
                 onmouseover="this.style.borderColor='#667eea'; this.style.transform='translateY(-3px)'"
                 onmouseout="this.style.borderColor='#e2e8f0'; this.style.transform='translateY(0)'">
                <img src="${card.image}" alt="${card.title}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-weight: bold; color: #2d3748; margin-bottom: 5px;">${card.title}</div>
                ${card.description ? `<div style="font-size: 0.9rem; color: #666;">${card.description}</div>` : ''}
            </div>
        `;
    });
    
    content += '</div></div>';
    
    showSidebarView(`🎴 ${skillData.name} - ${subgoal}`, content);
}

function showReflectionCardDetail(cardId, skillCode, subgoal) {
    const key = `${skillCode}-${subgoal}`;
    const cards = reflectionCards[key] || [];
    const card = cards.find(c => c.id === cardId);
    
    if (!card) return;
    
    const skillData = skillDefinitions[skillCode];
    const answerKey = `${currentStudent.id}-${cardId}`;
    const existingAnswers = reflectionAnswers[answerKey] || {};
    
    const content = `
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-info btn-small" onclick="showSubgoalReflectionCards('${skillCode}', '${subgoal}')">
                ← Terug naar ${subgoal}
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
            <!-- Linker kolom: Afbeelding -->
            <div style="text-align: center;">
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                    <img src="${card.image}" alt="${card.title}" 
                         style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; margin-bottom: 15px;">
                    <h3 style="color: #2d3748; margin-bottom: 10px;">${card.title}</h3>
                    ${card.description ? `<p style="color: #666; line-height: 1.5;">${card.description}</p>` : ''}
                    
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9ff; border-radius: 8px; font-size: 0.9rem; color: #667eea;">
                        <strong>💡 Tip:</strong> Bekijk de afbeelding goed en beantwoord de vragen rechts zo eerlijk mogelijk.
                    </div>
                </div>
            </div>
            
            <!-- Rechter kolom: 5W1H Vragen -->
            <div>
                <div style="background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                    <h3 style="color: #2d3748; margin-bottom: 20px; text-align: center;">🤔 Reflectievragen</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; color: #007bff; margin-bottom: 5px;">
                            👤 WHO - Wie is er betrokken?
                        </label>
                        <textarea id="reflection-who" style="width: 100%; height: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                                  placeholder="Wie zie je in de afbeelding? Wie is betrokken bij deze situatie?">${existingAnswers.who || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; color: #28a745; margin-bottom: 5px;">
                            ❓ WHAT - Wat gebeurt er?
                        </label>
                        <textarea id="reflection-what" style="width: 100%; height: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                                  placeholder="Wat voor emotie zie je? Wat gebeurt er in de situatie?">${existingAnswers.what || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; color: #ffc107; margin-bottom: 5px;">
                            🕐 WHEN - Wanneer gebeurt dit?
                        </label>
                        <textarea id="reflection-when" style="width: 100%; height: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                                  placeholder="Wanneer voel je deze emotie? In welke momenten?">${existingAnswers.when || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; color: #fd7e14; margin-bottom: 5px;">
                            📍 WHERE - Waar gebeurt dit?
                        </label>
                        <textarea id="reflection-where" style="width: 100%; height: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                                  placeholder="Waar vind deze emotie plaats? In welke omgeving?">${existingAnswers.where || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: bold; color: #6f42c1; margin-bottom: 5px;">
                            🤔 WHY - Waarom gebeurt dit?
                        </label>
                        <textarea id="reflection-why" style="width: 100%; height: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                                  placeholder="Waarom ontstaat deze emotie? Wat is de oorzaak?">${existingAnswers.why || ''}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: bold; color: #dc3545; margin-bottom: 5px;">
                            🛠️ HOW - Hoe kun je ermee omgaan?
                        </label>
                        <textarea id="reflection-how" style="width: 100%; height: 60px; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                                  placeholder="Hoe kun je met deze emotie omgaan? Welke strategieën helpen?">${existingAnswers.how || ''}</textarea>
                    </div>
                    
                    <div style="text-align: center; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                        <button class="btn btn-success" onclick="saveReflectionAnswers('${cardId}', '${skillCode}', '${subgoal}')" 
                                style="margin-right: 10px;">
                            💾 Antwoorden Opslaan
                        </button>
                        <button class="btn btn-warning" onclick="clearReflectionAnswers('${cardId}')" 
                                style="background: #ed8936;">
                            🗑️ Wissen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    showSidebarView(`🎴 ${card.title} - Reflectie`, content);

}
function saveReflectionAnswers(cardId, skillCode, subgoal) {
    if (!currentStudent) return;
    
    const answers = {
        who: document.getElementById('reflection-who').value.trim(),
        what: document.getElementById('reflection-what').value.trim(),
        when: document.getElementById('reflection-when').value.trim(),
        where: document.getElementById('reflection-where').value.trim(),
        why: document.getElementById('reflection-why').value.trim(),
        how: document.getElementById('reflection-how').value.trim()
    };
    
    const answerKey = `${currentStudent.id}-${cardId}`;
    reflectionAnswers[answerKey] = answers;
    
    // Save to localStorage
    saveData();
    
    // Add to timeline
    const answerCount = Object.values(answers).filter(answer => answer !== '').length;
    
    addToTimeline(`🤔 Reflectievragen beantwoord (${answerCount}/6 vragen) voor: ${skillDefinitions[skillCode].name}`, currentStudent.id);
    // Show success notification
    showNotification(`✅ Reflectie antwoorden opgeslagen! (${answerCount}/6 vragen beantwoord)`, 'success');
    
    // Update portfolio
    updatePortfolioSummary();
}

function clearReflectionAnswers(cardId) {
    if (!currentStudent) return;
    
    if (confirm('Weet je zeker dat je al je antwoorden wilt wissen?')) {
        // Clear form fields
        document.getElementById('reflection-who').value = '';
        document.getElementById('reflection-what').value = '';
        document.getElementById('reflection-when').value = '';
        document.getElementById('reflection-where').value = '';
        document.getElementById('reflection-why').value = '';
        document.getElementById('reflection-how').value = '';
        
        // Remove from data
        const answerKey = `${currentStudent.id}-${cardId}`;
        delete reflectionAnswers[answerKey];
        
        // Save changes
        saveData();
        
        showNotification('🗑️ Antwoorden gewist!', 'warning');
    }
}
function showUploadPreview() {
    const previewContainer = document.getElementById('previewGrid');
    const uploadPreview = document.getElementById('uploadPreview');
    
    previewContainer.innerHTML = pendingReflectionUploads.map((card, index) => `
        <div class="reflection-card" style="position: relative;">
            <button onclick="removePendingCard(${index})" 
                    style="position: absolute; top: 5px; right: 5px; background: #f56565; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 12px;">×</button>
            <img src="${card.image}" alt="${card.title}" class="reflection-card-image">
            <input type="text" value="${card.title}" onchange="updatePendingCardTitle(${index}, this.value)" 
                   style="width: 100%; margin: 5px 0; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Titel van kaart">
            <textarea onchange="updatePendingCardDescription(${index}, this.value)" 
                      style="width: 100%; height: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;" 
                      placeholder="Beschrijving (optioneel)">${card.description}</textarea>
        </div>
    `).join('');
    
    uploadPreview.style.display = 'block';
    document.getElementById('saveReflectionBtn').disabled = pendingReflectionUploads.length === 0;
}

function removePendingCard(index) {
    pendingReflectionUploads.splice(index, 1);
    if (pendingReflectionUploads.length === 0) {
        document.getElementById('uploadPreview').style.display = 'none';
        document.getElementById('saveReflectionBtn').disabled = true;
    } else {
        showUploadPreview();
    }
}

function updatePendingCardTitle(index, newTitle) {
    if (pendingReflectionUploads[index]) {
        pendingReflectionUploads[index].title = newTitle;
    }
}

function updatePendingCardDescription(index, newDescription) {
    if (pendingReflectionUploads[index]) {
        pendingReflectionUploads[index].description = newDescription;
    }
}

// Drag & Drop handlers
function handleReflectionDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    handleReflectionFiles(e.dataTransfer.files);
}

function handleReflectionDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleReflectionDragLeave(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
}

function removeReflectionCard(key, cardId) {
    if (confirm('Weet je zeker dat je deze reflectiekaart wilt verwijderen?')) {
        if (reflectionCards[key]) {
            reflectionCards[key] = reflectionCards[key].filter(card => card.id !== cardId);
            loadReflectionCards(); // Refresh de weergave
            saveData(); // Opslaan
            showNotification('Reflectiekaart verwijderd!', 'success');
        }
    }
}
          console.log('3. All functions loaded');
// ✅ VOEG DEZE COMPLETE FUNCTIE TOE VOOR JE init() FUNCTIE
// ✅ VERBETERDE REALTIME SYNC met minder agressieve updates
// OPLOSSING 1: Automatische achtergrond sync voor leerlingen, notificaties alleen voor leraren
function startPeriodicSync() {
    console.log('🚀 Starting improved periodic sync (30 sec intervals)');
    
    // Check elke 30 seconden voor updates
    setInterval(async () => {
        // Alleen als we online zijn en ingelogd zijn EN geen handmatige sync bezig is
        if (navigator.onLine && supabase && cloudSyncEnabled && 
            (currentStudent || userRole === 'teacher') && 
            !window.manualSyncInProgress) {
            
            try {
                // Silent check voor updates - GEEN download, alleen check
                const { data, error } = await supabase
                    .from('learning_system_data')
                    .select('updated_at')
                    .eq('id', 1)
                    .single();

                if (data) {
                    const lastUpdate = new Date(data.updated_at);
                    const storedLastUpdate = localStorage.getItem('lastSyncTime');
                    
                    // Check if there's SIGNIFICANTLY newer data (meer dan 1 minuut verschil)
                    if (!storedLastUpdate || lastUpdate > new Date(new Date(storedLastUpdate).getTime() + 300000)) {
                        console.log('📥 Significant new cloud data detected...');
                        
                        // 🎯 NIEUWE LOGICA: Verschil tussen leraren en leerlingen
                        if (userRole === 'teacher') {
                            // LERAREN: Toon notificatie voor controle
                            if (!document.getElementById('cloudUpdateNotification')) {
                                showCloudUpdateNotification();
                            }
                       } else {
    // LEERLINGEN: NIET automatisch refreshen - behoud hun werk
    console.log('📌 Student heeft nieuwe cloud data beschikbaar, maar skip auto-refresh om werk te behouden');
    // await silentRefreshFromCloud(); // UITGESCHAKELD - voorkomt verlies van student werk
}
                    }
                }
            } catch (error) {
                // Silent fail - alleen log voor debug
                if (!error.message.includes('Failed to fetch')) {
                    console.log('⚠️ Periodic sync check failed (normal):', error.message);
                }
            }
        }
    }, 30000); // Elke 30 seconden
}

// ✅ NIEUWE FUNCTIE: Toon melding van cloud updates
function showCloudUpdateNotification() {
    // Voorkom meerdere notificaties
    if (document.getElementById('cloudUpdateNotification')) return;
    
    const notification = document.createElement('div');
    notification.id = 'cloudUpdateNotification';
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1500;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        display: flex;
        align-items: center;
        gap: 15px;
        animation: slideDown 0.5s ease;
        max-width: 400px;
        text-align: center;
    `;
    
    notification.innerHTML = `
        <div style="flex: 1;">
            <div style="font-weight: bold; margin-bottom: 5px;">🔄 Nieuwe wijzigingen beschikbaar</div>
            <div style="font-size: 0.9rem; opacity: 0.9;">Er zijn updates gemaakt door anderen.</div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button onclick="refreshFromCloud()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                📥 Refresh
            </button>
            <button onclick="this.closest('#cloudUpdateNotification').remove()" style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
                ✕
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove na 10 seconden
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 10000);
}

// ✅ NIEUWE FUNCTIE: Refresh van cloud met user consent
async function refreshFromCloud() {
    try {
        // Remove notification
        const notification = document.getElementById('cloudUpdateNotification');
        if (notification) notification.remove();
        
        updateCloudStatus('syncing', 'Refreshing van cloud...');
        
        const oldStudentData = currentStudent ? JSON.parse(JSON.stringify(currentStudent)) : null;
        
        // Download nieuwe data
        await downloadFromCloud();
        
        // Update current student reference
        if (currentStudent) {
            const updatedStudent = students.find(s => s.id === currentStudent.id);
            if (updatedStudent) {
                currentStudent = updatedStudent;
                
                if (userRole === 'student') {
                    checkForRealTimeUpdates(oldStudentData, currentStudent);
                }
            }
        }
        
        // Update teacher interface if needed
        if (userRole === 'teacher') {
            updateStatistics();
            if (currentMode === 'student' && currentStudent) {
                updateSidebar();
                updateDashboardTokenGrid();
                updateDashboardMilestones();
                updatePortfolioSummary();
            }
            if (document.getElementById('presentation-tab')?.classList.contains('active')) {
                renderPresentationView();
            }
        }
        
        updateCloudStatus('online', 'Gerefresht van cloud');
        showNotification('📥 Data succesvol gerefresht!', 'success');
        
    } catch (error) {
        console.error('❌ Refresh failed:', error);
        updateCloudStatus('offline', 'Refresh mislukt');
        showNotification('Refresh mislukt: ' + error.message, 'error');
    }
}
refreshFromCloud()

async function silentRefreshFromCloud() {
    try {
        console.log('🔄 Silent refresh starting...');
        
        // Bewaar huidige student ID
        const currentStudentId = currentStudent?.id;
        const oldStudentData = currentStudent ? 
            JSON.parse(JSON.stringify(currentStudent)) : null;
        
        // Download nieuwe data
        await downloadFromCloud();
        
        // Herstel current student reference
        if (currentStudentId) {
            const updatedStudent = students.find(s => s.id === currentStudentId);
            if (updatedStudent) {
                // Kopieer eigenschappen in plaats van directe toewijzing
                Object.assign(currentStudent, updatedStudent);
                console.log('✅ Current student restored after silent refresh:', currentStudent.name);
                
                // Check voor belangrijke updates voor leerlingen
                if (userRole === 'student' && oldStudentData) {
                    checkForRealTimeUpdates(oldStudentData, currentStudent);
                }
                
                // FORCEER UI updates
                setTimeout(() => {
                    updateSidebar();
                    updateSkillBars();
                    updateDashboardTokenGrid();
                    updateDashboardMilestones();
                    updatePortfolioSummary();
                }, 200);
            } else {
                console.log('❌ Could not restore current student after refresh');
            }
        }
        
        console.log('✅ Silent refresh completed');
        
    } catch (error) {
        console.error('❌ Silent refresh failed:', error);
        // Geen notificatie bij stille refresh fails
    }
}

// ← NIEUWE FUNCTIE VOOR REAL-TIME UPDATES
function checkForRealTimeUpdates(oldStudent, newStudent) {
    if (!oldStudent || !newStudent) return;
    
    // Check voor nieuwe tokens
    const oldTokenCount = oldStudent.tokens?.length || 0;
    const newTokenCount = newStudent.tokens?.length || 0;
    
    if (newTokenCount > oldTokenCount) {
        console.log('🎨 Nieuwe token(s) gedetecteerd!');
        
        // Update alle interfaces
        updateSidebar();
        updateDashboardTokenGrid();
        updateDashboardMilestones();
        updatePortfolioSummary();
        
        // Speciaal token effect
        showTokenReceivedEffect();
        
        // Notification met details
        const newTokens = newStudent.tokens.slice(oldTokenCount);
        newTokens.forEach((token, index) => {
            const tokenType = tokenTypes.find(t => t.id === token.type);
            setTimeout(() => {
                showNotification(
                    `🎨 Nieuwe ${tokenType?.name || 'token'} ontvangen!`,
                    'success'
                );
            }, index * 1000);
        });
    }
    
    // Check voor nieuwe mijlpalen
    const oldMilestones = oldStudent.achievedMilestones?.length || 0;
    const newMilestones = newStudent.achievedMilestones?.length || 0;
    
    if (newMilestones > oldMilestones) {
        console.log('🏆 Nieuwe mijlpaal(mijlpalen) behaald!');
        
        const newAchievedMilestones = newStudent.achievedMilestones.slice(oldMilestones);
        newAchievedMilestones.forEach((milestone, index) => {
            setTimeout(() => {
                showMilestoneNotification(milestone);
                playMilestoneEffect();
            }, (index + 1) * 2000);
        });
        
        // Update interfaces
        updateSidebar();
        updateDashboardMilestones();
        updatePortfolioSummary();
    }
    
    // Check voor voltooide taken
    const oldCompletedTasks = oldStudent.completedTasks?.length || 0;
    const newCompletedTasks = newStudent.completedTasks?.length || 0;
    
    if (newCompletedTasks > oldCompletedTasks) {
        console.log('✅ Nieuwe taak(taken) voltooid!');
        
        // Update interfaces
        updateSidebar();
        renderStudentTasks();
        updatePortfolioSummary();
        
        // Task completion effect
        showTaskCompletionEffect();
        
        const completedTasksCount = newCompletedTasks - oldCompletedTasks;
        showNotification(
            `✅ ${completedTasksCount} taak${completedTasksCount > 1 ? 'en' : ''} voltooid!`,
            'success'
        );
    }
    
    // Check voor skill increases
    const oldSkills = oldStudent.skills || {};
    const newSkills = newStudent.skills || {};
    
    let skillChanges = [];
    Object.keys(newSkills).forEach(skillCode => {
        const oldValue = Math.round(oldSkills[skillCode] || 0);
        const newValue = Math.round(newSkills[skillCode] || 0);
        
        if (newValue > oldValue) {
            const skillName = skillDefinitions[skillCode]?.name || skillCode;
            skillChanges.push(`+${newValue - oldValue}% ${skillName}`);
        }
    });
    
    if (skillChanges.length > 0) {
        console.log('📈 Vaardigheden verhoogd!');
        
        // Update skill bars met animatie
        setTimeout(() => {
            updateSkillBars();
            showSkillIncreaseEffect();
        }, 500);
        
        showNotification(
            `📈 Vaardigheden verhoogd: ${skillChanges.join(', ')}`,
            'success'
        );
    }
}
// ← NIEUWE VISUELE EFFECTEN
function showTokenReceivedEffect() {
    const tokenRows = document.getElementById('tokenRows');
    if (tokenRows) {
        // Glow effect
        tokenRows.style.boxShadow = '0 0 20px #ffd700';
        tokenRows.style.transform = 'scale(1.05)';
        tokenRows.style.transition = 'all 0.5s ease';
        
        setTimeout(() => {
            tokenRows.style.boxShadow = '';
            tokenRows.style.transform = 'scale(1)';
        }, 1500);
    }
    
    // Confetti effect op de token sectie
    createConfetti('🎨', 10);
}

function showTaskCompletionEffect() {
    const tasksSection = document.getElementById('tasksSection');
    if (tasksSection) {
        // Pulse effect
        tasksSection.style.background = 'rgba(72, 187, 120, 0.3)';
        tasksSection.style.transform = 'scale(1.02)';
        tasksSection.style.transition = 'all 0.4s ease';
        
        setTimeout(() => {
            tasksSection.style.background = '';
            tasksSection.style.transform = 'scale(1)';
        }, 1000);
    }
    
    createConfetti('✅', 5);
}

function showSkillIncreaseEffect() {
    const skillsSection = document.getElementById('skillsSection');
    if (skillsSection) {
        // Rainbow glow effect
        skillsSection.style.boxShadow = '0 0 25px rgba(102, 126, 234, 0.8)';
        skillsSection.style.transition = 'box-shadow 0.6s ease';
        
        setTimeout(() => {
            skillsSection.style.boxShadow = '';
        }, 2000);
    }
}

function playMilestoneEffect() {
    // Extra milestone effect
    createConfetti('🏆', 20);
    
    const milestonesSection = document.getElementById('milestonesSection');
    if (milestonesSection) {
        milestonesSection.style.background = 'rgba(255, 215, 0, 0.4)';
        milestonesSection.style.transition = 'background 0.8s ease';
        
        setTimeout(() => {
            milestonesSection.style.background = '';
        }, 3000);
    }
}

function createConfetti(emoji, count) {
    for (let i = 0; i < count; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.textContent = emoji;
            confetti.style.cssText = `
                position: fixed;
                top: 20%;
                left: ${Math.random() * 100}%;
                font-size: 2rem;
                z-index: 9999;
                pointer-events: none;
                animation: confettiFall 3s ease-out forwards;
            `;
            
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 3000);
        }, i * 200);
    }
}
 async function init() {
    try {
        console.log('🚀 Initializing system...');
        
												   
        const supabaseReady = await initSupabase();
		
												  
        loadData();
        
        // ✅ AUTO-ENABLE CLOUD SYNC ALWAYS
        if (supabaseReady) {
            console.log('🔄 Auto-enabling cloud sync...');
            
            // Force enable cloud sync
            cloudSyncEnabled = true;
            localStorage.setItem('cloudSyncEnabled', 'true');
            
            // Update UI
            const checkbox = document.getElementById('cloudSyncCheckbox');
            const toggle = document.getElementById('syncToggle');
            if (checkbox) checkbox.checked = true;
            if (toggle) toggle.classList.add('enabled');
            
            // Enable buttons
            ['manualSyncBtn', 'downloadBtn', 'uploadBtn'].forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) btn.disabled = false;
            });
            
            updateCloudStatus('online', 'Cloud sync automatisch ingeschakeld');
            
         
            // Auto-download data - slim bepalen
try {
    // Alleen downloaden als er GEEN student data lokaal is
    const localData = localStorage.getItem('integratedLearningSystem');
    const hasLocalStudentWork = localData && JSON.parse(localData).tasks?.length > 0;
    
    if (!hasLocalStudentWork || userRole === 'teacher') {
        console.log('📥 Auto-downloading from cloud...');
        await downloadFromCloud();
        console.log('✅ Cloud data synced on startup');
    } else {
        console.log('📌 Local student data found - skipping cloud download');
    }
                
                // ✅ EXTRA FORCE UPDATE VOOR CHROMEBOOKS
                setTimeout(() => {
                    updateStudentSelector();
                    forceUpdateStudentLogin();
                    console.log('🔧 Student login forced update voor Chromebooks');
                }, 1000);
                
            } catch (error) {
                console.warn('⚠️ Cloud sync failed on startup, using local data:', error);
                updateCloudStatus('offline', 'Cloud sync mislukt, lokale data gebruikt');
            }
        } else {
            console.log('⚠️ Supabase niet beschikbaar, alleen lokale data');
																   
        }
        
																	   
        initializeDefaults();
        updateStatistics();
        renderStudentsList();
        renderTasksList();
        renderMilestonesList();
        renderLogbookContent();
        renderFeedbackContent();
        renderTimelineContent();
        updateDashboardStudentSelector();
        renderGroupsList();
        renderPinList();
        
        setTimeout(checkStorageStatus, 1000);
		
	
        
									   
											 
		
																  
						  
									
									  
																		 
				
		
					  
        console.log('🎯 Geïntegreerd systeem geladen!');
        console.log('📊 Students loaded:', students.length);
        console.log('📋 Students:', students.map(s => s.name));
														
														  
        
    } catch (error) {
        console.error('❌ Init failed:', error);
		
										   
			 
        // Fallback naar lokale data
        initializeDefaults();
        updateStatistics();
        renderStudentsList();
							  
											 
							
			
													   
							  
										
										  
																  
					
			
																				
																			
			
								 
																		   
																		
																			  
		 
    }
}															  

// CSS animatie voor confetti - voeg toe als deze nog niet bestaat
if (!document.getElementById('confettiStyles')) {
    const style = document.createElement('style');
    style.id = 'confettiStyles';
    style.textContent = `
      @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
}
        function initializeDefaults() {
            // Default milestones
            if (milestones.length === 0) {
                milestones = [
                    { id: generateId(), name: 'Zelfbewustzijn Meester', skill: 'zb', badge: '🧠', level: 1 },
                    { id: generateId(), name: 'Zelfmanagement Guru', skill: 'zm', badge: '⚡', level: 1 },
                    { id: generateId(), name: 'Sociaal Bewustzijn Expert', skill: 'sb', badge: '🤝', level: 1 },
                    { id: generateId(), name: 'Relatie Meester', skill: 'rv', badge: '💫', level: 1 },
                    { id: generateId(), name: 'Besluitvorming Pro', skill: 'vb', badge: '🎯', level: 1 }
                ];
            }

            // Sample groups
            if (groups.length === 0) {
                const group1 = {
                    id: generateId(),
                    name: 'Team Moon',
                    icon: '🌙',
                    members: [],
                    timestamp: new Date().toISOString()
                };
                groups.push(group1);

                const group2 = {
                    id: generateId(),
                    name: 'Team Sun',
                    icon: '☀️',
                    members: [],
                    timestamp: new Date().toISOString()
                };
                groups.push(group2);
            }

            // Sample students
            if (students.length === 0) {
                const sampleStudents = [
                    {
                        id: generateId(),
                        name: 'Anna Jansen',
                        pin: '1234',
                        tokens: [
                            { id: generateId(), type: 'star', source: 'manual', timestamp: new Date().toISOString() },
                            { id: generateId(), type: 'heart', source: 'task_completion', timestamp: new Date().toISOString() }
                        ],
                        skills: { zb: 25, zm: 15, sb: 30, rv: 10, vb: 20 },
                        skillsAwarded: [],
                        achievedMilestones: [],
                        compliments: [],
                        character: null,
                        energyLevel: 3,
                        groupId: groups[0]?.id,
                        lastActivity: new Date().toISOString(),
                        completedTasks: [],
                        personalGoals: []
                    },
                    {
                        id: generateId(),
                        name: 'Bas de Vries',
                        pin: '5678',
                        tokens: [
                            { id: generateId(), type: 'trophy', source: 'feedback', timestamp: new Date().toISOString() },
                            { id: generateId(), type: 'thumbsup', source: 'logbook', timestamp: new Date().toISOString() }
                        ],
                        skills: { zb: 35, zm: 25, sb: 40, rv: 20, vb: 30 },
                        skillsAwarded: [],
                        achievedMilestones: [],
                        compliments: [],
                        character: null,
                        energyLevel: 4,
                        groupId: groups[0]?.id,
                        lastActivity: new Date().toISOString(),
                        completedTasks: [],
                        personalGoals: []
                    },
                    {
                        id: generateId(),
                        name: 'Carla Bakker',
                        pin: '9012',
                        tokens: [
                            { id: generateId(), type: 'smile', source: 'task_completion', timestamp: new Date().toISOString() },
                            { id: generateId(), type: 'rocket', source: 'personal_goal', timestamp: new Date().toISOString() }
                        ],
                        skills: { zb: 20, zm: 30, sb: 25, rv: 15, vb: 25 },
                        skillsAwarded: [],
                        achievedMilestones: [],
                        compliments: [],
                        character: null,
                        energyLevel: 3,
                        groupId: groups[1]?.id,
                        lastActivity: new Date().toISOString(),
                        completedTasks: [],
                        personalGoals: []
                    }
                ];
                
                students.push(...sampleStudents);
                
                // Assign students to groups
                if (groups.length > 0) {
                    groups[0].members = [sampleStudents[0].id, sampleStudents[1].id];
                    groups[1].members = [sampleStudents[2].id];
                }
            }

            // Sample tasks
            if (tasks.length === 0) {
                const sampleTasks = [
                    {
                        id: generateId(),
                        title: 'Wiskunde oefeningen',
                        subject: 'Wiskunde',
                        goal: 'Breuken begrijpen en toepassen',
                        pages: '45-48',
                        time: '14:00',
                        date: new Date().toISOString().split('T')[0],
                        type: 'daily',
                        assignedStudents: [students[0]?.id, students[1]?.id].filter(Boolean),
                        completed: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: generateId(),
                        title: 'Nederlands werkstuk',
                        subject: 'Nederlands',
                        goal: 'Verhaal schrijven en presenteren',
                        pages: '',
                        time: '10:00',
                        date: new Date(Date.now() + 86400000).toISOString().split('T')[0], // Tomorrow
                        type: 'weekly',
                        assignedStudents: [students[0]?.id, students[2]?.id].filter(Boolean),
                        completed: false,
                        createdAt: new Date().toISOString()
                    }
                ];
                
                tasks.push(...sampleTasks);
            }

            // Ensure all students have required properties
            students.forEach(student => {
                if (!student.skills) student.skills = { zb: 0, zm: 0, sb: 0, rv: 0, vb: 0 };
                if (!student.achievedMilestones) student.achievedMilestones = [];
                if (!student.energyLevel) student.energyLevel = 3;
                if (!student.compliments) student.compliments = [];
                if (!student.skillsAwarded) student.skillsAwarded = [];
                if (!student.tokens) student.tokens = [];
                if (!student.groupId) student.groupId = null;
                if (!student.completedTasks) student.completedTasks = [];
				if (!student.personalGoals) student.personalGoals = [];
                if (!student.personalGoals) student.personalGoals = [];
                if (!student.pin) student.pin = generateRandomPin(); // Auto-generate PIN if missing
            });

            console.log('✅ Data initialized:', students.length, 'students,', tasks.length, 'tasks');
            saveData();



			
        }
        // Mode switching (only for teachers)
        function switchMode(mode) {
            if (userRole !== 'teacher') return; // Only teachers can switch modes
            
            currentMode = mode;
            
            // Update buttons
            document.getElementById('adminModeBtn').classList.toggle('active', mode === 'admin');
            document.getElementById('studentModeBtn').classList.toggle('active', mode === 'student');
            
            // Update content visibility
            if (mode === 'admin') {
                document.getElementById('adminContent').style.display = 'flex';
                document.getElementById('studentDashboard').classList.remove('active');
                document.getElementById('dashboardSidebar').classList.remove('active');
            } else {
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('studentDashboard').classList.add('active');
				
				// ← VOEG DEZE REGEL TOE:
    // Verberg reflection tab content in student mode
    const reflectionTab = document.getElementById('reflection-tab');
    if (reflectionTab) reflectionTab.classList.remove('active');
                
                // Only show sidebar if a student is selected
                if (currentStudent) {
                    document.getElementById('dashboardSidebar').classList.add('active');
                }
                
                // Ensure teacher student selector is visible in student mode
                document.getElementById('teacherStudentSelector').style.display = 'block';
                
                // Update interface for current student or show message to select
                if (currentStudent) {
                    document.getElementById('dashboardTitle').textContent = `🎯 ${currentStudent.name}'s Dashboard`;
                    updateDashboardTokenGrid();
                    updateSidebar();
                    renderStudentTasks();
                    updateDashboardMilestones();
					updatePortfolioSummary(); // ← DEZE REGEL TOEVOEGEN
                } else {
                    // Reset title and show message to select a student
                    document.getElementById('dashboardTitle').textContent = `🎯 Student Dashboard`;
                    document.getElementById('studentTasks').innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">👆 Selecteer een leerling hierboven om hun dashboard te bekijken</p>';
                    document.getElementById('dashboardTokenGrid').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om hun tokens te bekijken</p>';
                    document.getElementById('dashboardMilestones').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om hun mijlpalen te bekijken</p>';
                    // Show placeholder messages
document.getElementById('studentTasks').innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">👆 Selecteer een leerling hierboven om hun dashboard te bekijken</p>';
document.getElementById('dashboardTokenGrid').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om hun tokens te bekijken</p>';
document.getElementById('dashboardMilestones').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om hun mijlpalen te bekijken</p>';
document.getElementById('portfolioContent').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om portfolio te bekijken</p>'; // ← DEZE REGEL TOEVOEGEN
                    // Clear sidebar since no student is selected
                    updateSidebar();
                }
            }
        }

        // Tab switching for admin mode
        function switchTab(tabName) {
		// ← VOEG DEZE CONTROLE TOE AAN HET BEGIN
    if (tabName === 'reflection' && userRole !== 'teacher') {
        showNotification('Alleen leraren kunnen reflectiekaartjes beheren!', 'error');
        return;
    }
		
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

    event.target.classList.add('active');
    document.getElementById(tabName + '-tab').classList.add('active');
    
    // Render content based on active tab
    if (tabName === 'tasks') {
        renderTasksList();
    } else if (tabName === 'logbook') {
        renderLogbookContent();
    } else if (tabName === 'feedback') {
        renderFeedbackContent();
    } else if (tabName === 'presentation') {
        console.log('🎯 Switching to presentation tab');
        setTimeout(() => {
            if (typeof renderPresentationView === 'function') {
                console.log('📺 Calling renderPresentationView');
                renderPresentationView();
            } else {
                console.error('❌ renderPresentationView function not found');
            }
        }, 100);
    } else if (tabName === 'timeline') {
        updateTimelineFilter();
        renderTimelineContent();
    }
}

        // Student management
        function addStudent() {
            const nameInput = document.getElementById('newStudentName');
            const name = nameInput.value.trim();
            
            if (!name) {
                showNotification('Voer een naam in!', 'error');
                return;
            }

            if (students.find(s => s.name.toLowerCase() === name.toLowerCase())) {
                showNotification('Deze leerling bestaat al!', 'error');
                return;
            }

            const newPin = generateRandomPin();
            const newStudent = {
                id: generateId(),
                name: name,
                pin: newPin,
                tokens: [],
                skills: { zb: 0, zm: 0, sb: 0, rv: 0, vb: 0 },
                skillsAwarded: [],
                achievedMilestones: [],
                compliments: [],
                character: null,
                energyLevel: 3,
                lastActivity: new Date().toISOString(),
                completedTasks: [],
                personalGoals: []
            };

            students.push(newStudent);
            nameInput.value = '';
            
            addToTimeline(`👤 Nieuwe leerling toegevoegd: ${name} (PIN: ${newPin})`, newStudent.id);
            saveData();
            updateStatistics();
            renderStudentsList();
            updateDashboardStudentSelector();
            updateTimelineFilter();
            renderPinList();
            
            showNotification(`Leerling ${name} toegevoegd! PIN: ${newPin}`, 'success');
        }

        function selectDashboardStudent(studentId) {
            if (userRole === 'teacher') {
                // Teachers can select any student
                currentStudent = students.find(s => s.id === studentId);
                
                if (currentStudent) {
                    // Update dashboard title for teacher
                    document.getElementById('dashboardTitle').textContent = `🎯 ${currentStudent.name}'s Dashboard`;
                    
                    // Show sidebar when student is selected
                    document.getElementById('dashboardSidebar').classList.add('active');
                    
                    // Close any open sidebar view when switching students
                    closeSidebarView();
                    
                    // Update all student-related displays
                    updateSidebar();
                    updateDashboardTokenGrid();
                    updateDashboardMilestones();
					updatePortfolioSummary(); // ← DEZE REGEL TOEVOEGEN
                    renderStudentTasks();
                    
                    // Show success message
                    showNotification(`Bekijk nu ${currentStudent.name}'s dashboard`, 'success');
                }
            } else if (userRole === 'student') {
                // Students can only see their own data
                if (currentUser && currentUser.id === studentId) {
                    currentStudent = currentUser;
                    
                    // Keep student title simple
                    document.getElementById('dashboardTitle').textContent = `🎯 Mijn Dashboard`;
                    
                    // Show sidebar for student
                    document.getElementById('dashboardSidebar').classList.add('active');
                    
                    closeSidebarView();
                    updateSidebar();
                    updateDashboardTokenGrid();
                    updateDashboardMilestones();
                    renderStudentTasks();
                } else {
                    showNotification('Je kunt alleen je eigen gegevens bekijken!', 'error');
                    return;
                }
            }
        }

       // FIX: Verbeterde updateDashboardStudentSelector functie die selectie bewaart
function updateDashboardStudentSelector() {
    const selector = document.getElementById('dashboardStudentSelector');
    
    if (userRole === 'teacher') {
        // 🔧 BEWAAR huidige selectie
        const currentSelection = selector.value;
        console.log('💾 Preserving selection:', currentSelection);
        
        // Teachers see all students
        selector.innerHTML = '<option value="">Selecteer een leerling...</option>' +
            students.map(student => 
                `<option value="${student.id}">${student.name}</option>`
            ).join('');
        
        // 🔧 HERSTEL de selectie NA het vullen van de dropdown
        if (currentSelection) {
            selector.value = currentSelection;
            console.log('✅ Selection restored:', currentSelection);
        }
        
        // Remove any existing listeners
        const newSelector = selector.cloneNode(true);
        selector.parentNode.replaceChild(newSelector, selector);
        
        // 🔧 HERSTEL selectie OPNIEUW na cloning
        if (currentSelection) {
            newSelector.value = currentSelection;
            console.log('✅ Selection restored after cloning:', currentSelection);
        }
        
        // Add new listener
        newSelector.addEventListener('change', function() {
            if (this.value) {
                selectDashboardStudent(this.value);
            } else {
                // Reset when no student selected
                currentStudent = null;
                document.getElementById('dashboardTitle').textContent = `🎯 Student Dashboard`;
                
                // Hide sidebar when no student is selected
                document.getElementById('dashboardSidebar').classList.remove('active');
                
                // Clear interface
                updateSidebar();
                updateDashboardTokenGrid();
                updateDashboardMilestones();
                renderStudentTasks();
                
                // Show placeholder messages
                document.getElementById('studentTasks').innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">👆 Selecteer een leerling hierboven om hun dashboard te bekijken</p>';
                document.getElementById('dashboardTokenGrid').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om hun tokens te bekijken</p>';
                document.getElementById('dashboardMilestones').innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om hun mijlpalen te bekijken</p>';
            }
        });
    } else {
        // Students don't see the selector
        document.getElementById('teacherStudentSelector').style.display = 'none';
    }
}


        function updateSidebar() {
            if (!currentStudent) {
                // Hide all sidebar sections when no student is selected
                document.getElementById('studentProfile').style.display = 'none';
                document.getElementById('sidebarTokens').style.display = 'none';
                document.getElementById('energySection').style.display = 'none';
                document.getElementById('skillsSection').style.display = 'none';
                document.getElementById('milestonesSection').style.display = 'none';
                document.getElementById('tasksSection').style.display = 'none';
                return;
            }

            // Show all sections when student is selected
            document.getElementById('studentProfile').style.display = 'block';
            document.getElementById('sidebarTokens').style.display = 'block';
            document.getElementById('energySection').style.display = 'block';
            document.getElementById('skillsSection').style.display = 'block';
            document.getElementById('milestonesSection').style.display = 'block';
            document.getElementById('tasksSection').style.display = 'block';

            // Update profile
            document.getElementById('studentName').textContent = currentStudent.name;
            document.getElementById('studentTitle').textContent = 'Leerling';
            
            // Update avatar
            const avatar = document.getElementById('studentAvatar');
            if (currentStudent.character && currentStudent.character.length < 5 * 1024 * 1024) {
                avatar.src = currentStudent.character;
            } else {
                avatar.src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='60' height='60'><rect width='60' height='60' fill='%23ddd' rx='30'/><text x='50%' y='50%' text-anchor='middle' dy='.3em' font-size='24'>👤</text></svg>";
            }

            // Update sections
            updateSidebarTokens();
            updateEnergyDisplay();
            updateSkillBars();
            updateSidebarMilestones();
            updateSidebarTasks();
        }

        function updateSidebarTasks() {
            const container = document.getElementById('sidebarTasks');
            
            if (!currentStudent) return;

            const studentTasks = tasks.filter(task => 
                task.assignedStudents.includes(currentStudent.id)
            ).slice(0, 5); // Show max 5 tasks

            if (studentTasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.8rem;">Geen taken toegewezen</p>';
                return;
            }

            container.innerHTML = studentTasks.map(task => {
                const isCompleted = currentStudent.completedTasks.includes(task.id);
                const isOverdue = new Date(task.date) < new Date() && !isCompleted;
                
                return `
                    <div class="task-mini ${isCompleted ? 'completed' : ''}" onclick="completeTaskFromSidebar('${task.id}')" title="${task.goal || 'Geen doel'}">
                        <div class="task-status">
                            ${isCompleted ? '✅' : (isOverdue ? '⚠️' : '📋')}
                        </div>
                        <div class="task-info">
                            <div class="task-name">${task.title}</div>
                            <div class="task-subject">${task.subject} - ${new Date(task.date).toLocaleDateString('nl-NL')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function completeTaskFromSidebar(taskId) {
            if (!currentStudent) return;
            
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            if (currentStudent.completedTasks.includes(taskId)) {
                showNotification('Taak al voltooid!', 'warning');
                return;
            }

            completeTask(taskId, currentStudent.id);
        }

       // NOODFIX 1: Werkende updateSidebarTokens functie
function updateSidebarTokens() {
    const tokenRows = document.getElementById('tokenRows');
    const tokenCount = document.getElementById('tokenCount');
    
    console.log('🎨 updateSidebarTokens called');
    
    if (!currentStudent) {
        console.log('❌ No current student');
        return;
    }

    if (!tokenRows) {
        console.log('❌ tokenRows element not found');
        return;
    }

    const allTokens = currentStudent.tokens || [];
    const tokens = allTokens.slice(-10);
    
    console.log(`🎨 Tokens: ${allTokens.length} total`);
    
    if (tokenCount) {
        tokenCount.textContent = `${allTokens.length}`;
    }

    // ✅ BELANGRIJKE FIX: Declareer rows variabele
    const rows = [];
    
    if (tokens.length === 0) {
        rows.push('<div class="token-row"><div class="sidebar-token empty">+</div><div class="sidebar-token empty">+</div><div class="sidebar-token empty">+</div></div>');
        rows.push('<div class="token-row"><div class="sidebar-token empty">+</div><div class="sidebar-token empty">+</div><div class="sidebar-token empty">+</div></div>');
        rows.push('<div class="token-row"><div class="sidebar-token empty">+</div><div class="sidebar-token empty">+</div><div class="sidebar-token empty">+</div></div>');
        rows.push('<div class="token-row shield-center"><div class="sidebar-token empty">+</div></div>');
    } else {
        const positions = [[0,1,2],[3,4,5],[6,7,8],[9]];
        positions.forEach((rowPositions, rowIndex) => {
            const rowTokens = [];
            const isLastRow = rowIndex === 3;
            
            rowPositions.forEach(pos => {
                if (pos < tokens.length) {
                    const token = tokens[pos];
                    const tokenType = tokenTypes.find(t => t.id === token.type);
                    rowTokens.push(`<div class="sidebar-token" style="background: ${tokenType?.color || '#ddd'};" title="${tokenType?.name || 'Token'}">${tokenType?.emoji || '?'}</div>`);
                } else {
                    rowTokens.push('<div class="sidebar-token empty">+</div>');
                }
            });
            
            const rowClass = isLastRow ? 'token-row shield-center' : 'token-row';
            rows.push(`<div class="${rowClass}">${rowTokens.join('')}</div>`);
        });
    }

    tokenRows.innerHTML = rows.join('');
    console.log('✅ Tokens updated');
}


function debugTokenState() {
    console.log('🔍 TOKEN DEBUG STATE:');
    console.log('Current Student:', currentStudent?.name || 'None');
    
    if (currentStudent) {
        console.log('Total Tokens:', currentStudent.tokens?.length || 0);
        console.log('Token Details:', currentStudent.tokens || []);
        
        const tokenRows = document.getElementById('tokenRows');
        const tokenCount = document.getElementById('tokenCount');
        
        console.log('Elements exist:', {
            tokenRows: !!tokenRows,
            tokenCount: !!tokenCount
        });
        
        if (tokenCount) {
            console.log('Current token count display:', tokenCount.textContent);
        }
    }
    
    // Force manual update
    console.log('🧪 Testing manual token update...');
    updateSidebarTokens();
}

// FIX 5: Check of student tokens array goed wordt bijgewerkt
function verifyTokenAddition(tokenType, studentId) {
    const student = students.find(s => s.id === studentId);
    if (student) {
        console.log('🔍 Verifying token addition:');
        console.log('Student tokens before:', student.tokens?.length || 0);
        
        // Return a function to check after
        return () => {
            console.log('Student tokens after:', student.tokens?.length || 0);
            console.log('Last token:', student.tokens?.slice(-1)[0]);
        };
    }
    return () => {};
}

        function updateEnergyDisplay() {
            if (!currentStudent) return;

            const level = currentStudent.energyLevel || 3;
            const energyEmojis = ['😴', '😞', '😐', '🙂', '😊', '🚀'];
            const energyTexts = ['Uitgeput', 'Moe', 'Laag', 'Normaal', 'Goed', 'Top'];

            document.getElementById('energyLevel').textContent = energyEmojis[level] || '😐';
            document.getElementById('energyText').textContent = `${energyTexts[level] || 'Normaal'} (${level})`;
        }

        function cycleEnergyLevel() {
            if (!currentStudent) return;
            
            currentStudent.energyLevel = ((currentStudent.energyLevel || 3) % 5) + 1;
            updateEnergyDisplay();
            saveData();
            
            addToTimeline(`⚡ Energie niveau aangepast naar ${currentStudent.energyLevel}`, currentStudent.id);
        }

      // FIX 1: Verbeterde updateSkillBars functie met meer robuuste error handling
function updateSkillBars() {
    if (!currentStudent) {
        console.log('⚠️ updateSkillBars: No current student selected');
        return;
    }

    const skills = currentStudent.skills || {};
    console.log('🎯 Updating skill bars for:', currentStudent.name, skills);
    
    Object.keys(skillDefinitions).forEach(skillCode => {
        const element = document.getElementById(`skill-${skillCode}`);
        const percentElement = document.getElementById(`skill-${skillCode}-percent`);
        
        if (element && percentElement) {
            const totalValue = Math.round(skills[skillCode]) || 0;
            const level = Math.floor(totalValue / 100);
            const progress = totalValue % 100;
            
            // Force reflow before animation
            element.style.transition = 'none';
            element.style.width = '0%';
            element.offsetHeight; // Force reflow
            
            // Apply new values with animation
            element.style.transition = 'width 0.8s ease-in-out';
            element.style.width = `${progress}%`;
            
            // Show progress within current level + level indicator
            if (level > 0) {
                percentElement.innerHTML = `<strong>Lv${level}</strong> ${progress}%`;
                percentElement.style.color = '#ffd700';
                percentElement.style.fontWeight = 'bold';
            } else {
                percentElement.textContent = `${progress}%`;
                percentElement.style.color = '';
                percentElement.style.fontWeight = '';
            }
            
            // Extra glow effect for leveled skills
            if (level > 0) {
                element.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.6)';
                setTimeout(() => {
                    element.style.boxShadow = '0 0 8px rgba(255, 215, 0, 0.3)';
                }, 1200);
            } else {
                element.style.boxShadow = '0 0 10px rgba(255, 255, 255, 0.5)';
                setTimeout(() => {
                    element.style.boxShadow = '';
                }, 800);
            }
            
            console.log(`✅ Updated ${skillCode}: ${totalValue} (Lv${level} ${progress}%)`);
        } else {
            console.log(`❌ Elements not found for skill: ${skillCode}`);
        }
    });
}
function debugSkillBars() {
    console.log('🔍 DEBUGGING SKILL BARS:');
    console.log('Current Student:', currentStudent?.name || 'None');
    
    if (currentStudent) {
        console.log('Skills:', currentStudent.skills);
        Object.keys(skillDefinitions).forEach(skillCode => {
            const element = document.getElementById(`skill-${skillCode}`);
            const skillValue = currentStudent.skills[skillCode] || 0;
            console.log(`${skillCode}: ${skillValue}% - Element exists: ${!!element}`);
        });
    }
    
    updateSkillBars();
}
        function updateSidebarMilestones() {
            const container = document.getElementById('sidebarMilestones');
            
            if (!currentStudent) {
                container.innerHTML = '';
                return;
            }

            const achieved = currentStudent.achievedMilestones || [];
            
            if (achieved.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.8rem;">Nog geen mijlpalen</p>';
                return;
            }

            const sortedMilestones = achieved.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedMilestones.map(milestone => `
                <div class="milestone-mini">
                    <div class="milestone-badge">${milestone.badge}</div>
                    <div class="milestone-info">
                        <div class="milestone-name">${milestone.milestoneName}</div>
                        <div class="milestone-level">Level ${milestone.level}</div>
                    </div>
                </div>
            `).join('');
        }

        // Task management
        function showTaskForm(taskId = null) {
            editingTaskId = taskId;
            const modal = document.getElementById('taskModal');
            const title = document.getElementById('taskModalTitle');
            
            if (taskId) {
                // Edit mode
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    title.textContent = 'Taak Bewerken';
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskSubject').value = task.subject;
                    document.getElementById('taskGoal').value = task.goal || '';
                    document.getElementById('taskPages').value = task.pages || '';
                    document.getElementById('taskTime').value = task.time || '';
                    document.getElementById('taskDate').value = task.date;
                    document.getElementById('taskType').value = task.type;
                }
            } else {
                // New mode
                title.textContent = 'Nieuwe Taak';
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskSubject').value = 'Wiskunde';
                document.getElementById('taskGoal').value = '';
                document.getElementById('taskPages').value = '';
                document.getElementById('taskTime').value = '';
                document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('taskType').value = 'daily';
            }
            
            // Update student assignment checkboxes
            updateTaskStudentAssignment(taskId);
            
            modal.classList.add('show');
        }

        function updateTaskStudentAssignment(taskId) {
            const container = document.getElementById('taskStudentAssignment');
            const task = taskId ? tasks.find(t => t.id === taskId) : null;
            const assignedStudents = task ? task.assignedStudents : [];
            
            container.innerHTML = students.map(student => `
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer;">
                    <input type="checkbox" ${assignedStudents.includes(student.id) ? 'checked' : ''} 
                           onchange="toggleStudentAssignment('${student.id}')" 
                           id="student-${student.id}">
                    <span>${student.name}</span>
                </label>
            `).join('');
        }

        let tempAssignedStudents = [];

        function toggleStudentAssignment(studentId) {
            const checkbox = document.getElementById(`student-${studentId}`);
            if (checkbox.checked) {
                if (!tempAssignedStudents.includes(studentId)) {
                    tempAssignedStudents.push(studentId);
                }
            } else {
                tempAssignedStudents = tempAssignedStudents.filter(id => id !== studentId);
            }
        }

        function saveTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const subject = document.getElementById('taskSubject').value;
            const goal = document.getElementById('taskGoal').value.trim();
            const pages = document.getElementById('taskPages').value.trim();
            const time = document.getElementById('taskTime').value;
            const date = document.getElementById('taskDate').value;
            const type = document.getElementById('taskType').value;
            
            if (!title || !subject || !date) {
                showNotification('Vul alle verplichte velden in!', 'error');
                return;
            }

            // Get selected students
            const assignedStudents = Array.from(document.querySelectorAll('#taskStudentAssignment input[type="checkbox"]:checked'))
                .map(cb => cb.id.replace('student-', ''));

            const taskData = {
                title, subject, goal, pages, time, date, type,
                assignedStudents: assignedStudents,
                completed: false
            };

            if (editingTaskId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
                if (taskIndex > -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], ...taskData };
                    addToTimeline(`📝 Taak bijgewerkt: ${title}`, null);
                }
            } else {
                // Create new task
                const newTask = {
                    id: generateId(),
                    ...taskData,
                    createdAt: new Date().toISOString()
                };
                tasks.push(newTask);
                addToTimeline(`📝 Nieuwe taak aangemaakt: ${title}`, null);
            }

            closeTaskModal();
            renderTasksList();
            saveData();
            updateStatistics();
            
            showNotification(editingTaskId ? 'Taak bijgewerkt!' : 'Taak aangemaakt!', 'success');
            editingTaskId = null;
            tempAssignedStudents = [];
        }
		
// Student Task Management Functions
function showStudentTaskForm() {
    if (!currentStudent) {
        showNotification('Fout: Geen student ingelogd!', 'error');
        return;
    }
    
    document.getElementById('studentTaskModalTitle').textContent = '📋 Mijn Taak Inplannen';
    document.getElementById('studentTaskTitle').value = '';
    document.getElementById('studentTaskSubject').value = 'Wiskunde';
    document.getElementById('studentTaskGoal').value = '';
    document.getElementById('studentTaskPages').value = '';
    document.getElementById('studentTaskDuration').value = '30';
    document.getElementById('studentTaskTime').value = '';
    
    // Set default date to today
    document.getElementById('studentTaskDate').value = new Date().toISOString().split('T')[0];
    
    document.getElementById('studentTaskModal').classList.add('show');
    document.getElementById('studentTaskTitle').focus();
}

function closeStudentTaskModal() {
    document.getElementById('studentTaskModal').classList.remove('show');
    editingTaskId = null;
}

function saveStudentTask() {
    if (!currentStudent) {
        showNotification('Fout: Geen student ingelogd!', 'error');
        return;
    }
    
    const title = document.getElementById('studentTaskTitle').value.trim();
    const subject = document.getElementById('studentTaskSubject').value;
    const goal = document.getElementById('studentTaskGoal').value.trim();
    const pages = document.getElementById('studentTaskPages').value.trim();
    const duration = document.getElementById('studentTaskDuration').value;
    const time = document.getElementById('studentTaskTime').value;
    const date = document.getElementById('studentTaskDate').value;
    
    if (!title || !date) {
        showNotification('Vul minimaal een titel en datum in!', 'error');
        return;
    }

    if (editingTaskId) {
        // Edit existing task
        const taskIndex = tasks.findIndex(t => t.id === editingTaskId);
        if (taskIndex > -1) {
            const task = tasks[taskIndex];
            
            // Check if this is the student's own task
            if (task.createdBy !== currentStudent.id) {
                showNotification('Je kunt alleen je eigen taken bewerken!', 'error');
                return;
            }
            
            // Update task
            tasks[taskIndex] = {
                ...task,
                title: title,
                subject: subject,
                goal: goal || `Zelfgeplande ${subject} activiteit`,
                pages: pages,
                time: time,
                date: date,
                duration: parseInt(duration),
                updatedAt: new Date().toISOString()
            };
            
            addToTimeline(`📝 Eigen taak bijgewerkt: "${title}" (${duration} min)`, currentStudent.id);
            showNotification(`Taak "${title}" bijgewerkt!`, 'success');
        }
        
        editingTaskId = null;
    } else {
        // Create new task
        const studentTask = {
            id: generateId(),
            title: title,
            subject: subject,
            goal: goal || `Zelfgeplande ${subject} activiteit`,
            pages: pages,
            time: time,
            date: date,
            duration: parseInt(duration),
            type: 'self_planned',
            assignedStudents: [currentStudent.id],
            createdBy: currentStudent.id,
            createdByStudent: true,
            completed: false,
            createdAt: new Date().toISOString()
        };

        tasks.push(studentTask);
        
        // Award skill points for self-planning (initiative and self-management)
        const planningBonus = {
            zb: 5,  // Self-awareness - knowing what you need to study
            zm: 8,  // Self-management - planning your own work
            vb: 3   // Responsible decision-making - taking initiative
        };
        
        let milestonesAchieved = [];
        let skillIncreases = [];
        
        Object.keys(planningBonus).forEach(skillCode => {
            const increase = planningBonus[skillCode];
            const oldValue = currentStudent.skills[skillCode] || 0;
            let newValue = oldValue + increase;
            
            skillIncreases.push(`+${increase}% ${skillDefinitions[skillCode].name}`);
            
            if (newValue >= 100 && oldValue < 100) {
                const milestone = milestones.find(m => m.skill === skillCode);
                if (milestone) {
                    const achievedMilestone = {
                        id: generateId(),
                        milestoneId: milestone.id,
                        milestoneName: milestone.name,
                        skillName: skillDefinitions[skillCode].name,
                        badge: milestone.badge,
                        timestamp: new Date().toISOString(),
                        level: getNextMilestoneLevel(currentStudent, skillCode)
                    };

                    currentStudent.achievedMilestones = currentStudent.achievedMilestones || [];
                    currentStudent.achievedMilestones.push(achievedMilestone);
                    milestonesAchieved.push(achievedMilestone);
                    
                    addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, currentStudent.id);
                }
                
                newValue = newValue - 100;
            }
            
            currentStudent.skills[skillCode] = newValue;
        });
        
        // Award planning token (expliciet gekoppeld aan taak voor mogelijke terugdraaing)
        const planningToken = {
            id: generateId(),
            type: 'star', // Star for self-direction
            source: 'self_planning',
            taskId: studentTask.id, // ✨ Belangrijke koppeling voor terugdraaing
            timestamp: new Date().toISOString()
        };
        
        currentStudent.tokens = currentStudent.tokens || [];
        currentStudent.tokens.push(planningToken);
        
        addToTimeline(`📋 Eigen taak ingepland: "${title}" (${duration} min) - ${skillIncreases.join(', ')} +Token!`, currentStudent.id);
        
        // Show notifications
        if (milestonesAchieved.length > 0) {
            milestonesAchieved.forEach(milestone => {
                setTimeout(() => showMilestoneNotification(milestone), 500);
            });
        } else {
            showNotification(`Taak "${title}" ingepland! +Token en vaardigheden verhoogd voor zelfstandigheid!`, 'success');
        }
    }
    
    // ✨ KRITIEKE FIX: Synchroniseer currentStudent met students array VOOR het opslaan
    const studentIndex = students.findIndex(s => s.id === currentStudent.id);
    if (studentIndex > -1) {
        students[studentIndex] = currentStudent;
        console.log('✅ Student data gesynchroniseerd in students array');
    } else {
        console.error('❌ Kon student niet vinden in array voor synchronisatie');
    }
    
    closeStudentTaskModal();
    saveData();
    updateStatistics();
    updateSidebar();
    renderStudentTasks();
    updatePortfolioSummary();
}
        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('show');
            editingTaskId = null;
            tempAssignedStudents = [];
        }

        function deleteTask(taskId) {
            if (confirm('Weet je zeker dat je deze taak wilt verwijderen?')) {
                const task = tasks.find(t => t.id === taskId);
                tasks = tasks.filter(t => t.id !== taskId);
                
                // Clean up related data
                logbookEntries = logbookEntries.filter(entry => entry.taskId !== taskId);
                feedbackEntries = feedbackEntries.filter(entry => entry.taskId !== taskId);
                personalGoals = personalGoals.filter(goal => goal.taskId !== taskId);
                
                // Remove from completed tasks
                students.forEach(student => {
                    student.completedTasks = student.completedTasks.filter(id => id !== taskId);
                });
                
                addToTimeline(`🗑️ Taak verwijderd: ${task ? task.title : 'Onbekende taak'}`, null);
                renderTasksList();
                saveData();
                updateStatistics();
                showNotification('Taak verwijderd!', 'success');
            }
        }
function editStudentTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task || !currentStudent) return;

    // Check if this is the student's own task
    if (task.createdBy !== currentStudent.id) {
        showNotification('Je kunt alleen je eigen ingeplande taken bewerken!', 'error');
        return;
    }

    // Pre-fill the student task form with existing data
    document.getElementById('studentTaskTitle').value = task.title;
    document.getElementById('studentTaskSubject').value = task.subject;
    document.getElementById('studentTaskGoal').value = task.goal || '';
    document.getElementById('studentTaskPages').value = task.pages || '';
    document.getElementById('studentTaskDuration').value = task.duration || '30';
    document.getElementById('studentTaskTime').value = task.time || '';
    document.getElementById('studentTaskDate').value = task.date;

    // Set editing mode
    editingTaskId = taskId;
    document.getElementById('studentTaskModalTitle').textContent = '✏️ Mijn Taak Bewerken';
    
    // Show modal
    document.getElementById('studentTaskModal').classList.add('show');
    document.getElementById('studentTaskTitle').focus();
}

function deleteStudentTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const student = students.find(s => s.id === task.createdBy);
    const studentName = student ? student.name : 'Onbekende leerling';

    if (confirm(`🚨 LEERLING TAAK AFWIJZEN\n\nWeet je zeker dat je de taak "${task.title}" van ${studentName} wilt afwijzen en verwijderen?\n\nDeze actie:\n✅ Verwijdert de taak permanent\n✅ Draait alle beloningen terug (tokens, vaardigheden, mijlpalen)\n✅ Wordt gelogd in de tijdlijn\n\nDe leerling kan altijd een nieuwe, verbeterde taak inplannen.`)) {
        
        // ✨ NIEUWE FUNCTIONALITEIT: Draai beloningen terug
        if (student && task.type === 'self_planned' && task.createdByStudent) {
            console.log(`🔄 Draaiing beloningen terug voor taak: ${task.title}`);
            
            // 1. Verwijder tokens die specifiek aan deze taak gekoppeld zijn
            const originalTokenCount = student.tokens?.length || 0;
            student.tokens = (student.tokens || []).filter(token => 
                !(token.source === 'self_planning' && token.taskId === taskId) &&
                !(token.source === 'task_completion' && token.taskId === taskId)
            );
            const tokensRemoved = originalTokenCount - (student.tokens?.length || 0);
            
            // 2. Draai skill increases terug (planning bonus)
            const planningBonus = { zb: 5, zm: 8, vb: 3 };
            let skillDecreases = [];
            let milestonesReverted = [];
            
            Object.keys(planningBonus).forEach(skillCode => {
                const decrease = planningBonus[skillCode];
                const currentValue = student.skills[skillCode] || 0;
                let newValue = Math.max(0, currentValue - decrease); // Kan niet onder 0
                
                skillDecreases.push(`-${decrease}% ${skillDefinitions[skillCode].name}`);
                
                // Check of mijlpalen ongedaan gemaakt moeten worden
                // Als de huidige waarde + mogelijke level-overflow was > 100 en nieuwe waarde < 100
                const totalCurrentValue = currentValue + (Math.floor((student.skills[skillCode] || 0) / 100) * 100);
                if (totalCurrentValue >= 100 && newValue < 100) {
                    // Zoek recente mijlpaal voor deze skill die mogelijk ongedaan gemaakt moet worden
                    const recentMilestone = student.achievedMilestones?.find(am => {
                        const milestone = milestones.find(m => m.id === am.milestoneId);
                        return milestone && milestone.skill === skillCode && 
                               new Date(am.timestamp) > new Date(task.createdAt); // Alleen mijlpalen na taak-creatie
                    });
                    
                    if (recentMilestone) {
                        student.achievedMilestones = student.achievedMilestones.filter(am => am.id !== recentMilestone.id);
                        milestonesReverted.push(recentMilestone);
                        console.log(`🏆❌ Mijlpaal teruggedraaid: ${recentMilestone.milestoneName}`);
                    }
                }
                
                student.skills[skillCode] = newValue;
            });
            
            // 3. Update timeline met specifieke details
            const revertDetails = [];
            if (tokensRemoved > 0) revertDetails.push(`${tokensRemoved} token(s)`);
            if (skillDecreases.length > 0) revertDetails.push(skillDecreases.join(', '));
            if (milestonesReverted.length > 0) revertDetails.push(`${milestonesReverted.length} mijlpaal/mijlpalen`);
            
            addToTimeline(`🔄 Beloningen teruggedraaid voor afgewezen taak "${task.title}": ${revertDetails.join(' + ')}`, student.id);
            
            // Log voor debugging
            console.log(`✅ Beloningen succesvol teruggedraaid:`, {
                tokensRemoved,
                skillDecreases,
                milestonesReverted: milestonesReverted.length
            });
        }
        
        // Remove task from tasks array
        tasks = tasks.filter(t => t.id !== taskId);
        
        // Clean up related data
        logbookEntries = logbookEntries.filter(entry => entry.taskId !== taskId);
        feedbackEntries = feedbackEntries.filter(entry => entry.taskId !== taskId);
        personalGoals = personalGoals.filter(goal => goal.taskId !== taskId);
        
        // Remove from completed tasks (if applicable)
        students.forEach(s => {
            s.completedTasks = s.completedTasks.filter(id => id !== taskId);
        });
        
        addToTimeline(`❌ Leerling taak afgewezen: "${task.title}" van ${studentName}`, task.createdBy);
        
        renderTasksList();
        renderStudentTasks();
        saveData();
        updateStatistics();
        
        // Update UI als deze student momenteel bekeken wordt
        if (currentStudent && currentStudent.id === student?.id) {
            updateSidebar();
            updateDashboardTokenGrid();
            updateDashboardMilestones();
            updatePortfolioSummary();
        }
        
        showNotification(`Taak "${task.title}" van ${studentName} is afgewezen en alle beloningen zijn teruggedraaid`, 'warning');
    }
}

function reviewStudentTask(taskId) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const student = students.find(s => s.id === task.createdBy);
    const studentName = student ? student.name : 'Onbekende leerling';

    // Create review modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <h3>👁️ Leerling Taak Beoordelen</h3>
            
            <div style="background: linear-gradient(135deg, #faf5ff, #f3e8ff); padding: 20px; border-radius: 12px; border-left: 4px solid #9333ea; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <div style="background: #9333ea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;">
                        🎯 LEERLING TAAK
                    </div>
                    <strong>door ${studentName}</strong>
                </div>
                
                <h4 style="color: #9333ea; margin-bottom: 10px;">${task.title}</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <div><strong>📚 Vak:</strong> ${task.subject}</div>
                    <div><strong>📅 Datum:</strong> ${new Date(task.date).toLocaleDateString('nl-NL')}</div>
                    <div><strong>⏱️ Tijd:</strong> ${task.duration || 'Niet opgegeven'} min</div>
                    <div><strong>⏰ Tijdstip:</strong> ${task.time || 'Niet opgegeven'}</div>
                </div>
                
                ${task.goal ? `<div style="margin-bottom: 10px;"><strong>🎯 Doel:</strong> ${task.goal}</div>` : ''}
                ${task.pages ? `<div style="margin-bottom: 10px;"><strong>📖 Materiaal:</strong> ${task.pages}</div>` : ''}
                
                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 8px; font-size: 0.9rem;">
                    <strong>💡 Zelfstandigheid Bonus:</strong> Deze leerling heeft initiatief getoond door zelf een studie-activiteit in te plannen!
                </div>
            </div>
            
            <div style="background: #f0f9ff; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h4 style="color: #667eea; margin-bottom: 15px;">📝 Beoordeling Opties</h4>
                
                <div style="display: grid; gap: 15px;">
                    <button class="btn btn-success" onclick="approveStudentTask('${taskId}', this.closest('.modal'))" 
                            style="padding: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">✅</span>
                        <div style="text-align: left;">
                            <div><strong>Goedkeuren</strong></div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Taak blijft bestaan, student behoudt alle beloningen</div>
                        </div>
                    </button>
                    
                    <button class="btn btn-info" onclick="editStudentTaskFromReview('${taskId}', this.closest('.modal'))" 
                            style="padding: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">✏️</span>
                        <div style="text-align: left;">
                            <div><strong>Bewerken</strong></div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Pas de taak aan (tijd, doel, beschrijving, etc.)</div>
                        </div>
                    </button>
                    
                    <button class="btn btn-warning" onclick="giveFeedbackOnStudentTask('${taskId}', this.closest('.modal'))" 
                            style="padding: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">💬</span>
                        <div style="text-align: left;">
                            <div><strong>Feedback Geven</strong></div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Geef persoonlijke feedback op de planning</div>
                        </div>
                    </button>
                    
                    <button class="btn btn-danger" onclick="deleteStudentTask('${taskId}'); this.closest('.modal').remove()" 
                            style="padding: 15px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">❌</span>
                        <div style="text-align: left;">
                            <div><strong>Afwijzen</strong></div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">Taak verwijderen (geen beloningen)</div>
                        </div>
                    </button>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn" onclick="this.closest('.modal').remove()" 
                        style="background: #666; color: white; padding: 10px 20px;">
                    Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function approveStudentTask(taskId, modal) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const student = students.find(s => s.id === task.createdBy);
    const studentName = student ? student.name : 'Onbekende leerling';

    // Mark task as approved
    task.approved = true;
    task.approvedAt = new Date().toISOString();
    
    addToTimeline(`✅ Leerling taak goedgekeurd: "${task.title}" van ${studentName}`, task.createdBy);
    
    if (modal) modal.remove();
    
    renderTasksList();
    saveData();
    
    showNotification(`Taak "${task.title}" van ${studentName} is goedgekeurd!`, 'success');
}

function editStudentTaskFromReview(taskId, modal) {
    if (modal) modal.remove();
    showTaskForm(taskId); // Use existing task form for editing
}

function giveFeedbackOnStudentTask(taskId, modal) {
    const task = tasks.find(t => t.id === taskId);
    if (!task) return;

    const student = students.find(s => s.id === task.createdBy);
    if (!student) return;

    if (modal) modal.remove();
    showFeedbackModal(taskId, student.id);
}
        function renderTasksList() {
    const container = document.getElementById('tasksList');
    
    if (tasks.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nog geen taken aangemaakt</p>';
        return;
    }

    container.innerHTML = tasks.map(task => {
        const assignedStudentNames = task.assignedStudents.map(id => {
            const student = students.find(s => s.id === id);
            return student ? student.name : 'Onbekende leerling';
        }).join(', ');

        const completionCount = task.assignedStudents.filter(studentId => {
            const student = students.find(s => s.id === studentId);
            return student && student.completedTasks.includes(task.id);
        }).length;

        const completionRate = task.assignedStudents.length > 0 
            ? Math.round((completionCount / task.assignedStudents.length) * 100) 
            : 0;

        const isOverdue = new Date(task.date) < new Date() && completionRate < 100;
        const isSelfPlanned = task.type === 'self_planned' && task.createdByStudent;
        const creator = isSelfPlanned ? students.find(s => s.id === task.createdBy) : null;

        return `
            <div class="task-card ${completionRate === 100 ? 'completed' : ''}" style="${isSelfPlanned ? 'border-left: 4px solid #9333ea; background: linear-gradient(135deg, #faf5ff, #f3e8ff);' : ''}">
                ${isSelfPlanned ? `
                    <div style="background: #9333ea; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; margin-bottom: 12px; display: inline-block;">
                        🎯 LEERLING TAAK${creator ? ` - ${creator.name}` : ''}
                    </div>
                ` : ''}
                <div class="task-header">
                    <div>
                        <div class="task-title">${task.title} ${isOverdue ? '⚠️' : ''}</div>
                        <div class="task-meta">
                            <span>📚 ${task.subject}</span>
                            <span>📅 ${new Date(task.date).toLocaleDateString('nl-NL')}</span>
                            <span>⏰ ${task.time || 'Geen tijd'}</span>
                            <span>🏷️ ${task.type === 'daily' ? 'Dag taak' : task.type === 'weekly' ? 'Week taak' : 'Eigen planning'}</span>
                            ${task.duration ? `<span>⏱️ ${task.duration} min</span>` : ''}
                        </div>
                        ${task.goal ? `<div style="margin-top: 8px; color: #666;"><strong>Doel:</strong> ${task.goal}</div>` : ''}
                        ${task.pages ? `<div style="color: #666;"><strong>Pagina's:</strong> ${task.pages}</div>` : ''}
                        <div style="margin-top: 8px; color: #666;">
                            <strong>Toegewezen aan:</strong> ${assignedStudentNames || 'Niemand'}
                        </div>
                        <div style="margin-top: 8px;">
                            <span style="display: inline-block; background: ${completionRate === 100 ? '#48bb78' : (completionRate > 0 ? '#ed8936' : '#e2e8f0')}; color: ${completionRate === 0 ? '#666' : 'white'}; padding: 4px 12px; border-radius: 15px; font-size: 0.85rem; font-weight: 600;">
                                ${completionRate}% voltooid (${completionCount}/${task.assignedStudents.length})
                            </span>
                        </div>
                        ${isSelfPlanned ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(147, 51, 234, 0.1); border-radius: 8px; font-size: 0.9rem;">
                                <strong style="color: #9333ea;">💡 Door leerling ingepland:</strong> 
                                Zelfstandig georganiseerde studie-activiteit
                            </div>
                        ` : ''}
                    </div>
                    <div class="task-actions">
                        ${isSelfPlanned ? `
                            <button class="btn btn-warning btn-small" onclick="reviewStudentTask('${task.id}')" title="Beoordelen" style="background: #9333ea; border-color: #9333ea;">👁️ Beoordeel</button>
                            <button class="btn btn-danger btn-small" onclick="deleteStudentTask('${task.id}')" title="Afwijzen en verwijderen" style="background: #dc2626;">❌ Afwijzen</button>
                        ` : `
                            <button class="btn btn-info btn-small" onclick="showTaskForm('${task.id}')" title="Bewerken">✏️</button>
                            <button class="btn btn-success btn-small" onclick="viewTaskDetails('${task.id}')" title="Bekijken">👁️</button>
                            <button class="btn btn-danger btn-small" onclick="deleteTask('${task.id}')" title="Verwijderen">🗑️</button>
                        `}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
function renderStudentTasks() {
    const container = document.getElementById('studentTasks');
    
    if (!currentStudent) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om taken te bekijken</p>';
        return;
    }

    const studentTasks = tasks.filter(task => 
        task.assignedStudents.includes(currentStudent.id)
    );

    // Taak-planning knop (altijd tonen)
    const planningSection = `
        <div style="text-align: center; margin-bottom: 1.5rem; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px;">
            <h4 style="color: white; margin-bottom: 10px;">📋 Mijn Takenplanning</h4>
            <button class="btn btn-success" onclick="showStudentTaskForm()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; font-weight: bold;">
                ➕ Eigen Taak Inplannen
            </button>
            <p style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 8px;">
                Plan je eigen studie-activiteiten en verdien extra vaardigheidspunten!
            </p>
        </div>
    `;

    if (studentTasks.length === 0) {
        container.innerHTML = planningSection + '<p style="text-align: center; color: #666; padding: 2rem;">Geen taken toegewezen</p>';
        return;
    }

    // Bouw de taken lijst
    const tasksHtml = studentTasks.map(task => {
        const isCompleted = currentStudent.completedTasks.includes(task.id);
        const isOverdue = new Date(task.date) < new Date() && !isCompleted;
        const hasLogbook = logbookEntries.some(entry => 
            entry.taskId === task.id && entry.studentId === currentStudent.id
        );
        const hasFeedback = feedbackEntries.some(entry => 
            entry.taskId === task.id && entry.studentId === currentStudent.id
        );
        const personalGoal = personalGoals.find(goal => 
            goal.taskId === task.id && goal.studentId === currentStudent.id
        );

        // Check if this is a self-planned task
        const isSelfPlanned = task.type === 'self_planned' && task.createdByStudent;

        return `
            <div class="task-card ${isCompleted ? 'completed' : ''}" style="margin-bottom: 1rem; ${isSelfPlanned ? 'border-left: 4px solid #9333ea; background: linear-gradient(135deg, #faf5ff, #f3e8ff);' : ''}">
                ${isSelfPlanned ? '<div style="background: #9333ea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-bottom: 8px; display: inline-block;">🎯 EIGEN PLANNING</div>' : ''}
                <div class="task-header">
                    <div style="flex: 1;">
                        <div class="task-title">
                            ${task.title} ${isOverdue ? '⚠️' : ''} ${isCompleted ? '✅' : ''}
                            ${task.duration ? `<span style="color: #9333ea; font-size: 0.8rem; margin-left: 8px;">(${task.duration} min)</span>` : ''}
                        </div>
                        <div class="task-meta">
                            <span>📚 ${task.subject}</span>
                            <span>📅 ${new Date(task.date).toLocaleDateString('nl-NL')}</span>
                            <span>⏰ ${task.time || 'Geen tijd'}</span>
                        </div>
                        ${task.goal ? `<div style="margin-top: 8px; color: #666;"><strong>Doel:</strong> ${task.goal}</div>` : ''}
                        ${task.pages ? `<div style="color: #666;"><strong>Pagina's:</strong> ${task.pages}</div>` : ''}
                        
                        ${personalGoal ? `
                            <div class="personal-goal">
                                <div class="personal-goal-header">
                                    <span style="font-weight: bold; color: #9333ea;">💜 Mijn persoonlijke doel:</span>
                                </div>
                                <div class="personal-goal-text">${personalGoal.goal}</div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            ${!isCompleted ? `
                                <button class="btn btn-success btn-small" onclick="completeTask('${task.id}', '${currentStudent.id}')">✅ Voltooien</button>
                                <button class="btn btn-primary btn-small" onclick="showLogbookModal('${task.id}')">📝 Logboek</button>
                                <button class="btn btn-info btn-small" onclick="showPersonalGoalModal('${task.id}')">💜 Persoonlijk Doel</button>
                                ${isSelfPlanned ? `<button class="btn btn-warning btn-small" onclick="editStudentTask('${task.id}')" style="background: #9333ea; border-color: #9333ea;">✏️ Bewerken</button>` : ''}
                            ` : `
                                <span style="color: #48bb78; font-weight: bold;">✅ Voltooid</span>
                            `}
                            ${hasLogbook ? '<span style="background: #48bb78; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">📝 Logboek</span>' : ''}
                            ${hasFeedback ? '<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">💬 Feedback</span>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Combineer planning sectie met taken
    container.innerHTML = planningSection + tasksHtml;
}

        function viewTaskDetails(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            // Switch to presentation mode and highlight this task
            switchTab('presentation');
            setTimeout(() => {
                renderPresentationView();
                showNotification(`Bekijk taak: ${task.title}`, 'info');
            }, 100);
        }

        function completeTask(taskId, studentId) {
            const student = students.find(s => s.id === studentId);
            const task = tasks.find(t => t.id === taskId);
            
            if (!student || !task) return;

            if (student.completedTasks.includes(taskId)) {
                showNotification('Taak al voltooid!', 'warning');
                return;
            }

            // Mark task as completed
            student.completedTasks.push(taskId);
            
            // Apply skill bonuses based on subject
            // Apply skill bonuses based on subject and task type
let skillMapping = taskSkillMapping[task.subject] || { zb: 5, zm: 5 }; // Default bonus

// Extra bonus for self-planned tasks (initiative and self-direction)
if (task.type === 'self_planned' && task.createdByStudent) {
    // Add bonus for self-directed learning
    skillMapping = { ...skillMapping };
    Object.keys(skillMapping).forEach(skill => {
        skillMapping[skill] = Math.round(skillMapping[skill] * 1.2); // 20% bonus
    });
    skillMapping.zm = (skillMapping.zm || 0) + 3; // Extra self-management bonus
    skillMapping.zb = (skillMapping.zb || 0) + 2; // Extra self-awareness bonus
}
            let milestonesAchieved = [];
            
            Object.keys(skillMapping).forEach(skillCode => {
                const increase = skillMapping[skillCode];
                const oldValue = student.skills[skillCode] || 0;
                let newValue = oldValue + increase;
                
                // Check for milestones
                if (newValue >= 100 && oldValue < 100) {
                    const milestone = milestones.find(m => m.skill === skillCode);
                    if (milestone) {
                        const achievedMilestone = {
                            id: generateId(),
                            milestoneId: milestone.id,
                            milestoneName: milestone.name,
                            skillName: skillDefinitions[skillCode].name,
                            badge: milestone.badge,
                            timestamp: new Date().toISOString(),
                            level: getNextMilestoneLevel(student, skillCode)
                        };

                        student.achievedMilestones = student.achievedMilestones || [];
                        student.achievedMilestones.push(achievedMilestone);
                        milestonesAchieved.push(achievedMilestone);
                        
                        addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, student.id);
                    }
                    
                    newValue = newValue - 100; // Reset with overflow
                }
                
                student.skills[skillCode] = newValue;
            });
            
            // Award completion token
            const completionToken = {
                id: generateId(),
                type: 'star', // Default completion token
                source: 'task_completion',
                taskId: taskId,
                timestamp: new Date().toISOString()
            };
            
            student.tokens = student.tokens || [];
            student.tokens.push(completionToken);
            
            // Add to timeline
            const skillIncreases = Object.keys(skillMapping).map(skillCode => 
                `+${skillMapping[skillCode]}% ${skillDefinitions[skillCode].name}`
            );
            addToTimeline(`✅ Taak voltooid: ${task.title} (${skillIncreases.join(', ')}) + Token!`, student.id);
            
            saveData();
            updateStatistics();
            updateSidebar();
            renderStudentTasks();
            renderTasksList();
			updatePortfolioSummary(); // ← DEZE REGEL TOEVOEGEN
            
            // Show notifications
            if (milestonesAchieved.length > 0) {
                milestonesAchieved.forEach(milestone => {
                    setTimeout(() => showMilestoneNotification(milestone), 500);
                });
            } else {
                showNotification(`Taak "${task.title}" voltooid! +Token en vaardigheden verhoogd!`, 'success');
            }
        }

        // Logbook functions
        function showLogbookModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            currentLogbookTask = task;
            
            // Update task info in modal
            document.getElementById('logbookTaskInfo').innerHTML = `
                <h4>${task.title}</h4>
                <div style="color: #666; margin-top: 5px;">
                    📚 ${task.subject} | 🎯 ${task.goal || 'Geen specifiek doel'}
                </div>
            `;
            
            // Check if logbook entry already exists
            const existingEntry = logbookEntries.find(entry => 
                entry.taskId === taskId && entry.studentId === currentStudent.id
            );
            
            if (existingEntry) {
                document.getElementById('logbookContentInput').value = existingEntry.content || '';
                document.getElementById('logbookReflection').value = existingEntry.reflection || '';
            } else {
                document.getElementById('logbookContentInput').value = '';
                document.getElementById('logbookReflection').value = '';
            }
            
            // Check if personal goal exists
            const existingGoal = personalGoals.find(goal => 
                goal.taskId === taskId && goal.studentId === currentStudent.id
            );
            
            if (existingGoal) {
                document.getElementById('logbookPersonalGoal').value = existingGoal.goal || '';
            } else {
                document.getElementById('logbookPersonalGoal').value = '';
            }
            
            document.getElementById('logbookModal').classList.add('show');
        }

        function showPersonalGoalModal(taskId) {
            // For now, use the logbook modal for personal goals
            showLogbookModal(taskId);
        }

        function saveLogbookEntry() {
            if (!currentLogbookTask || !currentStudent) {
                showNotification('Geen taak of leerling geselecteerd!', 'error');
                return;
            }
            
            const contentElement = document.getElementById('logbookContentInput');
            const content = contentElement ? contentElement.value.trim() : '';
            const reflection = document.getElementById('logbookReflection').value.trim();
            const personalGoalText = document.getElementById('logbookPersonalGoal').value.trim();
            
            if (!content || content.length === 0) {
                showNotification('Het logboek veld "Wat heb je gedaan? Wat heb je geleerd?" is verplicht!', 'error');
                if (contentElement) {
                    contentElement.focus();
                    contentElement.style.borderColor = '#f56565';
                    setTimeout(() => {
                        contentElement.style.borderColor = '';
                    }, 3000);
                }
                return;
            }

            const now = new Date();
            
            // Save or update logbook entry
            const existingEntryIndex = logbookEntries.findIndex(entry => 
                entry.taskId === currentLogbookTask.id && entry.studentId === currentStudent.id
            );
            
            const isNewEntry = existingEntryIndex < 0; // Check if this is a new entry
            
            const logbookData = {
                id: existingEntryIndex >= 0 ? logbookEntries[existingEntryIndex].id : generateId(),
                taskId: currentLogbookTask.id,
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                taskTitle: currentLogbookTask.title,
                subject: currentLogbookTask.subject,
                goal: currentLogbookTask.goal,
                content: content,
                reflection: reflection,
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                createdAt: existingEntryIndex >= 0 ? logbookEntries[existingEntryIndex].createdAt : now.toISOString()
            };
            
            if (existingEntryIndex >= 0) {
                logbookEntries[existingEntryIndex] = logbookData;
            } else {
                logbookEntries.push(logbookData);
            }
            
            // Save or update personal goal
            if (personalGoalText) {
                const existingGoalIndex = personalGoals.findIndex(goal => 
                    goal.taskId === currentLogbookTask.id && goal.studentId === currentStudent.id
                );
                
                const goalData = {
                    id: existingGoalIndex >= 0 ? personalGoals[existingGoalIndex].id : generateId(),
                    taskId: currentLogbookTask.id,
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    taskTitle: currentLogbookTask.title,
                    goal: personalGoalText,
                    createdAt: existingGoalIndex >= 0 ? personalGoals[existingGoalIndex].createdAt : now.toISOString()
                };
                
                if (existingGoalIndex >= 0) {
                    personalGoals[existingGoalIndex] = goalData;
                } else {
                    personalGoals.push(goalData);
                }
            }
            
            // Only award tokens and skills for NEW entries (not updates)
            if (isNewEntry) {
                // Award logbook token
                const logbookToken = {
                    id: generateId(),
                    type: 'smile',
                    source: 'logbook',
                    taskId: currentLogbookTask.id,
                    timestamp: now.toISOString()
                };
                
                currentStudent.tokens = currentStudent.tokens || [];
                currentStudent.tokens.push(logbookToken);
                
                // Apply reflection skills bonus
                const oldZB = currentStudent.skills.zb || 0;
                let newZB = oldZB + 5; // Reflection bonus
                
                if (newZB >= 100 && oldZB < 100) {
                    // Check for milestone
                    const milestone = milestones.find(m => m.skill === 'zb');
                    if (milestone) {
                        const achievedMilestone = {
                            id: generateId(),
                            milestoneId: milestone.id,
                            milestoneName: milestone.name,
                            skillName: skillDefinitions.zb.name,
                            badge: milestone.badge,
                            timestamp: now.toISOString(),
                            level: getNextMilestoneLevel(currentStudent, 'zb')
                        };

                        currentStudent.achievedMilestones = currentStudent.achievedMilestones || [];
                        currentStudent.achievedMilestones.push(achievedMilestone);
                        
                        addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, currentStudent.id);
                        setTimeout(() => showMilestoneNotification(achievedMilestone), 500);
                    }
                    
                    newZB = newZB - 100;
                }
                
                currentStudent.skills.zb = newZB;
                
                addToTimeline(`📝 Logboek entry toegevoegd voor: ${currentLogbookTask.title} (+5% Zelfbewustzijn, +Token)`, currentStudent.id);
                showNotification('Logboek entry opgeslagen! +Token en vaardigheden verhoogd!', 'success');
            } else {
                addToTimeline(`📝 Logboek entry bijgewerkt voor: ${currentLogbookTask.title}`, currentStudent.id);
                showNotification('Logboek entry bijgewerkt!', 'success');
            }
            
            closeLogbookModal();
            saveData();
            updateStatistics();
            updateSidebar();
            renderStudentTasks();
            renderLogbookContent();
			updatePortfolioSummary(); // ← DEZE REGEL TOEVOEGEN
        }

        function closeLogbookModal() {
            document.getElementById('logbookModal').classList.remove('show');
            currentLogbookTask = null;
        }

        function renderLogbookContent() {
            const container = document.getElementById('logbookContent');
            
            if (logbookEntries.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nog geen logboek entries</p>';
                return;
            }

            // Group by student
            const groupedEntries = {};
            logbookEntries.forEach(entry => {
                if (!groupedEntries[entry.studentId]) {
                    groupedEntries[entry.studentId] = [];
                }
                groupedEntries[entry.studentId].push(entry);
            });

            let html = '';
            Object.keys(groupedEntries).forEach(studentId => {
                const studentEntries = groupedEntries[studentId];
                const studentName = studentEntries[0].studentName;
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3>📖 ${studentName} (${studentEntries.length} entries)</h3>
                        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                `;
                
                studentEntries.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                    .forEach(entry => {
                        const personalGoal = personalGoals.find(goal => 
                            goal.taskId === entry.taskId && goal.studentId === entry.studentId
                        );
                        
                        html += `
                            <div style="background: #f8f9ff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px;">
                                <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 15px;">
                                    <div>
                                        <h4 style="margin-bottom: 5px;">${entry.taskTitle}</h4>
                                        <div style="color: #666; font-size: 0.9rem;">
                                            📚 ${entry.subject} | 📅 ${new Date(entry.date).toLocaleDateString('nl-NL')} om ${entry.time}
                                        </div>
                                        ${entry.goal ? `<div style="color: #666; font-size: 0.9rem; margin-top: 4px;">🎯 ${entry.goal}</div>` : ''}
                                    </div>
                                </div>
                                
                                ${personalGoal ? `
                                    <div class="personal-goal" style="margin-bottom: 15px;">
                                        <div style="font-weight: bold; color: #9333ea; margin-bottom: 5px;">💜 Persoonlijk Leerdoel:</div>
                                        <div style="color: #6b21a8; font-style: italic;">${personalGoal.goal}</div>
                                    </div>
                                ` : ''}
                                
                                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>Logboek:</strong><br>
                                    ${entry.content.replace(/\n/g, '<br>')}
                                </div>
                                
                                ${entry.reflection ? `
                                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                        <strong>Reflectie:</strong><br>
                                        ${entry.reflection.replace(/\n/g, '<br>')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                
                html += '</div></div>';
            });

            container.innerHTML = html;
        }

        // Feedback functions
        function showFeedbackModal(taskId, studentId) {
            const task = tasks.find(t => t.id === taskId);
            const student = students.find(s => s.id === studentId);
            
            if (!task || !student) return;

            currentFeedbackTask = { taskId, studentId, task, student };
            
            // Update task info in modal
            document.getElementById('feedbackTaskInfo').innerHTML = `
                <h4>${student.name} - ${task.title}</h4>
                <div style="color: #666; margin-top: 5px;">
                    📚 ${task.subject} | 🎯 ${task.goal || 'Geen specifiek doel'}
                </div>
            `;
            
            // Check if feedback already exists
            const existingFeedback = feedbackEntries.find(entry => 
                entry.taskId === taskId && entry.studentId === studentId
            );
            
            if (existingFeedback) {
                document.getElementById('feedbackText').value = existingFeedback.feedback || '';
                setRating(existingFeedback.rating || 3);
            } else {
                document.getElementById('feedbackText').value = '';
                setRating(3);
            }
            
            document.getElementById('feedbackModal').classList.add('show');
        }

        function setRating(rating) {
            currentRating = rating;
            
            // Update star display
            const stars = document.querySelectorAll('#ratingSelector button');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#ffd700';
                    star.style.textShadow = '0 0 10px #ffd700';
                } else {
                    star.style.color = '#ddd';
                    star.style.textShadow = 'none';
                }
            });
            
            document.getElementById('ratingDisplay').textContent = `${rating}/5 sterren`;
        }

        function saveFeedback() {
            if (!currentFeedbackTask) return;
            
            const feedbackText = document.getElementById('feedbackText').value.trim();
            
            if (!feedbackText) {
                showNotification('Voer feedback tekst in!', 'error');
                return;
            }

            const now = new Date();
            const { taskId, studentId, task, student } = currentFeedbackTask;
            
            // Save or update feedback
            const existingFeedbackIndex = feedbackEntries.findIndex(entry => 
                entry.taskId === taskId && entry.studentId === studentId
            );
            
            const isNewFeedback = existingFeedbackIndex < 0; // Check if this is new feedback
            
            const feedbackData = {
                id: existingFeedbackIndex >= 0 ? feedbackEntries[existingFeedbackIndex].id : generateId(),
                taskId: taskId,
                studentId: studentId,
                studentName: student.name,
                taskTitle: task.title,
                subject: task.subject,
                goal: task.goal,
                feedback: feedbackText,
                rating: currentRating,
                date: now.toISOString().split('T')[0],
                createdAt: existingFeedbackIndex >= 0 ? feedbackEntries[existingFeedbackIndex].createdAt : now.toISOString()
            };
            
            if (existingFeedbackIndex >= 0) {
                feedbackEntries[existingFeedbackIndex] = feedbackData;
            } else {
                feedbackEntries.push(feedbackData);
            }
            
            // Only award bonus tokens and skills for NEW feedback (not updates)
            if (isNewFeedback && currentRating >= 4) {
                const bonusToken = {
                    id: generateId(),
                    type: 'trophy',
                    source: 'high_feedback',
                    taskId: taskId,
                    timestamp: now.toISOString()
                };
                
                student.tokens = student.tokens || [];
                student.tokens.push(bonusToken);
                
                // Bonus skills for excellent feedback
                const bonusSkills = { zb: 3, zm: 2 }; // Confidence and motivation boost
                Object.keys(bonusSkills).forEach(skillCode => {
                    const increase = bonusSkills[skillCode];
                    const oldValue = student.skills[skillCode] || 0;
                    let newValue = oldValue + increase;
                    
                    if (newValue >= 100 && oldValue < 100) {
                        const milestone = milestones.find(m => m.skill === skillCode);
                        if (milestone) {
                            const achievedMilestone = {
                                id: generateId(),
                                milestoneId: milestone.id,
                                milestoneName: milestone.name,
                                skillName: skillDefinitions[skillCode].name,
                                badge: milestone.badge,
                                timestamp: now.toISOString(),
                                level: getNextMilestoneLevel(student, skillCode)
                            };

                            student.achievedMilestones = student.achievedMilestones || [];
                            student.achievedMilestones.push(achievedMilestone);
                            
                            addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, student.id);
                            setTimeout(() => showMilestoneNotification(achievedMilestone), 1000);
                        }
                        
                        newValue = newValue - 100;
                    }
                    
                    student.skills[skillCode] = newValue;
                });
                
                addToTimeline(`💬 Uitstekende feedback ontvangen (${currentRating}⭐) voor: ${task.title} (+Bonus Token en Vaardigheden!)`, student.id);
                showNotification(`Feedback opgeslagen! +Bonus beloningen!`, 'success');
            } else if (isNewFeedback) {
                addToTimeline(`💬 Feedback ontvangen (${currentRating}⭐) voor: ${task.title}`, student.id);
                showNotification('Feedback opgeslagen!', 'success');
            } else {
                addToTimeline(`💬 Feedback bijgewerkt (${currentRating}⭐) voor: ${task.title}`, student.id);
                showNotification('Feedback bijgewerkt!', 'success');
            }
            
            closeFeedbackModal();
            saveData();
            updateStatistics();
            updateSidebar();
            renderFeedbackContent();
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('show');
            currentFeedbackTask = null;
            currentRating = 3;
        }

        function renderFeedbackContent() {
            const container = document.getElementById('feedbackContent');
            
            // Get all task assignments that can receive feedback
            const taskAssignments = [];
            tasks.forEach(task => {
                task.assignedStudents.forEach(studentId => {
                    const student = students.find(s => s.id === studentId);
                    if (student) {
                        taskAssignments.push({
                            taskId: task.id,
                            studentId: studentId,
                            task: task,
                            student: student,
                            hasCompleted: student.completedTasks.includes(task.id),
                            hasFeedback: feedbackEntries.some(entry => 
                                entry.taskId === task.id && entry.studentId === studentId
                            )
                        });
                    }
                });
            });

            if (taskAssignments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Geen taken om feedback op te geven</p>';
                return;
            }

            // Group by completion status
            const completed = taskAssignments.filter(assignment => assignment.hasCompleted);
            const pending = taskAssignments.filter(assignment => !assignment.hasCompleted);

            let html = '';

            if (completed.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3>✅ Voltooide Taken (${completed.length})</h3>
                        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                `;
                
                completed.forEach(assignment => {
                    const feedback = feedbackEntries.find(entry => 
                        entry.taskId === assignment.taskId && entry.studentId === assignment.studentId
                    );
                    
                    html += `
                        <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4>${assignment.student.name} - ${assignment.task.title}</h4>
                                <div style="color: #666; margin-top: 5px;">
                                    📚 ${assignment.task.subject} | 📅 ${new Date(assignment.task.date).toLocaleDateString('nl-NL')}
                                </div>
                                ${feedback ? `
                                    <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.8); border-radius: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                            <span style="color: #ffd700; font-size: 1.2rem;">${'⭐'.repeat(feedback.rating)}</span>
                                            <span style="color: #666;">${feedback.rating}/5 sterren</span>
                                        </div>
                                        <div style="color: #333;">${feedback.feedback}</div>
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn ${feedback ? 'btn-info' : 'btn-success'} btn-small" onclick="showFeedbackModal('${assignment.taskId}', '${assignment.studentId}')">
                                    ${feedback ? '✏️ Bewerken' : '💬 Feedback Geven'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            if (pending.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3>⏳ Nog Niet Voltooid (${pending.length})</h3>
                        <div style="display: grid; gap: 1rem; margin-top: 1rem;">
                `;
                
                pending.forEach(assignment => {
                    const isOverdue = new Date(assignment.task.date) < new Date();
                    
                    html += `
                        <div style="background: #fef3c7; border: 2px solid #fbbf24; border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4>${assignment.student.name} - ${assignment.task.title} ${isOverdue ? '⚠️' : ''}</h4>
                                <div style="color: #666; margin-top: 5px;">
                                    📚 ${assignment.task.subject} | 📅 ${new Date(assignment.task.date).toLocaleDateString('nl-NL')}
                                    ${isOverdue ? ' (Verlopen)' : ''}
                                </div>
                            </div>
                            <div>
                                <span style="color: #92400e; font-weight: bold;">Wacht op voltooiing</span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            }

            container.innerHTML = html;
        }

        // Token assignment
        function updateDashboardTokenGrid() {
            const grid = document.getElementById('dashboardTokenGrid');
            const titleElement = document.getElementById('tokenPanelTitle');
            const descriptionElement = document.getElementById('tokenPanelDescription');
            
            if (!currentStudent) {
                grid.innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om tokens toe te kennen</p>';
                return;
            }

            if (userRole === 'student') {
                // Update title and description for students
                titleElement.textContent = '🎨 Mijn Token Collectie';
                descriptionElement.textContent = 'Hier zie je alle tokens die je hebt verdiend door taken te voltooien!';
                
                // Students see their token collection, not assignment interface
                const allTokens = currentStudent.tokens || [];
                
                if (allTokens.length === 0) {
                    grid.innerHTML = '<p style="text-align: center; color: #666;">Je hebt nog geen tokens verzameld. Voltooie taken om tokens te verdienen!</p>';
                    return;
                }

                // Show recent tokens in a nice grid
                const recentTokens = allTokens.slice(-12); // Show last 12 tokens
                
                grid.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${allTokens.length}</div>
                        <div style="color: #666;">Totaal aantal tokens</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 15px;">
                        ${recentTokens.map(token => {
                            const tokenType = tokenTypes.find(t => t.id === token.type);
                            if (!tokenType) return '';
                            
                            return `
                                <div style="background: ${tokenType.color}; border-radius: 15px; padding: 15px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    <div style="font-size: 2rem; margin-bottom: 8px;">${tokenType.emoji}</div>
                                    <div style="font-size: 0.8rem; font-weight: 600; color: white;">${tokenType.name}</div>
                                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.8); margin-top: 4px;">${token.source === 'task_completion' ? 'Taak voltooid' : token.source === 'logbook' ? 'Logboek' : token.source === 'manual' ? 'Van leraar' : 'Verdiend'}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${allTokens.length > 12 ? `
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-info btn-small" onclick="showTokensView()">
                                🎨 Bekijk alle ${allTokens.length} tokens
                            </button>
                        </div>
                    ` : ''}
                `;
                return;
            }

            // Teacher interface for token assignment
            titleElement.textContent = '🎨 Token Toekenning';
            descriptionElement.textContent = 'Tokens verhogen automatisch vaardigheden en kunnen mijlpalen opleveren!';
            
            grid.innerHTML = tokenTypes.map(token => `
                <div class="token-option" onclick="assignToken('${token.id}')">
                    <div class="token-visual" style="background: ${token.color};">
                        ${token.emoji}
                    </div>
                    <div class="token-name">${token.name}</div>
                    <div class="token-skill-boost">${token.description}</div>
                </div>
            `).join('');
        }
// ✅ VEILIGE TOKEN TOEKENNING met directe sync
        async function assignTokenSafely(tokenId, studentId, source = 'manual') {
            if (userRole !== 'teacher') {
                showNotification('Alleen leraren kunnen tokens toekennen!', 'error');
                return false;
            }

            const student = students.find(s => s.id === studentId);
            const tokenType = tokenTypes.find(t => t.id === tokenId);
            
            if (!student || !tokenType) {
                showNotification('Student of token type niet gevonden!', 'error');
                return false;
            }

            try {
                // ✅ STAP 1: Download laatste cloud data EERST
                if (cloudSyncEnabled) {
                    console.log('🔄 Pre-token download for conflict prevention...');
                    await downloadFromCloud();
                    
                    // Refresh student reference na download
                    const refreshedStudent = students.find(s => s.id === studentId);
                    if (!refreshedStudent) {
                        showNotification('Student niet meer gevonden na refresh!', 'error');
                        return false;
                    }
                }

                // ✅ STAP 2: Ken token toe
				// 🔍 Start verification check
const verifyAfter = verifyTokenAddition(tokenType, studentId);
                const currentStudent = students.find(s => s.id === studentId);
                const token = {
                    id: generateId(),
                    type: tokenId,
                    source: source,
                    timestamp: new Date().toISOString()
                };

                currentStudent.tokens = currentStudent.tokens || [];
                currentStudent.tokens.push(token);
				
				// 🔍 Check if token was actually added
verifyAfter();
                
                // Apply skill increases
                let skillIncreases = [];
                let milestonesAchieved = [];
                
                Object.keys(tokenType.skills).forEach(skillCode => {
                    const increase = tokenType.skills[skillCode];
                    const oldValue = currentStudent.skills[skillCode] || 0;
                    let newValue = oldValue + increase;
                    
                    skillIncreases.push(`+${increase}% ${skillDefinitions[skillCode].name}`);
                    
                    if (newValue >= 100 && oldValue < 100) {
                        const milestone = milestones.find(m => m.skill === skillCode);
                        if (milestone) {
                            const achievedMilestone = {
                                id: generateId(),
                                milestoneId: milestone.id,
                                milestoneName: milestone.name,
                                skillName: skillDefinitions[skillCode].name,
                                badge: milestone.badge,
                                timestamp: new Date().toISOString(),
                                level: getNextMilestoneLevel(currentStudent, skillCode)
                            };

                            currentStudent.achievedMilestones = currentStudent.achievedMilestones || [];
                            currentStudent.achievedMilestones.push(achievedMilestone);
                            milestonesAchieved.push(achievedMilestone);
                            
                            addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, currentStudent.id);
                        }
                        
                        newValue = newValue - 100;
                    }
                    
                    currentStudent.skills[skillCode] = newValue;
                });
                
                addToTimeline(`🎨 Token toegekend: ${tokenType.name} (${skillIncreases.join(', ')})`, currentStudent.id);
                
                // ✅ STAP 3: Sla lokaal op
                saveData();
                
                // ✅ STAP 4: Upload METEEN naar cloud
                if (cloudSyncEnabled) {
                    console.log('📤 Immediate upload after token assignment...');
                    await uploadToCloud();
                }
                
               // ✅ STAP 5: Update UI - GEFORCEERDE TOKEN UPDATE
console.log('🔄 Starting UI updates after token assignment...');

// Immediate token update
updateSidebarTokens();

// Force additional updates with delays
setTimeout(() => {
    console.log('🔄 First delayed update...');
    updateSidebarTokens(); // Update tokens again
    updateSkillBars();
    updateSidebarMilestones();
    updateDashboardMilestones();
    updatePortfolioSummary();
    renderPresentationView();
}, 100);

// Extra forced update after 500ms
setTimeout(() => {
    console.log('🔄 Second delayed update...');
    updateSidebarTokens(); // Force again
    updateSkillBars();
}, 500);
                
                updateStatistics();
                renderTimelineContent();
                
                // ✅ STAP 6: Show notifications
                if (milestonesAchieved.length > 0) {
                    milestonesAchieved.forEach(milestone => {
                        showMilestoneNotification(milestone);
                    });
                } else {
                    showNotification(`${tokenType.name} toegekend aan ${currentStudent.name}!\n${skillIncreases.join(', ')}`, 'success');
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Safe token assignment failed:', error);
                showNotification('Fout bij token toekenning: ' + error.message, 'error');
                return false;
            }
        }
        // ✅ UPDATE BESTAANDE FUNCTIE om veilige versie te gebruiken
        function assignToken(tokenId) {
            if (!currentStudent) {
                showNotification('Selecteer eerst een leerling!', 'error');
                return;
            }

            assignTokenSafely(tokenId, currentStudent.id, 'manual');
        }

        function assignTokenFromPresentation(tokenId, studentId, modal) {
    assignTokenSafely(tokenId, studentId, 'presentation').then(success => {
        if (success && modal) {
            modal.remove();
        }
    });
}

// ✅ PRESENTATION TOKEN MODAL FUNCTIES
function showPresentationTokenModal(studentId) {
    const student = students.find(s => s.id === studentId);
    if (!student) return;

    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <h3>🎨 Token Toekennen aan ${student.name}</h3>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">
                Klik op een token om deze toe te kennen
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 2rem;">
                ${tokenTypes.map(token => `
                    <div style="background: ${token.color}; color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: 3px solid transparent;" 
                         onclick="assignTokenFromPresentation('${token.id}', '${studentId}', this.closest('.modal'))"
                         onmouseover="this.style.transform='translateY(-3px)'; this.style.borderColor='white'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='transparent'">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">${token.emoji}</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${token.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${token.description}</div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white; padding: 10px 20px;">
                    ❌ Annuleren
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function showGroupTokenModal(groupId) {
    const group = groups.find(g => g.id === groupId);
    if (!group) return;

    const members = group.members.map(memberId => students.find(s => s.id === memberId)).filter(Boolean);
    
    if (members.length === 0) {
        showNotification('Deze groep heeft geen leden!', 'error');
        return;
    }

    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <h3>🎨 Token Toekennen aan ${group.icon || '👥'} ${group.name}</h3>
            <p style="text-align: center; color: #666; margin-bottom: 1rem;">
                Leden: ${members.map(m => m.name).join(', ')}
            </p>
            <p style="text-align: center; color: #667eea; margin-bottom: 2rem;">
                Deze token wordt toegekend aan alle ${members.length} groepsleden
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 2rem;">
                ${tokenTypes.map(token => `
                    <div style="background: ${token.color}; color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer; transition: all 0.3s; border: 3px solid transparent;" 
                         onclick="assignTokenToGroup('${token.id}', '${groupId}', this.closest('.modal'))"
                         onmouseover="this.style.transform='translateY(-3px)'; this.style.borderColor='white'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='transparent'">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">${token.emoji}</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${token.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${token.description}</div>
                    </div>
                `).join('')}
            </div>
            
            <div style="text-align: center;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white; padding: 10px 20px;">
                    ❌ Annuleren
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// ✅ VEILIGE GROEP TOKEN TOEKENNING
async function assignTokenToGroupSafely(tokenId, groupId) {
    if (userRole !== 'teacher') {
        showNotification('Alleen leraren kunnen tokens toekennen!', 'error');
        return false;
    }

    const group = groups.find(g => g.id === groupId);
    const tokenType = tokenTypes.find(t => t.id === tokenId);
    
    if (!group || !tokenType) {
        showNotification('Groep of token type niet gevonden!', 'error');
        return false;
    }

    const members = group.members.map(memberId => students.find(s => s.id === memberId)).filter(Boolean);
    
    if (members.length === 0) {
        showNotification('Deze groep heeft geen leden!', 'error');
        return false;
    }

    try {
        // Download latest data first
        if (cloudSyncEnabled) {
            console.log('🔄 Pre-group-token download...');
            await downloadFromCloud();
        }

        let totalMilestonesAchieved = [];
        let updatedMembers = [];

        // Apply to all group members
        for (const member of members) {
            const currentMember = students.find(s => s.id === member.id);
            if (!currentMember) continue;

            const token = {
                id: generateId(),
                type: tokenId,
                source: 'group_presentation',
                timestamp: new Date().toISOString()
            };

            currentMember.tokens = currentMember.tokens || [];
            currentMember.tokens.push(token);
            
            // Apply skill increases
            let memberMilestones = [];
            
            Object.keys(tokenType.skills).forEach(skillCode => {
                const increase = tokenType.skills[skillCode];
                const oldValue = currentMember.skills[skillCode] || 0;
                let newValue = oldValue + increase;
                
                if (newValue >= 100 && oldValue < 100) {
                    const milestone = milestones.find(m => m.skill === skillCode);
                    if (milestone) {
                        const achievedMilestone = {
                            id: generateId(),
                            milestoneId: milestone.id,
                            milestoneName: milestone.name,
                            skillName: skillDefinitions[skillCode].name,
                            badge: milestone.badge,
                            timestamp: new Date().toISOString(),
                            level: getNextMilestoneLevel(currentMember, skillCode)
                        };

                        currentMember.achievedMilestones = currentMember.achievedMilestones || [];
                        currentMember.achievedMilestones.push(achievedMilestone);
                        memberMilestones.push(achievedMilestone);
                        
                        addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, currentMember.id);
                    }
                    
                    newValue = newValue - 100;
                }
                
                currentMember.skills[skillCode] = newValue;
            });
            
            totalMilestonesAchieved.push(...memberMilestones);
            updatedMembers.push(currentMember.name);
            
            addToTimeline(`🎨 Groep token: ${tokenType.name} (${group.name})`, currentMember.id);
        }
        
        // Save and sync
        saveData();
        
        if (cloudSyncEnabled) {
            console.log('📤 Immediate upload after group token...');
            await uploadToCloud();
        }
        
        // Update UI
        renderPresentationView();
        updateStatistics();
        
        // Show notifications
        if (totalMilestonesAchieved.length > 0) {
            totalMilestonesAchieved.forEach((milestone, index) => {
                setTimeout(() => showMilestoneNotification(milestone), index * 1000);
            });
        }
        
        showNotification(`${tokenType.name} toegekend aan groep ${group.name}!\n${updatedMembers.length} leden bijgewerkt`, 'success');
        
        return true;
        
    } catch (error) {
        console.error('❌ Group token assignment failed:', error);
        showNotification('Fout bij groep token toekenning: ' + error.message, 'error');
        return false;
    }
}

        function getNextMilestoneLevel(student, skillCode) {
            if (!student.achievedMilestones) return 1;
            
            const skillMilestones = student.achievedMilestones.filter(m => {
                const milestone = milestones.find(ms => ms.id === m.milestoneId);
                return milestone && milestone.skill === skillCode;
            });
            
            return skillMilestones.length + 1;
        }

        function showMilestoneNotification(milestone) {
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                animation: fadeIn 0.5s ease-out;
            `;

            const celebration = document.createElement('div');
            celebration.style.cssText = `
                background: linear-gradient(135deg, #ffd700, #ffed4a);
                color: #2d3748;
                padding: 3rem;
                border-radius: 1.5rem;
                text-align: center;
                box-shadow: 0 20px 60px rgba(255, 215, 0, 0.5);
                animation: bounceIn 0.8s ease-out 0.2s both;
                max-width: 400px;
            `;

            celebration.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 1rem;">${milestone.badge}</div>
                <h2 style="font-size: 1.8rem; margin-bottom: 1rem;">MIJLPAAL BEHAALD!</h2>
                <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem;">${milestone.milestoneName}</h3>
                <p style="font-size: 1.1rem; margin-bottom: 1rem;">Level ${milestone.level}</p>
                <p style="font-size: 1rem; opacity: 0.8;">${milestone.skillName}</p>
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" 
                        style="margin-top: 2rem; padding: 0.75rem 2rem; background: #2d3748; color: white; border: none; border-radius: 0.5rem; font-weight: bold; cursor: pointer;">
                    Geweldig! 🎉
                </button>
            `;

            if (!document.getElementById('celebrationStyles')) {
                const style = document.createElement('style');
                style.id = 'celebrationStyles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes bounceIn {
                        0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
                        50% { transform: scale(1.1) rotate(5deg); opacity: 1; }
                        100% { transform: scale(1) rotate(0deg); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }

            overlay.appendChild(celebration);
            document.body.appendChild(overlay);

            setTimeout(() => {
                if (overlay.parentNode) {
                    overlay.remove();
                }
            }, 10000);
        }

        // Continue with rest of functions...
        function addToTimeline(description, studentId) {
            timeline.unshift({
                id: generateId(),
                description: description,
                studentId: studentId,
                timestamp: new Date().toISOString()
            });

            if (timeline.length > 50) {
                timeline = timeline.slice(0, 50);
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

       function saveData() {
    if (typeof(Storage) !== 'undefined') {
        const data = {
            students,
            tasks,
            subjects,
            logbookEntries,
            feedbackEntries,
            personalGoals,  // ← Behoud voor backward compatibility
            milestones,
            customTokens,
            timeline,
            groups,
            currentGridSize,
            teacherPassword,
            reflectionCards: reflectionCards || {},
            version: '4.0',
            lastSaved: new Date().toISOString()
        };

        try {
            const dataString = JSON.stringify(data);
            const sizeInMB = (dataString.length / (1024 * 1024)).toFixed(2);
            console.log(`💾 Attempting to save ${sizeInMB}MB of data`);
            
            localStorage.setItem('integratedLearningSystem', dataString);
            console.log(`✅ Data saved successfully`);
            
            // Trigger auto-sync if enabled
            autoSync();
            
            return true;
        } catch (error) {
            console.error('❌ Error saving data:', error);
            
            if (error.name === 'QuotaExceededError') {
                console.log('🧹 Storage full, attempting cleanup...');
                
                try {
                    const cleanData = {
                        students: students.map(student => ({
                            ...student,
                            tokens: student.tokens ? student.tokens.slice(-50) : []
                        })),
                        tasks,
                        subjects,
                        logbookEntries: logbookEntries.slice(-20),
                        feedbackEntries: feedbackEntries.slice(-20),
                        personalGoals,
                        milestones,
                        customTokens: [],
                        timeline: timeline.slice(0, 20),
                        groups,
                        currentGridSize,
                        teacherPassword,
                        reflectionCards: reflectionCards || {},
                        version: '4.0',
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem('integratedLearningSystem', JSON.stringify(cleanData));
                    showNotification('Data opgeschoond en opgeslagen (beperkte geschiedenis)', 'warning');
                    autoSync();
                    return true;
                } catch (secondError) {
                    showNotification('Opslagfout: LocalStorage vol! Reset data of gebruik export.', 'error');
                    return false;
                }
            } else {
                showNotification('Fout bij opslaan gegevens!', 'error');
                return false;
            }
        }
    }
}

        // FIX 2: Update de loadData() functie om personalGoals correct te laden
function loadData() {
    try {
        const saved = localStorage.getItem('integratedLearningSystem');
        if (saved) {
            const data = JSON.parse(saved);
            students = data.students || [];
            tasks = data.tasks || [];
            subjects = data.subjects || ['Wiskunde', 'Nederlands', 'Engels', 'Geschiedenis', 'Aardrijkskunde', 'Biologie', 'Natuurkunde', 'Scheikunde'];
            logbookEntries = data.logbookEntries || [];
            feedbackEntries = data.feedbackEntries || [];
            personalGoals = data.personalGoals || [];
            milestones = data.milestones || [];
            customTokens = data.customTokens || [];
            timeline = data.timeline || [];
            groups = data.groups || [];
            currentGridSize = data.currentGridSize || 2;
            teacherPassword = data.teacherPassword || 'leraar123';
            reflectionCards = data.reflectionCards || {};
            
            // FIX: Zorg ervoor dat elke student een personalGoals array heeft
            students.forEach(student => {
                if (!student.personalGoals) {
                    student.personalGoals = [];
                }
            });
            
            console.log(`📖 Data loaded successfully: ${students.length} students, ${tasks.length} tasks`);
        }
    } catch (error) {
        console.error('❌ Error loading data:', error);
        showNotification('Fout bij laden gegevens!', 'error');
    }
}

// FIX 5: Migratie functie voor bestaande data
function migratePersonalGoalsData() {
    console.log('🔄 Migrating personal goals data...');
    
    // Migreer globale personalGoals naar student-specifieke arrays
    if (personalGoals.length > 0) {
        personalGoals.forEach(goal => {
            if (goal.studentId) {
                const student = students.find(s => s.id === goal.studentId);
                if (student) {
                    if (!student.personalGoals) {
                        student.personalGoals = [];
                    }
                    
                    // Check if goal already exists
                    if (!student.personalGoals.find(g => g.id === goal.id)) {
                        student.personalGoals.push(goal);
                        console.log(`📋 Migrated goal "${goal.title}" to student ${student.name}`);
                    }
                }
            }
        });
        
        // Clear global array after migration
        personalGoals = [];
        saveData();
        console.log('✅ Personal goals migration completed');
    }
}

        function exportData() {
            const data = {
                students,
                tasks,
                subjects,
                logbookEntries,
                feedbackEntries,
                personalGoals,
                milestones,
                customTokens,
                timeline,
                groups,
                settings: {
                    currentGridSize,
                    teacherPassword
                },
                exportDate: new Date().toISOString(),
                version: '4.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `leerling-management-backup-${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            
            showNotification('Data geëxporteerd!', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.students) students = data.students;
                        if (data.tasks) tasks = data.tasks;
                        if (data.subjects) subjects = data.subjects;
                        if (data.logbookEntries) logbookEntries = data.logbookEntries;
                        if (data.feedbackEntries) feedbackEntries = data.feedbackEntries;
                        if (data.personalGoals) personalGoals = data.personalGoals;
                        if (data.milestones) milestones = data.milestones;
                        if (data.customTokens) customTokens = data.customTokens;
                        if (data.timeline) timeline = data.timeline;
                        if (data.groups) groups = data.groups;
                        if (data.settings) {
                            currentGridSize = data.settings.currentGridSize || 2;
                            teacherPassword = data.settings.teacherPassword || 'leraar123';
                        }
                        
                        saveData();
                        init();
                        showNotification('Data geïmporteerd!', 'success');
                    } catch (error) {
                        showNotification('Ongeldige data!', 'error');
                    }
                };
                reader.readAsText(file);
            });
            
            input.click();
        }
		// ✅ NIEUWE FUNCTIE - VOEG TOE BOVEN cleanupStorage()
// ✅ NIEUWE VERBETERDE DATA BESCHERMING TIPS
function showDataProtectionTips() {
    const tips = `🛡️ VERBETERDE DATA BESCHERMING (v4.1):

✅ NIEUWE VEILIGHEIDSMAATREGELEN:
- 🔄 Smart Merge: automatische samenvoeging van wijzigingen
- ⏱️ 30-sec sync interval (was 3-sec) - veel rustiger
- 📥 "Refresh" knop: updates ALLEEN op jouw verzoek
- 🔒 Veilige token toekenning: direct sync na tokens
- 🎯 Conflict preventie: download eerst, dan upload

✅ VOOR LERAREN - BESTE WERKWIJZE:
- Gebruik de "📥 Refresh" knop als je een melding ziet
- "Handmatig Synchroniseren" voor belangrijke wijzigingen
- Tokens worden nu veilig toegekend (geen verlies meer!)
- Bij twijfel: export backup eerst

✅ VOOR LEERLINGEN:
- Krijgen notificaties van nieuwe tokens/mijlpalen
- Real-time updates van hun voortgang
- Geen sync conflicts - alles wordt veilig samengevoegd

⚠️ ALS JE NOG STEEDS PROBLEMEN HEBT:
1. Gebruik "Export Data" voor backup
2. Vraag anderen even te stoppen met werken
3. Gebruik "Download van Cloud" ÉÉN KEER
4. Ga verder met werken

🆕 NIEUWE FUNCTIES:
- Tokens verdwijnen niet meer (smart merge)
- Meldingen van andere mensen's wijzigingen
- Veilige groep token toekenning
- Verbeterde conflict detectie

💡 PRO TIP: De "📥 Refresh" melding betekent dat anderen 
wijzigingen hebben gemaakt. Klik erop om bij te werken!`;
    
    alert(tips);
}

        function cleanupStorage() {
            if (confirm('Dit zal oude gegevens verwijderen om ruimte te maken. Wil je doorgaan?')) {
                console.log('🧹 Manual cleanup initiated');
                
                const beforeSize = JSON.stringify({students, timeline, customTokens}).length;
                
                timeline = timeline.slice(0, 20);
                
                students.forEach(student => {
                    if (student.tokens && student.tokens.length > 20) {
                        student.tokens = student.tokens.slice(-20);
                    }
                });
                
                logbookEntries = logbookEntries.slice(-30);
                feedbackEntries = feedbackEntries.slice(-30);
                customTokens = [];
                
                const afterSize = JSON.stringify({students, timeline, customTokens}).length;
                const savedBytes = beforeSize - afterSize;
                const savedKB = (savedBytes / 1024).toFixed(1);
                
                const success = saveData();
                if (success) {
                    showNotification(`Opgeschoond! ${savedKB}KB bespaard.`, 'success');
                    updateStatistics();
                    renderTimelineContent();
                } else {
                    showNotification('Fout bij opschonen. Probeer "Reset Alles".', 'error');
                }
            }
        }
function resetStudentProgress() {
    if (confirm('Weet je zeker dat je alle student voortgang wilt resetten?\n\nDit reset:\n✅ Vaardigheden naar 0%\n✅ Alle tokens\n✅ Behaalde mijlpalen\n✅ Voltooide taken\n✅ Logboek entries\n✅ Feedback\n✅ Persoonlijke doelen\n\nDit BEHOUDT:\n✅ Student namen en PINs\n✅ Taken (de taken zelf)\n✅ Groepen\n✅ Reflectiekaartjes\n\nDeze actie kan niet ongedaan worden gemaakt.')) {
        
        const secondConfirm = confirm(`🚨 LAATSTE WAARSCHUWING 🚨\n\nJe staat op het punt om ALLE student voortgang te wissen voor ${students.length} studenten.\n\nWeet je dit 100% zeker?`);
        
        if (!secondConfirm) {
            showNotification('Reset geannuleerd', 'info');
            return;
        }
        
        console.log('🔄 Starting student progress reset...');
        
        // Reset elke student naar startwaarden
        students.forEach(student => {
            // Reset skills naar 0
            student.skills = { zb: 0, zm: 0, sb: 0, rv: 0, vb: 0 };
            
            // Verwijder alle tokens
            student.tokens = [];
            
            // Verwijder behaalde mijlpalen
            student.achievedMilestones = [];
            
            // Reset voltooide taken
            student.completedTasks = [];
            
            // Reset persoonlijke doelen
            student.personalGoals = [];
            
            // Reset energie level naar normaal
            student.energyLevel = 3;
            
            // Verwijder complimenten
            student.compliments = [];
            
            // Verwijder skills awarded tracking
            student.skillsAwarded = [];
            
            // Update last activity
            student.lastActivity = new Date().toISOString();
        });
        
        // Verwijder alle logbook entries
        logbookEntries = [];
        
        // Verwijder alle feedback entries
        feedbackEntries = [];
        
        // Verwijder alle persoonlijke doelen (global array)
        personalGoals = [];
        
        // Verwijder student-gerelateerde timeline entries
        timeline = timeline.filter(entry => 
            !entry.studentId && // Behoud systeem entries
            !entry.description.includes('Token toegekend') &&
            !entry.description.includes('Taak voltooid') &&
            !entry.description.includes('MIJLPAAL BEHAALD') &&
            !entry.description.includes('Logboek entry') &&
            !entry.description.includes('Feedback') &&
            !entry.description.includes('Persoonlijk doel') &&
            !entry.description.includes('Energie niveau') &&
            !entry.description.includes('login')
        );
        
        // Voeg reset entry toe aan timeline
        addToTimeline('🔄 Alle student voortgang gereset naar 0', null);
        
        // Reset current student if selected
        if (currentStudent) {
            currentStudent = students.find(s => s.id === currentStudent.id);
        }
        
        saveData();
        
        // Update alle interfaces
        updateStatistics();
        renderStudentsList();
        renderTasksList();
        renderLogbookContent();
        renderFeedbackContent();
        renderTimelineContent();
        updateDashboardStudentSelector();
        
        // Update current student interface if applicable
        if (currentStudent) {
            updateSidebar();
            renderStudentTasks();
            updateDashboardTokenGrid();
            updateDashboardMilestones();
            updatePortfolioSummary();
        }
        
        console.log('✅ Student progress reset completed');
        showNotification(`Student voortgang gereset! ${students.length} studenten zijn teruggezet naar 0.`, 'success');
        
        // Trigger cloud sync if enabled
        autoSync();
    }
}
        function resetAllData() {
            if (confirm('Weet je zeker dat je alle data wilt resetten? Dit kan niet ongedaan worden gemaakt.')) {
                localStorage.removeItem('integratedLearningSystem');
                
                students = [];
                tasks = [];
                logbookEntries = [];
                feedbackEntries = [];
                personalGoals = [];
                milestones = [];
                customTokens = [];
                timeline = [];
                groups = [];
                currentStudent = null;
                currentGridSize = 2;
                teacherPassword = 'leraar123';
                
                saveData();
                init();
                showNotification('Alle data gereset en opslag opgeschoond!', 'success');
            }
        }

        function showNotification(message, type = 'success') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function checkStorageStatus() {
            try {
                const testKey = 'storageTest';
                const testData = 'x'.repeat(1024);
                localStorage.setItem(testKey, testData);
                localStorage.removeItem(testKey);
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showNotification('⚠️ Opslag bijna vol! Gebruik "Opschonen" knop.', 'warning');
                }
            }
        }

        // Add placeholder functions for missing functionality
        function addStudentForm() { addStudent(); }
        function updateStatistics() {
            const totalStudentsCount = students.length;
            const totalTasksCount = tasks.length;
            const totalGroupsCount = groups.length;
            const totalTokensCount = students.reduce((sum, s) => sum + (s.tokens?.length || 0), 0);
            const totalComplimentsCount = feedbackEntries.length;
            const totalSkillsCount = students.reduce((sum, s) => sum + Object.values(s.skills || {}).reduce((skillSum, skill) => skillSum + Math.floor(skill/10), 0), 0);
            const totalMilestonesCount = students.reduce((sum, s) => sum + (s.achievedMilestones?.length || 0), 0);
			// ← VOEG DEZE REGEL TOE:
    const totalReflectionCardsCount = Object.values(reflectionCards).reduce((sum, cards) => sum + cards.length, 0);
            const avgTokensCount = totalStudentsCount > 0 ? Math.round(totalTokensCount / totalStudentsCount * 10) / 10 : 0;

            document.getElementById('totalStudents').textContent = totalStudentsCount;
            document.getElementById('totalTasks').textContent = totalTasksCount;
            document.getElementById('totalGroups').textContent = totalGroupsCount;
            document.getElementById('totalTokens').textContent = totalTokensCount;
            document.getElementById('totalCompliments').textContent = totalComplimentsCount;
            document.getElementById('totalSkills').textContent = totalSkillsCount;
            document.getElementById('totalMilestones').textContent = totalMilestonesCount;
            document.getElementById('avgTokens').textContent = avgTokensCount;
			document.getElementById('totalReflectionCards').textContent = totalReflectionCardsCount;
        }

        function renderStudentsList() {
            const container = document.getElementById('studentsList');
            
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Nog geen leerlingen toegevoegd</p>';
                return;
            }

            container.innerHTML = students.map(student => {
                const totalTokens = student.tokens?.length || 0;
                const totalMilestones = student.achievedMilestones?.length || 0;
                const avgSkill = Math.round(Object.values(student.skills || {}).reduce((sum, val) => sum + val, 0) / 5);
                const completedTasks = student.completedTasks?.length || 0;
                const totalAssignedTasks = tasks.filter(task => task.assignedStudents.includes(student.id)).length;
                const group = student.groupId ? groups.find(g => g.id === student.groupId) : null;

                return `
                    <div style="background: #f8f9ff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3>${student.name} ${student.pin ? `(PIN: ${student.pin})` : '(Geen PIN)'}</h3>
                                <div style="color: #666; margin-top: 5px;">
                                    📋 ${completedTasks}/${totalAssignedTasks} taken | 🎨 ${totalTokens} tokens | 🏆 ${totalMilestones} mijlpalen | 📊 ${avgSkill}% gem. vaardigheid
                                    ${group ? ` | 👥 ${group.name}` : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-info btn-small" onclick="viewStudentDetails('${student.id}')">👁️ Bekijken</button>
                                <button class="btn btn-danger btn-small" onclick="deleteStudent('${student.id}')">🗑️ Verwijderen</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewStudentDetails(studentId) {
            if (userRole === 'teacher') {
                switchMode('student');
                document.getElementById('dashboardStudentSelector').value = studentId;
                selectDashboardStudent(studentId);
            }
        }

        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;

            if (confirm(`Weet je zeker dat je ${student.name} wilt verwijderen?`)) {
                groups.forEach(group => {
                    group.members = group.members.filter(memberId => memberId !== studentId);
                });
                
                students = students.filter(s => s.id !== studentId);
                
                // Clean up related data
                logbookEntries = logbookEntries.filter(entry => entry.studentId !== studentId);
                feedbackEntries = feedbackEntries.filter(entry => entry.studentId !== studentId);
                personalGoals = personalGoals.filter(goal => goal.studentId !== studentId);
                
                saveData();
                updateStatistics();
                renderStudentsList();
                renderGroupsList();
                updateDashboardStudentSelector();
                renderPinList();
                showNotification(`${student.name} verwijderd`, 'success');
                addToTimeline(`👤 Leerling verwijderd: ${student.name}`, null);
            }
        }

       // Alle ontbrekende functies - Vervang de TODO stub functies hiermee

// Groepen beheer
function renderGroupsList() {
    const container = document.getElementById('groupsList');
    
    if (groups.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nog geen groepen aangemaakt</p>';
        return;
    }

    container.innerHTML = groups.map(group => {
        const memberNames = group.members.map(memberId => {
            const student = students.find(s => s.id === memberId);
            return student ? student.name : 'Onbekende leerling';
        });

        return `
            <div style="background: #f8f9ff; border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3>${group.icon || '👥'} ${group.name}</h3>
                        <div style="color: #666; margin-top: 5px;">
                            👤 ${group.members.length} leden: ${memberNames.join(', ') || 'Geen leden'}
                        </div>
                        ${group.description ? `<div style="color: #666; margin-top: 5px; font-style: italic;">${group.description}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-info btn-small" onclick="editGroup('${group.id}')">✏️ Bewerken</button>
                        <button class="btn btn-warning btn-small" onclick="manageGroupMembers('${group.id}')">👥 Leden</button>
                        <button class="btn btn-danger btn-small" onclick="deleteGroup('${group.id}')">🗑️ Verwijderen</button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function showGroupForm(groupId = null) {
    const form = document.getElementById('groupForm');
    const title = document.getElementById('groupFormTitle');
    
    if (groupId) {
        const group = groups.find(g => g.id === groupId);
        if (group) {
            title.textContent = 'Groep Bewerken';
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupDescription').value = group.description || '';
        }
    } else {
        title.textContent = 'Nieuwe Groep';
        document.getElementById('groupName').value = '';
        document.getElementById('groupDescription').value = '';
    }
    
    form.style.display = 'block';
    document.getElementById('groupName').focus();
}

function saveGroup() {
    const name = document.getElementById('groupName').value.trim();
    const description = document.getElementById('groupDescription').value.trim();
    
    if (!name) {
        showNotification('Voer een groepsnaam in!', 'error');
        return;
    }

    const groupData = {
        name: name,
        description: description,
        icon: '👥',
        members: [],
        timestamp: new Date().toISOString()
    };

    const existingGroupIndex = groups.findIndex(g => g.name === name);
    
    if (existingGroupIndex >= 0) {
        groups[existingGroupIndex] = { ...groups[existingGroupIndex], ...groupData };
        addToTimeline(`👥 Groep bijgewerkt: ${name}`, null);
    } else {
        const newGroup = {
            id: generateId(),
            ...groupData
        };
        groups.push(newGroup);
        addToTimeline(`👥 Nieuwe groep aangemaakt: ${name}`, null);
    }

    cancelGroupForm();
    renderGroupsList();
    saveData();
    updateStatistics();
    
    showNotification('Groep opgeslagen!', 'success');
}

function cancelGroupForm() {
    document.getElementById('groupForm').style.display = 'none';
}

function editGroup(groupId) {
    showGroupForm(groupId);
}

function deleteGroup(groupId) {
    const group = groups.find(g => g.id === groupId);
    if (!group) return;

    if (confirm(`Weet je zeker dat je groep "${group.name}" wilt verwijderen?`)) {
        // Remove group from students
        students.forEach(student => {
            if (student.groupId === groupId) {
                student.groupId = null;
            }
        });
        
        groups = groups.filter(g => g.id !== groupId);
        
        addToTimeline(`👥 Groep verwijderd: ${group.name}`, null);
        renderGroupsList();
        renderStudentsList();
        saveData();
        updateStatistics();
        showNotification(`Groep "${group.name}" verwijderd`, 'success');
    }
}

function manageGroupMembers(groupId) {
    const group = groups.find(g => g.id === groupId);
    if (!group) return;

    // Verdeel studenten in categorieën
    const availableStudents = []; // Studenten zonder groep of in deze groep
    const unavailableStudents = []; // Studenten in andere groepen
    
    students.forEach(student => {
        if (!student.groupId || student.groupId === groupId) {
            availableStudents.push(student);
        } else {
            // Zoek groepsnaam voor student in andere groep
            const otherGroup = groups.find(g => g.id === student.groupId);
            unavailableStudents.push({
                ...student,
                otherGroupName: otherGroup ? otherGroup.name : 'Onbekende groep'
            });
        }
    });

    const modal = document.createElement('div');
    modal.className = 'modal show';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <h3>👥 Leden beheren - ${group.name}</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">Selecteer welke leerlingen in deze groep zitten:</p>
            
            <div style="max-height: 350px; overflow-y: auto; border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px;">
                
                ${availableStudents.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #48bb78; margin-bottom: 10px; font-size: 1rem;">✅ Beschikbare leerlingen:</h4>
                        ${availableStudents.map(student => `
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 6px; background: ${group.members.includes(student.id) ? '#f0fff4' : '#f8f9ff'}; border: 1px solid ${group.members.includes(student.id) ? '#48bb78' : '#e2e8f0'};">
                                <input type="checkbox" ${group.members.includes(student.id) ? 'checked' : ''} 
                                       onchange="toggleGroupMember('${groupId}', '${student.id}', this.checked)">
                                <span style="font-weight: ${group.members.includes(student.id) ? 'bold' : 'normal'};">${student.name}</span>
                                ${group.members.includes(student.id) ? '<span style="color: #48bb78; margin-left: auto;">👥 Lid van deze groep</span>' : ''}
                            </label>
                        `).join('')}
                    </div>
                ` : ''}
                
                ${unavailableStudents.length > 0 ? `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #ed8936; margin-bottom: 10px; font-size: 1rem;">⚠️ Al toegewezen aan andere groepen:</h4>
                        ${unavailableStudents.map(student => `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px; border-radius: 6px; background: #fef3c7; border: 1px solid #fbbf24; opacity: 0.7;">
                                <input type="checkbox" disabled style="cursor: not-allowed;">
                                <span style="color: #92400e;">${student.name}</span>
                                <span style="color: #d97706; margin-left: auto; font-size: 0.9rem;">👥 ${student.otherGroupName}</span>
                            </div>
                        `).join('')}
                        <p style="font-size: 0.9rem; color: #d97706; font-style: italic; margin-top: 10px;">
                            💡 Om deze leerlingen toe te voegen, verwijder ze eerst uit hun huidige groep.
                        </p>
                    </div>
                ` : ''}
                
                ${availableStudents.length === 0 && unavailableStudents.length === 0 ? `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                        <p>Geen leerlingen beschikbaar</p>
                    </div>
                ` : ''}
                
            </div>
            
            <div style="text-align: center; margin-top: 1.5rem;">
                <button class="btn btn-success" onclick="this.closest('.modal').remove(); renderGroupsList(); renderStudentsList(); saveData();">
                    ✅ Opslaan (${group.members.length} leden)
                </button>
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white; margin-left: 10px;">
                    Annuleren
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function toggleGroupMember(groupId, studentId, isChecked) {
    const group = groups.find(g => g.id === groupId);
    const student = students.find(s => s.id === studentId);
    
    if (!group || !student) return;

    if (isChecked) {
        // Add to group
        if (!group.members.includes(studentId)) {
            group.members.push(studentId);
        }
        student.groupId = groupId;
    } else {
        // Remove from group
        group.members = group.members.filter(id => id !== studentId);
        student.groupId = null;
    }
}

// Timeline functies
function updateTimelineFilter() {
    const filter = document.getElementById('timelineFilter');
    if (!filter) return;
    
    const currentValue = filter.value;
    filter.innerHTML = '<option value="">Alle leerlingen</option>' +
        students.map(student => 
            `<option value="${student.id}" ${currentValue === student.id ? 'selected' : ''}>${student.name}</option>`
        ).join('');
    
    filter.addEventListener('change', function() {
        renderTimelineContent();
    });
}

function renderTimelineContent() {
    const container = document.getElementById('timelineContent');
    const filter = document.getElementById('timelineFilter');
    const selectedStudentId = filter ? filter.value : '';
    
    let filteredTimeline = timeline;
    if (selectedStudentId) {
        filteredTimeline = timeline.filter(entry => entry.studentId === selectedStudentId);
    }

    if (filteredTimeline.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Geen tijdlijn activiteiten gevonden</p>';
        return;
    }

    // Group by date
    const groupedByDate = {};
    filteredTimeline.forEach(entry => {
        const date = new Date(entry.timestamp).toLocaleDateString('nl-NL');
        if (!groupedByDate[date]) {
            groupedByDate[date] = [];
        }
        groupedByDate[date].push(entry);
    });

    let html = '<div class="timeline-container">';
    
    Object.keys(groupedByDate)
        .sort((a, b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')))
        .forEach(date => {
            html += `<div class="timeline-date-header">📅 ${date}</div>`;
            
            groupedByDate[date]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach(entry => {
                    const student = entry.studentId ? students.find(s => s.id === entry.studentId) : null;
                    const time = new Date(entry.timestamp).toLocaleTimeString('nl-NL', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-student-name">
                                ${student ? student.name : 'Systeem'}
                            </div>
                            <div class="timeline-description">${entry.description}</div>
                            <div class="timeline-time">⏰ ${time}</div>
                        </div>
                    `;
                });
        });
    
    html += '</div>';
    container.innerHTML = html;
}

function exportTimeline() {
    const filter = document.getElementById('timelineFilter');
    const selectedStudentId = filter ? filter.value : '';
    const selectedStudent = selectedStudentId ? students.find(s => s.id === selectedStudentId) : null;
    
    let dataToExport = timeline;
    if (selectedStudentId) {
        dataToExport = timeline.filter(entry => entry.studentId === selectedStudentId);
    }

    const exportData = {
        exportType: 'timeline',
        exportDate: new Date().toISOString(),
        filter: selectedStudent ? selectedStudent.name : 'Alle leerlingen',
        timeline: dataToExport.map(entry => {
            const student = entry.studentId ? students.find(s => s.id === entry.studentId) : null;
            return {
                datum: new Date(entry.timestamp).toLocaleDateString('nl-NL'),
                tijd: new Date(entry.timestamp).toLocaleTimeString('nl-NL'),
                leerling: student ? student.name : 'Systeem',
                beschrijving: entry.description
            };
        })
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    const filename = selectedStudent 
        ? `tijdlijn-${selectedStudent.name.replace(/\s+/g, '-')}-${new Date().toISOString().slice(0, 10)}.json`
        : `tijdlijn-alle-leerlingen-${new Date().toISOString().slice(0, 10)}.json`;
    link.download = filename;
    link.click();
    
    showNotification('Tijdlijn geëxporteerd!', 'success');
}

// Sidebar view functies
function showTasksView() {
    showSidebarView('📋 Alle Taken', renderTasksViewContent());
}

function showSkillsView() {
    showSidebarView('📊 Vaardigheden Detailweergave', renderSkillsViewContent());
}

function showTokensView() {
    showSidebarView('🎨 Token Collectie', renderTokensViewContentImproved()); // ← NIEUWE
}

function showMilestonesView() {
    showSidebarView('🏆 Alle Mijlpalen', renderMilestonesViewContent());
}

function showSidebarView(title, content) {
    if (!currentStudent) return;
    
    const panel = document.getElementById('sidebarViewPanel');
    const titleElement = document.getElementById('sidebarViewTitle');
    const contentElement = document.getElementById('sidebarViewContent');
    
    titleElement.textContent = title;
    contentElement.innerHTML = content;
    panel.style.display = 'block';
    
    // Scroll to top of panel
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function closeSidebarView() {
    const panel = document.getElementById('sidebarViewPanel');
    panel.style.display = 'none';
}

function renderTasksViewContent() {
    if (!currentStudent) return '<p>Geen leerling geselecteerd</p>';
    
    const studentTasks = tasks.filter(task => task.assignedStudents.includes(currentStudent.id));
    
    if (studentTasks.length === 0) {
        return '<p style="text-align: center; color: #666;">Geen taken toegewezen aan deze leerling</p>';
    }

    const completedTasks = studentTasks.filter(task => currentStudent.completedTasks.includes(task.id));
    const pendingTasks = studentTasks.filter(task => !currentStudent.completedTasks.includes(task.id));
    
    let html = `
        <div style="margin-bottom: 2rem;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 2rem;">
                <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${completedTasks.length}</div>
                    <div>Voltooid</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${pendingTasks.length}</div>
                    <div>Nog te doen</div>
                </div>
                <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${Math.round((completedTasks.length / studentTasks.length) * 100)}%</div>
                    <div>Voltooiingspercentage</div>
                </div>
            </div>
        </div>
    `;

    if (pendingTasks.length > 0) {
        html += '<h4>⏳ Nog te voltooien</h4><div style="margin-bottom: 2rem;">';
        pendingTasks.forEach(task => {
            const isOverdue = new Date(task.date) < new Date();
            html += `
                <div style="background: ${isOverdue ? '#fed7d7' : '#fef3c7'}; border: 2px solid ${isOverdue ? '#feb2b2' : '#fbbf24'}; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="font-weight: bold;">${task.title} ${isOverdue ? '⚠️ Verlopen' : ''}</div>
                    <div style="color: #666; margin-top: 5px;">📚 ${task.subject} | 📅 ${new Date(task.date).toLocaleDateString('nl-NL')}</div>
                    ${task.goal ? `<div style="color: #666; margin-top: 5px;">🎯 ${task.goal}</div>` : ''}
                </div>
            `;
        });
        html += '</div>';
    }

    if (completedTasks.length > 0) {
        html += '<h4>✅ Voltooid</h4><div>';
        completedTasks.forEach(task => {
            html += `
                <div style="background: #f0fff4; border: 2px solid #48bb78; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="font-weight: bold;">✅ ${task.title}</div>
                    <div style="color: #666; margin-top: 5px;">📚 ${task.subject} | 📅 ${new Date(task.date).toLocaleDateString('nl-NL')}</div>
                    ${task.goal ? `<div style="color: #666; margin-top: 5px;">🎯 ${task.goal}</div>` : ''}
                </div>
            `;
        });
        html += '</div>';
    }

    return html;
}

function renderSkillsViewContent() {
    if (!currentStudent) return '<p>Geen leerling geselecteerd</p>';
    
    const skills = currentStudent.skills || {};
    
    let html = '<div style="margin-bottom: 2rem;">';
    
    Object.keys(skillDefinitions).forEach(skillCode => {
        const skillData = skillDefinitions[skillCode];
        const value = Math.round(skills[skillCode]) || 0;
        const level = Math.floor(value / 100);
        const progress = value % 100;
        
        html += `
            <div style="margin-bottom: 2rem; background: #f8f9ff; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">${skillData.name} (${skillCode.toUpperCase()})</h4>
                    <div style="text-align: right;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">${value}%</div>
                        ${level > 0 ? `<div style="color: #ffd700; font-weight: bold;">⭐ Level ${level}</div>` : ''}
                    </div>
                </div>
                
                <div style="background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 10px;">
                    <div style="height: 100%; background: ${getSkillGradient(skillCode)}; width: ${Math.min(progress, 100)}%; transition: width 0.8s ease;"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: #666;">
                    <span>Voortgang naar level ${level + 1}</span>
                    <span>${progress}%</span>
                </div>
				
				   <!-- ← VOEG DEZE REFLECTIEKNOP TOE: -->
                <div style="text-align: center;">
                    <button class="btn btn-info btn-small" onclick="showReflectionCards('${skillCode}')" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2); border: none;">
                        🎴 Reflecteer op ${skillData.name}
                    </button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Recent skill awards
    const skillAwards = timeline.filter(entry => 
        entry.studentId === currentStudent.id && 
        (entry.description.includes('Token toegekend') || entry.description.includes('Taak voltooid'))
    ).slice(0, 10);
    
    if (skillAwards.length > 0) {
        html += '<h4>📈 Recente Vaardigheid Ontwikkeling</h4>';
        skillAwards.forEach(award => {
            html += `
                <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea;">
                    <div style="font-size: 0.9rem;">${award.description}</div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        📅 ${new Date(award.timestamp).toLocaleDateString('nl-NL')} om ${new Date(award.timestamp).toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            `;
        });
    }
    
    return html;
}

function renderTokensViewContentImproved() {
    if (!currentStudent) return '<p>Geen student geselecteerd</p>';
    
    // Layout selector
    const savedLayout = localStorage.getItem('tokenViewLayout') || 'grid';
    
    return `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
                <button onclick="setTokenViewLayout('grid')" style="padding: 8px 16px; border-radius: 6px; border: 2px solid ${savedLayout === 'grid' ? '#667eea' : '#e2e8f0'}; background: ${savedLayout === 'grid' ? '#667eea' : 'white'}; color: ${savedLayout === 'grid' ? 'white' : '#666'}; cursor: pointer;">
                    🔲 Grid Weergave
                </button>
                <button onclick="setTokenViewLayout('timeline')" style="padding: 8px 16px; border-radius: 6px; border: 2px solid ${savedLayout === 'timeline' ? '#667eea' : '#e2e8f0'}; background: ${savedLayout === 'timeline' ? '#667eea' : 'white'}; color: ${savedLayout === 'timeline' ? 'white' : '#666'}; cursor: pointer;">
                    📅 Tijdlijn Weergave
                </button>
                <button onclick="setTokenViewLayout('compact')" style="padding: 8px 16px; border-radius: 6px; border: 2px solid ${savedLayout === 'compact' ? '#667eea' : '#e2e8f0'}; background: ${savedLayout === 'compact' ? '#667eea' : 'white'}; color: ${savedLayout === 'compact' ? 'white' : '#666'}; cursor: pointer;">
                    📊 Compact Weergave
                </button>
            </div>
        </div>
        
        <div id="tokenViewContent">
            ${savedLayout === 'grid' ? renderTokensGridView() : 
              savedLayout === 'timeline' ? renderTokensTimelineView() : 
              renderTokensCompactView()}
        </div>
    `;
}
// GRID WEERGAVE - Kaarten in grid met samenvatting
function renderTokensGridView() {
    if (!currentStudent) return '<p>Geen student geselecteerd</p>';
    
    const allTokens = currentStudent.tokens || [];
    const tokenCounts = {};
    
    // Tel tokens per type
    allTokens.forEach(token => {
        tokenCounts[token.type] = (tokenCounts[token.type] || 0) + 1;
    });
    
    return `
        <div style="margin-bottom: 2rem;">
            <!-- Grote samenvatting -->
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
                <div style="font-size: 4rem; font-weight: bold; margin-bottom: 10px;">${allTokens.length}</div>
                <div style="font-size: 1.3rem;">Totaal Verdiende Tokens</div>
                <div style="font-size: 1rem; opacity: 0.8; margin-top: 8px;">Geweldig werk! 🎉</div>
            </div>
            
            <!-- Token types in grote kaarten -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                ${tokenTypes.map(tokenType => {
                    const count = tokenCounts[tokenType.id] || 0;
                    return `
                        <div style="background: ${tokenType.color}; color: white; padding: 25px; border-radius: 15px; text-align: center; transition: transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                            <div style="font-size: 4rem; margin-bottom: 15px;">${tokenType.emoji}</div>
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 8px;">${count}</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">${tokenType.name}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">${tokenType.description}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
}

// TIJDLIJN WEERGAVE - Chronologisch per maand
function renderTokensTimelineView() {
    if (!currentStudent) return '<p>Geen student geselecteerd</p>';
    
    const allTokens = currentStudent.tokens || [];
    
    if (allTokens.length === 0) {
        return `
            <div style="text-align: center; padding: 3rem; color: #666;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">📅</div>
                <h3>Nog geen tokens verdiend</h3>
                <p>Voltooi taken om je eerste tokens te verdienen!</p>
            </div>
        `;
    }
    
    // Groepeer tokens per maand
    const tokensByMonth = {};
    allTokens.forEach(token => {
        const date = new Date(token.timestamp);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('nl-NL', { year: 'numeric', month: 'long' });
        
        if (!tokensByMonth[monthKey]) {
            tokensByMonth[monthKey] = {
                name: monthName,
                tokens: []
            };
        }
        tokensByMonth[monthKey].tokens.push(token);
    });
    
    // Sorteer maanden (nieuwste eerst)
    const sortedMonths = Object.keys(tokensByMonth).sort().reverse();
    
    return `
        <div style="margin-bottom: 2rem;">
            <!-- Timeline Header -->
            <div style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 25px;">
                <div style="font-size: 2rem;">📅 Token Tijdlijn</div>
                <div style="font-size: 1.1rem; opacity: 0.9; margin-top: 8px;">${allTokens.length} tokens in ${sortedMonths.length} maand(en)</div>
            </div>
            
            <!-- Timeline Items -->
            ${sortedMonths.map((monthKey, index) => {
                const monthData = tokensByMonth[monthKey];
                const monthTokens = monthData.tokens;
                
                return `
                    <div style="position: relative; margin-bottom: 30px;">
                        <!-- Timeline Line -->
                        ${index < sortedMonths.length - 1 ? `
                            <div style="position: absolute; left: 20px; top: 80px; bottom: -30px; width: 3px; background: linear-gradient(to bottom, #667eea, #e2e8f0);"></div>
                        ` : ''}
                        
                        <!-- Timeline Node -->
                        <div style="position: absolute; left: 8px; top: 25px; width: 25px; height: 25px; background: #667eea; border-radius: 50%; border: 4px solid white; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);"></div>
                        
                        <!-- Month Content -->
                        <div style="margin-left: 50px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <div style="background: linear-gradient(135deg, #f7fafc, #edf2f7); padding: 20px; border-bottom: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0; color: #2d3748; font-size: 1.3rem;">📅 ${monthData.name}</h3>
                                    <span style="background: #667eea; color: white; padding: 8px 15px; border-radius: 20px; font-size: 1rem; font-weight: bold;">
                                        ${monthTokens.length} tokens
                                    </span>
                                </div>
                            </div>
                            <div style="padding: 20px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px;">
                                    ${monthTokens.map(token => {
                                        const tokenType = tokenTypes.find(t => t.id === token.type);
                                        const day = new Date(token.timestamp).getDate();
                                        const fullDate = new Date(token.timestamp).toLocaleDateString('nl-NL');
                                        return `
                                            <div style="background: ${tokenType?.color || '#ddd'}; padding: 12px; border-radius: 10px; text-align: center; transition: transform 0.2s;" title="${tokenType?.name} - ${fullDate}" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                                <div style="font-size: 1.8rem; margin-bottom: 5px;">${tokenType?.emoji || '?'}</div>
                                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.9); font-weight: bold;">${day}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

// COMPACTE WEERGAVE - Minimalistisch overzicht
function renderTokensCompactView() {
    if (!currentStudent) return '<p>Geen student geselecteerd</p>';
    
    const allTokens = currentStudent.tokens || [];
    const tokenCounts = {};
    
    // Tel tokens per type
    allTokens.forEach(token => {
        tokenCounts[token.type] = (tokenCounts[token.type] || 0) + 1;
    });
    
    // Recente tokens (laatste 15)
    const recentTokens = allTokens.slice(-15).reverse();
    
    return `
        <div style="margin-bottom: 2rem;">
            <!-- Compacte Header -->
            <div style="background: linear-gradient(135deg, #ed8936, #dd6b20); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-size: 3rem; font-weight: bold;">${allTokens.length}</div>
                        <div style="font-size: 1.1rem;">Totaal Tokens</div>
                    </div>
                    <div style="font-size: 4rem;">🏆</div>
                </div>
            </div>
            
            <!-- Compacte Token Tellers -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                <h4 style="margin: 0 0 15px 0; color: #2d3748;">📊 Overzicht per Type</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px;">
                    ${tokenTypes.map(tokenType => {
                        const count = tokenCounts[tokenType.id] || 0;
                        return `
                            <div style="display: flex; align-items: center; background: white; padding: 12px; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <div style="font-size: 1.8rem; margin-right: 10px;">${tokenType.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 1.2rem; color: ${tokenType.color};">${count}</div>
                                    <div style="font-size: 0.8rem; color: #666;">${tokenType.name}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            <!-- Recente Tokens Lijst -->
            ${recentTokens.length > 0 ? `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px solid #e2e8f0;">
                    <h4 style="margin: 0 0 15px 0; color: #2d3748;">⏰ Laatste ${Math.min(15, recentTokens.length)} Tokens</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px;">
                        ${recentTokens.map((token, index) => {
                            const tokenType = tokenTypes.find(t => t.id === token.type);
                            const date = new Date(token.timestamp);
                            const day = date.getDate();
                            const month = date.getMonth() + 1;
                            return `
                                <div style="background: ${tokenType?.color || '#ddd'}; padding: 8px; border-radius: 8px; text-align: center; font-size: 0.8rem;" title="${tokenType?.name} - ${date.toLocaleDateString('nl-NL')}">
                                    <div style="font-size: 1.2rem; margin-bottom: 2px;">${tokenType?.emoji || '?'}</div>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.7rem;">${day}/${month}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}


// Helper functies
function setTokenViewLayout(layout) {
    localStorage.setItem('tokenViewLayout', layout);
    
    // Update content
    const content = layout === 'grid' ? renderTokensGridView() : 
                   layout === 'timeline' ? renderTokensTimelineView() : 
                   renderTokensCompactView();
    
    document.getElementById('tokenViewContent').innerHTML = content;
    
    // Update button states
    document.querySelectorAll('[onclick^="setTokenViewLayout"]').forEach(btn => {
        const isActive = btn.onclick.toString().includes(`'${layout}'`);
        btn.style.border = `2px solid ${isActive ? '#667eea' : '#e2e8f0'}`;
        btn.style.background = isActive ? '#667eea' : 'white';
        btn.style.color = isActive ? 'white' : '#666';
    });
    
    showNotification(`Weergave gewijzigd naar ${layout}`, 'success');
}

function renderMilestonesViewContent() {
    if (!currentStudent) return '<p>Geen leerling geselecteerd</p>';
    
    const achievedMilestones = currentStudent.achievedMilestones || [];
    
    if (achievedMilestones.length === 0) {
        return '<p style="text-align: center; color: #666;">Nog geen mijlpalen behaald</p>';
    }

    let html = `
        <div style="text-align: center; margin-bottom: 2rem;">
            <div style="font-size: 3rem; font-weight: bold; color: #ffd700;">${achievedMilestones.length}</div>
            <div style="font-size: 1.2rem; color: #666;">Behaalde mijlpalen</div>
        </div>
    `;

    // Group by skill
    const milestonesBySkill = {};
    achievedMilestones.forEach(milestone => {
        const skill = milestones.find(m => m.id === milestone.milestoneId)?.skill || 'unknown';
        if (!milestonesBySkill[skill]) {
            milestonesBySkill[skill] = [];
        }
        milestonesBySkill[skill].push(milestone);
    });

    Object.keys(milestonesBySkill).forEach(skillCode => {
        const skillData = skillDefinitions[skillCode];
        const skillMilestones = milestonesBySkill[skillCode].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        html += `
            <div style="margin-bottom: 2rem;">
                <h4>${skillData ? skillData.name : skillCode.toUpperCase()}</h4>
                <div style="display: grid; gap: 15px;">
        `;
        
        skillMilestones.forEach(milestone => {
            html += `
                <div style="background: linear-gradient(135deg, #ffd700, #ffed4a); color: #2d3748; padding: 20px; border-radius: 15px; box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3); display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 3rem;">${milestone.badge}</div>
                    <div style="flex: 1;">
                        <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 5px;">${milestone.milestoneName}</div>
                        <div style="font-size: 1rem; margin-bottom: 5px;">Level ${milestone.level}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">${milestone.skillName}</div>
                    </div>
                    <div style="text-align: right; font-size: 0.8rem; opacity: 0.8;">
                        📅 ${new Date(milestone.timestamp).toLocaleDateString('nl-NL')}<br>
                        ⏰ ${new Date(milestone.timestamp).toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
    });

    return html;
}

// Mijlpalen beheer
function renderMilestonesList() {
    const container = document.getElementById('milestonesList');
    
    if (milestones.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nog geen mijlpalen aangemaakt</p>';
        return;
    }

    container.innerHTML = milestones.map(milestone => {
        const skillData = skillDefinitions[milestone.skill];
        const achievedCount = students.reduce((count, student) => {
            return count + (student.achievedMilestones?.filter(am => am.milestoneId === milestone.id).length || 0);
        }, 0);

        return `
            <div style="background: linear-gradient(135deg, #ffd700, #ffed4a); color: #2d3748; border-radius: 12px; padding: 20px; margin-bottom: 15px; display: flex; align-items: center; gap: 20px;">
                <div style="font-size: 3rem;">${milestone.badge}</div>
                <div style="flex: 1;">
                    <h3 style="margin-bottom: 8px;">${milestone.name}</h3>
                    <div style="margin-bottom: 5px;">🎯 Vaardigheid: ${skillData ? skillData.name : milestone.skill}</div>
                    <div>🏆 ${achievedCount}x behaald door leerlingen</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-info btn-small" onclick="editMilestone('${milestone.id}')" style="background: #2d3748; color: white;">✏️ Bewerken</button>
                    <button class="btn btn-danger btn-small" onclick="deleteMilestone('${milestone.id}')" style="background: #c53030; color: white;">🗑️ Verwijderen</button>
                </div>
            </div>
        `;
    }).join('');
}

function addMilestoneForm() {
    editingMilestoneId = null;
    document.getElementById('milestoneFormTitle').textContent = 'Nieuwe Mijlpaal';
    document.getElementById('milestoneName').value = '';
    document.getElementById('milestoneSkill').value = 'zb';
    document.getElementById('milestoneBadge').value = '🏆';
    document.getElementById('milestoneForm').style.display = 'block';
}

function editMilestone(milestoneId) {
    const milestone = milestones.find(m => m.id === milestoneId);
    if (!milestone) return;

    editingMilestoneId = milestoneId;
    document.getElementById('milestoneFormTitle').textContent = 'Mijlpaal Bewerken';
    document.getElementById('milestoneName').value = milestone.name;
    document.getElementById('milestoneSkill').value = milestone.skill;
    document.getElementById('milestoneBadge').value = milestone.badge;
    document.getElementById('milestoneForm').style.display = 'block';
}

function saveMilestone() {
    const name = document.getElementById('milestoneName').value.trim();
    const skill = document.getElementById('milestoneSkill').value;
    const badge = document.getElementById('milestoneBadge').value.trim();
    
    if (!name || !skill || !badge) {
        showNotification('Vul alle velden in!', 'error');
        return;
    }

    const milestoneData = { name, skill, badge, level: 1 };

    if (editingMilestoneId) {
        const index = milestones.findIndex(m => m.id === editingMilestoneId);
        if (index >= 0) {
            milestones[index] = { ...milestones[index], ...milestoneData };
            addToTimeline(`🏆 Mijlpaal bijgewerkt: ${name}`, null);
        }
    } else {
        const newMilestone = {
            id: generateId(),
            ...milestoneData
        };
        milestones.push(newMilestone);
        addToTimeline(`🏆 Nieuwe mijlpaal aangemaakt: ${name}`, null);
    }

    cancelMilestoneForm();
    renderMilestonesList();
    saveData();
    updateStatistics();
    
    showNotification('Mijlpaal opgeslagen!', 'success');
}

function cancelMilestoneForm() {
    document.getElementById('milestoneForm').style.display = 'none';
    editingMilestoneId = null;
}

function deleteMilestone(milestoneId) {
    const milestone = milestones.find(m => m.id === milestoneId);
    if (!milestone) return;

    if (confirm(`Weet je zeker dat je mijlpaal "${milestone.name}" wilt verwijderen?`)) {
        milestones = milestones.filter(m => m.id !== milestoneId);
        
        // Remove from students' achieved milestones
        students.forEach(student => {
            if (student.achievedMilestones) {
                student.achievedMilestones = student.achievedMilestones.filter(am => am.milestoneId !== milestoneId);
            }
        });
        
        addToTimeline(`🏆 Mijlpaal verwijderd: ${milestone.name}`, null);
        renderMilestonesList();
        saveData();
        updateStatistics();
        showNotification(`Mijlpaal "${milestone.name}" verwijderd`, 'success');
    }
}

function updateDashboardMilestones() {
    const container = document.getElementById('dashboardMilestones');
    
    if (!currentStudent) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om mijlpalen te bekijken</p>';
        return;
    }

    const achievedMilestones = currentStudent.achievedMilestones || [];
    
    if (achievedMilestones.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Nog geen mijlpalen behaald</p>';
        return;
    }

    // Show latest 6 milestones
    const recentMilestones = achievedMilestones
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 6);

    container.innerHTML = `
        <div class="milestones-grid">
            ${recentMilestones.map(milestone => `
                <div class="milestone-card">
                    <div class="milestone-badge">${milestone.badge}</div>
                    <div class="milestone-name">${milestone.milestoneName}</div>
                    <div class="milestone-skill">${milestone.skillName}</div>
                    <div class="milestone-level">Level ${milestone.level}</div>
                </div>
            `).join('')}
        </div>
        ${achievedMilestones.length > 6 ? `
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-info btn-small" onclick="showMilestonesView()">
                    🏆 Bekijk alle ${achievedMilestones.length} mijlpalen
                </button>
            </div>
        ` : ''}
    `;
}
// Portfolio functies
// Portfolio functies
function updatePortfolioSummary() {
    const container = document.getElementById('portfolioContent');
    
    if (!currentStudent) {
        container.innerHTML = '<p style="text-align: center; color: #666;">Selecteer een leerling om portfolio te bekijken</p>';
        return;
    }

    // Bereken portfolio statistieken
    const completedTasks = currentStudent.completedTasks?.length || 0;
    const totalTokens = currentStudent.tokens?.length || 0;
    const achievedMilestones = currentStudent.achievedMilestones?.length || 0;
    const logbookEntriesCount = logbookEntries.filter(entry => entry.studentId === currentStudent.id).length;
    const feedbackReceived = feedbackEntries.filter(entry => entry.studentId === currentStudent.id).length;
	const personalGoalsCount = currentStudent.personalGoals?.length || 0;
    const activeGoalsCount = currentStudent.personalGoals?.filter(g => g.status === 'active').length || 0;
    const avgSkill = Math.round(Object.values(currentStudent.skills || {}).reduce((sum, val) => sum + val, 0) / 5);

    // Recente activiteiten
    const recentActivities = timeline
        .filter(entry => entry.studentId === currentStudent.id)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 3);

    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 1.5rem;">
            <div style="background: #48bb78; color: white; padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">${completedTasks}</div>
                <div style="font-size: 0.8rem;">Taken</div>
            </div>
            <div style="background: #667eea; color: white; padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">${totalTokens}</div>
                <div style="font-size: 0.8rem;">Tokens</div>
            </div>
            <div style="background: #ffd700; color: #2d3748; padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">${achievedMilestones}</div>
                <div style="font-size: 0.8rem;">Mijlpalen</div>
            </div>
            <div style="background: #ed8936; color: white; padding: 10px; border-radius: 8px; text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold;">${avgSkill}%</div>
                <div style="font-size: 0.8rem;">Gemiddeld</div>
            </div>
        </div>

        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0;">
            <h4 style="margin-bottom: 10px; color: #667eea;">📈 Recente Activiteiten</h4>
            ${recentActivities.length > 0 ? 
                recentActivities.map(activity => `
                    <div style="padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                        <div>${activity.description}</div>
                        <div style="color: #666; font-size: 0.8rem; margin-top: 2px;">
                            ${new Date(activity.timestamp).toLocaleDateString('nl-NL')} om ${new Date(activity.timestamp).toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                    </div>
                `).join('') 
                : '<p style="color: #666; font-style: italic;">Nog geen activiteiten</p>'
            }
        </div>

        <div style="text-align: center; margin-top: 15px;">
            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-info btn-small" onclick="showPortfolioSection('logbook')" style="font-size: 0.8rem;">
                    📝 Logboek (${logbookEntriesCount})
                </button>
                <button class="btn btn-info btn-small" onclick="showPortfolioSection('feedback')" style="font-size: 0.8rem;">
                    💬 Feedback (${feedbackReceived})
                </button>
                <button class="btn btn-info btn-small" onclick="showPortfolioSection('goals')" style="font-size: 0.8rem;">
    🎯 Doelen (${activeGoalsCount}/${personalGoalsCount})
</button>
<button class="btn btn-info btn-small" onclick="showPortfolioSection('progress')" style="font-size: 0.8rem;">
    📊 Voortgang
</button>
            </div>
        </div>
    `;
}

function showFullPortfolio() {
    if (!currentStudent) return;
    
    showSidebarView('📁 Volledig Portfolio', renderFullPortfolioContent());
}

function showPortfolioSection(section) {
    if (!currentStudent) return;
    
    let title = '📁 Portfolio - ';
    let content = '';
    
    switch (section) {
        case 'logbook':
            title += 'Logboek Entries';
            content = renderPortfolioLogbookContent();
            break;
        case 'feedback':
            title += 'Ontvangen Feedback';
            content = renderPortfolioFeedbackContent();
            break;
		case 'goals':
            title += 'Persoonlijke Doelen';
            content = renderPersonalGoalsContent();
            break;
        case 'progress':
            title += 'Voortgang Overzicht';
            content = renderPortfolioProgressContent();
            break;
        default:
            content = '<p>Sectie niet gevonden</p>';
    }
    
    showSidebarView(title, content);
}

function renderFullPortfolioContent() {
    if (!currentStudent) return '<p>Geen student geselecteerd</p>';
    
    // Ensure personalGoals array exists
    if (!currentStudent.personalGoals) {
        currentStudent.personalGoals = [];
    }
    
    const completedTasks = tasks.filter(task => 
        task.assignedStudents.includes(currentStudent.id) && 
        currentStudent.completedTasks.includes(task.id)
    );
    
    const studentLogbook = logbookEntries.filter(entry => entry.studentId === currentStudent.id);
    const studentFeedback = feedbackEntries.filter(entry => entry.studentId === currentStudent.id);
    
    // Toegevoegde variabelen voor persoonlijke doelen
    const personalGoals = currentStudent.personalGoals || [];
    const activeGoals = personalGoals.filter(g => g.status === 'active');
    const completedGoals = personalGoals.filter(g => g.status === 'completed');
	const totalEvidence = personalGoals.reduce((sum, goal) => sum + (goal.evidence?.length || 0), 0);
    
    return `
        <div style="margin-bottom: 2rem;">
            <h4>📊 Portfolio Overzicht</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${completedTasks.length}</div>
                    <div>Voltooide Taken</div>
                </div>
                <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${(currentStudent.tokens || []).length}</div>
                    <div>Verdiende Tokens</div>
                </div>
                <div style="background: #ffd700; color: #2d3748; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${(currentStudent.achievedMilestones || []).length}</div>
                    <div>Behaalde Mijlpalen</div>
                </div>
                <div style="background: #ed8936; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${studentLogbook.length}</div>
                    <div>Logboek Entries</div>
                </div>
                <div style="background: #9c27b0; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: bold;">${activeGoals.length}</div>
                    <div>Actieve Doelen</div>
                </div>
				<div style="background: #9c27b0; color: white; padding: 15px; border-radius: 10px; text-align: center;">
    <div style="font-size: 2rem; font-weight: bold;">${totalEvidence}</div>
    <div>Bewijsstukken</div>
</div>
            </div>
        </div>

        <div style="margin-bottom: 2rem;">
    <h4>🎯 Persoonlijke Doelen</h4>
    ${personalGoals.length > 0 ? `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
            ${activeGoals.slice(0, 3).map(goal => {
                // Check of dit doel recent geëvalueerd is (zou kunnen betekenen dat het klaar is voor voltooiing)
                const recentEvaluation = goal.evaluations && goal.evaluations.length > 0 ? 
                    goal.evaluations[goal.evaluations.length - 1] : null;
                const isNearCompletion = recentEvaluation && recentEvaluation.progress >= 80;
                
                return `
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; position: relative;">
                    ${isNearCompletion ? `
                        <div style="position: absolute; top: -5px; right: -5px; background: #ffd700; color: #2d3748; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 8px rgba(255,215,0,0.5);">
                            🎯 Bijna klaar!
                        </div>
                    ` : ''}
                    <div style="font-weight: bold; margin-bottom: 8px;">${goal.title}</div>
                    <div style="font-size: 0.9rem; opacity: 0.9;">${goal.description || 'Geen beschrijving'}</div>
                    ${goal.deadline ? `
                        <div style="margin-top: 8px; font-size: 0.8rem; opacity: 0.8;">
                            📅 ${new Date(goal.deadline).toLocaleDateString('nl-NL')}
                        </div>
                    ` : ''}
                    ${isNearCompletion ? `
                        <div style="margin-top: 10px; text-align: center;">
                            <button onclick="completePersonalGoalWithConfirmation('${goal.id}')" 
                                    style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                                ✅ Voltooien
                            </button>
                        </div>
                    ` : ''}
                </div>
            `}).join('')}
        </div>
                ${userRole === 'student' ? `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <button class="btn btn-success btn-small" onclick="showPersonalGoalModal()">
                            ➕ Nieuw Doel Toevoegen
                        </button>
                    </div>
                ` : ''}
                <div style="text-align: center;">
                    <button class="btn btn-info btn-small" onclick="renderPersonalGoalsView()">
                        🎯 Bekijk alle doelen (${activeGoals.length} actief, ${completedGoals.length} voltooid)
                    </button>
                </div>
            ` : `
                <div style="text-align: center; padding: 2rem; background: #f8f9ff; border-radius: 10px; border: 2px dashed #667eea;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🎯</div>
                    <p style="color: #666; margin-bottom: 1rem;">Nog geen persoonlijke doelen gesteld</p>
                    ${userRole === 'student' ? `
                        <button class="btn btn-success" onclick="showPersonalGoalModal()">
                            ➕ Eerste Doel Toevoegen
                        </button>
                    ` : ''}
                </div>
            `}
        </div>

        ${renderPortfolioProgressContent()}

        <div style="margin-bottom: 2rem;">
            <h4>📝 Recente Logboek Entries</h4>
            ${studentLogbook.length > 0 ? 
                studentLogbook.slice(0, 3).map(entry => `
                    <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${entry.taskTitle}</div>
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 8px;">
                            📚 ${entry.subject} | 📅 ${new Date(entry.date).toLocaleDateString('nl-NL')}
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; font-size: 0.9rem;">
                            ${entry.content.length > 100 ? entry.content.substring(0, 100) + '...' : entry.content}
                        </div>
                    </div>
                `).join('') 
                : '<p style="color: #666; font-style: italic;">Nog geen logboek entries</p>'
            }
        </div>

        <div style="margin-bottom: 2rem;">
            <h4>💬 Ontvangen Feedback</h4>
            ${studentFeedback.length > 0 ? 
                studentFeedback.slice(0, 3).map(feedback => `
                    <div style="background: #f0fff4; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #48bb78;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${feedback.taskTitle}</div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="color: #ffd700; font-size: 1.2rem;">${'⭐'.repeat(feedback.rating)}</span>
                            <span style="color: #666; font-size: 0.9rem;">${feedback.rating}/5 sterren</span>
                        </div>
                        <div style="background: white; padding: 10px; border-radius: 4px; font-size: 0.9rem;">
                            ${feedback.feedback.length > 100 ? feedback.feedback.substring(0, 100) + '...' : feedback.feedback}
                        </div>
                    </div>
                `).join('') 
                : '<p style="color: #666; font-style: italic;">Nog geen feedback ontvangen</p>'
            }
        </div>
    `;
}

function renderPortfolioLogbookContent() {
    const studentLogbook = logbookEntries.filter(entry => entry.studentId === currentStudent.id)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
    if (studentLogbook.length === 0) {
        return '<p style="text-align: center; color: #666;">Nog geen logboek entries</p>';
    }

    return studentLogbook.map(entry => {
        const personalGoal = personalGoals.find(goal => 
            goal.taskId === entry.taskId && goal.studentId === entry.studentId
        );
        
        return `
            <div style="background: #f8f9ff; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e2e8f0;">
                <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 15px;">
                    <div>
                        <h4 style="margin-bottom: 5px;">${entry.taskTitle}</h4>
                        <div style="color: #666; font-size: 0.9rem;">
                            📚 ${entry.subject} | 📅 ${new Date(entry.date).toLocaleDateString('nl-NL')} om ${entry.time}
                        </div>
                        ${entry.goal ? `<div style="color: #666; font-size: 0.9rem; margin-top: 4px;">🎯 ${entry.goal}</div>` : ''}
                    </div>
                </div>
                
                ${personalGoal ? `
                    <div style="background: rgba(156, 39, 176, 0.1); border: 2px solid rgba(156, 39, 176, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <div style="font-weight: bold; color: #9333ea; margin-bottom: 5px;">💜 Persoonlijk Leerdoel:</div>
                        <div style="color: #6b21a8; font-style: italic;">${personalGoal.goal}</div>
                    </div>
                ` : ''}
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>Logboek:</strong><br>
                    ${entry.content.replace(/\n/g, '<br>')}
                </div>
                
                ${entry.reflection ? `
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                        <strong>Reflectie:</strong><br>
                        ${entry.reflection.replace(/\n/g, '<br>')}
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function renderPortfolioFeedbackContent() {
    const studentFeedback = feedbackEntries.filter(entry => entry.studentId === currentStudent.id)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        
    if (studentFeedback.length === 0) {
        return '<p style="text-align: center; color: #666;">Nog geen feedback ontvangen</p>';
    }

    return studentFeedback.map(feedback => `
        <div style="background: #f0fff4; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #48bb78;">
            <div style="margin-bottom: 15px;">
                <h4 style="margin-bottom: 5px;">${feedback.taskTitle}</h4>
                <div style="color: #666; font-size: 0.9rem;">
                    📚 ${feedback.subject} | 📅 ${new Date(feedback.date).toLocaleDateString('nl-NL')}
                </div>
                ${feedback.goal ? `<div style="color: #666; font-size: 0.9rem; margin-top: 4px;">🎯 ${feedback.goal}</div>` : ''}
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <span style="color: #ffd700; font-size: 1.5rem;">${'⭐'.repeat(feedback.rating)}</span>
                <span style="color: #666; font-weight: bold;">${feedback.rating}/5 sterren</span>
            </div>
            
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <strong>Feedback:</strong><br>
                ${feedback.feedback.replace(/\n/g, '<br>')}
            </div>
        </div>
    `).join('');
}
function getSkillGradient(skillCode) {
    const gradients = {
        zb: 'linear-gradient(90deg, #2196f3, #03a9f4)',
        zm: 'linear-gradient(90deg, #e91e63, #9c27b0)',
        sb: 'linear-gradient(90deg, #ffeb3b, #ffc107)',
        rv: 'linear-gradient(90deg, #4caf50, #8bc34a)',
        vb: 'linear-gradient(90deg, #ff9800, #f57c00)'
    };
    return gradients[skillCode] || 'linear-gradient(90deg, #667eea, #764ba2)';
}

function renderPortfolioProgressContent() {
    const skills = currentStudent.skills || {};
    
    return `
        <div style="margin-bottom: 2rem;">
            <h4>📊 Vaardigheden Voortgang</h4>
            ${Object.keys(skillDefinitions).map(skillCode => {
                const skillData = skillDefinitions[skillCode];
                const value = Math.round(skills[skillCode]) || 0;
                const level = Math.floor(value / 100);
                const progress = value % 100;
                
                return `
                    <div style="margin-bottom: 15px; background: #f8f9ff; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: bold;">${skillData.name}</span>
                            <div style="text-align: right;">
                                <div style="font-size: 1.2rem; font-weight: bold; color: #667eea;">${value}%</div>
                                ${level > 0 ? `<div style="color: #ffd700; font-weight: bold; font-size: 0.9rem;">⭐ Level ${level}</div>` : ''}
                            </div>
                        </div>
                        
                        <div style="background: #e2e8f0; height: 12px; border-radius: 6px; overflow: hidden;">
                            <div style="height: 100%; background: ${getSkillGradient(skillCode)}; width: ${Math.min(progress, 100)}%; transition: width 0.8s ease;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; color: #666;">
                            <span>Naar level ${level + 1}</span>
                            <span>${progress}/100</span>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}
// Persoonlijke Doelen functies
    let editingGoalId = null;

    function showPersonalGoalModal(goalId = null) {
        editingGoalId = goalId;
        const modal = document.getElementById('personalGoalModal');
        const title = document.getElementById('goalModalTitle');
        
        if (goalId) {
            const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
            if (goal) {
                title.textContent = '✏️ Doel Bewerken';
                document.getElementById('goalTitle').value = goal.title;
                document.getElementById('goalDescription').value = goal.description || '';
                document.getElementById('goalCategory').value = goal.category || 'academic';
                document.getElementById('goalDeadline').value = goal.deadline || '';
                
                // Set priority radio button
                const priorityRadio = document.querySelector(`input[name="goalPriority"][value="${goal.priority || 'low'}"]`);
                if (priorityRadio) priorityRadio.checked = true;
            }
        } else {
            title.textContent = '🎯 Nieuw Persoonlijk Doel';
            document.getElementById('goalTitle').value = '';
            document.getElementById('goalDescription').value = '';
            document.getElementById('goalCategory').value = 'academic';
            document.getElementById('goalDeadline').value = '';
            
            // Set default priority
            const defaultPriority = document.querySelector('input[name="goalPriority"][value="low"]');
            if (defaultPriority) defaultPriority.checked = true;
        }
        
        modal.classList.add('show');
        document.getElementById('goalTitle').focus();
    }

    // FIX 3: Verbeterde savePersonalGoal functie
function savePersonalGoal() {
    if (!currentStudent) {
        showNotification('Geen student geselecteerd!', 'error');
        return;
    }

    const title = document.getElementById('goalTitle').value.trim();
    const description = document.getElementById('goalDescription').value.trim();
    const category = document.getElementById('goalCategory').value;
    const deadline = document.getElementById('goalDeadline').value;
    const priority = document.querySelector('input[name="goalPriority"]:checked')?.value || 'low';

    if (!title) {
        showNotification('Voer een titel in voor je doel!', 'error');
        document.getElementById('goalTitle').focus();
        return;
    }

    // KRITIEKE FIX: Zorg ervoor dat personalGoals array bestaat
    if (!currentStudent.personalGoals) {
        currentStudent.personalGoals = [];
        console.log('🔧 Initialized personalGoals array for student:', currentStudent.name);
    }

    const goalData = {
        title,
        description,
        category,
        deadline,
        priority,
        status: 'active',
        createdAt: new Date().toISOString(),
        evidence: [],
        logbookEntries: [],
        evaluations: [],
        reflections: []
    };

    if (editingGoalId) {
        // Edit existing goal
        const goalIndex = currentStudent.personalGoals.findIndex(g => g.id === editingGoalId);
        if (goalIndex >= 0) {
            currentStudent.personalGoals[goalIndex] = { 
                ...currentStudent.personalGoals[goalIndex], 
                ...goalData 
            };
            addToTimeline(`🎯 Persoonlijk doel bijgewerkt: ${title}`, currentStudent.id);
            showNotification('Doel bijgewerkt!', 'success');
        }
    } else {
        // Create new goal
        const newGoal = {
            id: generateId(),
            ...goalData
        };
        currentStudent.personalGoals.push(newGoal);
        addToTimeline(`🎯 Nieuw persoonlijk doel gesteld: ${title}`, currentStudent.id);
        showNotification('Nieuw doel toegevoegd!', 'success');
        
        console.log('✅ Goal saved to student:', {
            studentName: currentStudent.name,
            goalTitle: title,
            totalGoals: currentStudent.personalGoals.length
        });
    }

    closePersonalGoalModal();
    
    // KRITIEKE FIX: Forceer save van alle student data
    saveData();
    
    // Update UI
    updatePortfolioSummary();
    renderPersonalGoalsView();
    
    console.log('💾 Data saved after goal creation');
}

// FIX 4: Debug functie om te controleren of doelen correct zijn opgeslagen
function debugPersonalGoals() {
    console.log('🔍 DEBUG: Personal Goals Status');
    console.log('Current Student:', currentStudent?.name || 'None selected');
    console.log('Student Goals:', currentStudent?.personalGoals?.length || 0);
    console.log('Global Goals (legacy):', personalGoals.length);
    
    if (currentStudent?.personalGoals) {
        console.log('Student Goals Details:', currentStudent.personalGoals.map(g => ({
            id: g.id,
            title: g.title,
            status: g.status
        })));
    }
    
    // Check localStorage
    const saved = localStorage.getItem('integratedLearningSystem');
    if (saved) {
        const data = JSON.parse(saved);
        const student = data.students?.find(s => s.id === currentStudent?.id);
        console.log('Saved Student Goals:', student?.personalGoals?.length || 0);
    }
}


    function closePersonalGoalModal() {
        document.getElementById('personalGoalModal').classList.remove('show');
        editingGoalId = null;
    }

    function editPersonalGoal(goalId) {
        showPersonalGoalModal(goalId);
    }

    function deletePersonalGoal(goalId) {
        if (!currentStudent || !currentStudent.personalGoals) return;

        const goal = currentStudent.personalGoals.find(g => g.id === goalId);
        if (!goal) return;

        if (confirm(`Weet je zeker dat je het doel "${goal.title}" wilt verwijderen?`)) {
            currentStudent.personalGoals = currentStudent.personalGoals.filter(g => g.id !== goalId);
            
            addToTimeline(`🗑️ Persoonlijk doel verwijderd: ${goal.title}`, currentStudent.id);
            saveData();
            updatePortfolioSummary();
            renderPersonalGoalsView();
            showNotification('Doel verwijderd', 'success');
        }
    }

function completePersonalGoalWithConfirmation(goalId) {
    if (!currentStudent || !currentStudent.personalGoals) return;

    const goal = currentStudent.personalGoals.find(g => g.id === goalId);
    if (!goal) return;

    // Create confirmation modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
            <h3 style="color: #48bb78; margin-bottom: 1rem;">Doel Voltooien</h3>
            
            <div style="background: linear-gradient(135deg, #f0fff4, #e6fffa); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 2px solid #48bb78;">
                <div style="font-weight: bold; font-size: 1.2rem; color: #2d3748; margin-bottom: 10px;">
                    "${goal.title}"
                </div>
                <div style="color: #666; font-size: 0.9rem;">
                    📂 ${getCategoryName(goal.category)} | 🔴 ${goal.priority === 'high' ? 'Hoge' : goal.priority === 'medium' ? 'Gemiddelde' : 'Lage'} prioriteit
                </div>
            </div>
            
            <p style="color: #2d3748; margin-bottom: 1.5rem; line-height: 1.5;">
                Gefeliciteerd! Weet je zeker dat je dit doel hebt bereikt?
            </p>
            
            <div style="background: #fff3cd; border: 2px solid #ffd700; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">🎁 Beloningen voor voltooiing:</div>
                <div style="color: #856404; font-size: 0.9rem;">
                    • 🚀 Raket Token<br>
                    • +10% Zelfbewustzijn<br>
                    • +5% Zelfmanagement<br>
                    • Mogelijk nieuwe mijlpaal!
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center;">
                <button class="btn btn-success" onclick="confirmCompleteGoal('${goalId}', this.closest('.modal'))" 
                        style="padding: 12px 24px; font-size: 1.1rem;">
                    ✅ Ja, Doel Bereikt!
                </button>
                <button class="btn" onclick="this.closest('.modal').remove()" 
                        style="background: #666; color: white; padding: 12px 24px;">
                    ❌ Annuleren
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function confirmCompleteGoal(goalId, modal) {
    completePersonalGoal(goalId);
    modal.remove();
}
    function completePersonalGoal(goalId) {
        if (!currentStudent || !currentStudent.personalGoals) return;

        const goal = currentStudent.personalGoals.find(g => g.id === goalId);
        if (!goal) return;

        goal.status = 'completed';
        goal.completedAt = new Date().toISOString();

        // Award token for completing personal goal
        const completionToken = {
            id: generateId(),
            type: 'rocket',
            source: 'personal_goal',
            timestamp: new Date().toISOString()
        };

        currentStudent.tokens = currentStudent.tokens || [];
        currentStudent.tokens.push(completionToken);

        // Bonus skills for goal completion
        const bonusSkills = { zb: 10, zm: 5 }; // Self-awareness and self-management boost
        let milestonesAchieved = [];

        Object.keys(bonusSkills).forEach(skillCode => {
            const increase = bonusSkills[skillCode];
            const oldValue = currentStudent.skills[skillCode] || 0;
            let newValue = oldValue + increase;
            
            if (newValue >= 100 && oldValue < 100) {
                const milestone = milestones.find(m => m.skill === skillCode);
                if (milestone) {
                    const achievedMilestone = {
                        id: generateId(),
                        milestoneId: milestone.id,
                        milestoneName: milestone.name,
                        skillName: skillDefinitions[skillCode].name,
                        badge: milestone.badge,
                        timestamp: new Date().toISOString(),
                        level: getNextMilestoneLevel(currentStudent, skillCode)
                    };

                    currentStudent.achievedMilestones = currentStudent.achievedMilestones || [];
                    currentStudent.achievedMilestones.push(achievedMilestone);
                    milestonesAchieved.push(achievedMilestone);
                    
                    addToTimeline(`🏆 MIJLPAAL BEHAALD: ${milestone.name} (Level ${achievedMilestone.level})`, currentStudent.id);
                }
                
                newValue = newValue - 100;
            }
            
            currentStudent.skills[skillCode] = newValue;
        });

        addToTimeline(`✅ Persoonlijk doel voltooid: ${goal.title} (+Token en Vaardigheden!)`, currentStudent.id);
        
        saveData();
        updateSidebar();
        updatePortfolioSummary();
        renderPersonalGoalsView();
        
        if (milestonesAchieved.length > 0) {
            milestonesAchieved.forEach(milestone => {
                setTimeout(() => showMilestoneNotification(milestone), 500);
            });
        } else {
            showNotification(`Doel "${goal.title}" voltooid! +Token en vaardigheden verhoogd!`, 'success');
        }
    }

    function renderPersonalGoalsView() {
        if (!currentStudent) return;
        
        showSidebarView('🎯 Mijn Persoonlijke Doelen', renderPersonalGoalsContent());
    }

    function renderPersonalGoalsContent() {
        if (!currentStudent) return '<p>Geen student geselecteerd</p>';

        const goals = currentStudent.personalGoals || [];
        const activeGoals = goals.filter(g => g.status === 'active');
        const completedGoals = goals.filter(g => g.status === 'completed');
        
        let html = `
            <div style="margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 2rem;">
                    <div style="background: #667eea; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;">${activeGoals.length}</div>
                        <div>Actieve Doelen</div>
                    </div>
                    <div style="background: #48bb78; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;">${completedGoals.length}</div>
                        <div>Voltooid</div>
                    </div>
                    <div style="background: #ffd700; color: #2d3748; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold;">${goals.length}</div>
                        <div>Totaal</div>
                    </div>
                </div>

                <div style="text-align: center; margin-bottom: 2rem;">
                    <button class="btn btn-success" onclick="showPersonalGoalModal()" style="padding: 12px 24px; font-size: 1.1rem;">
                        ➕ Nieuw Doel Toevoegen
                    </button>
                </div>
            </div>
        `;

        if (activeGoals.length > 0) {
            html += `
                <div style="margin-bottom: 2rem;">
                    <h4>🎯 Actieve Doelen</h4>
                    <div class="personal-goals-grid">
                        ${activeGoals.map(goal => renderGoalCard(goal)).join('')}
                    </div>
                </div>
            `;
        }

        if (completedGoals.length > 0) {
            html += `
                <div style="margin-bottom: 2rem;">
                    <h4>✅ Voltooide Doelen</h4>
                    <div class="personal-goals-grid">
                        ${completedGoals.slice(0, 5).map(goal => renderGoalCard(goal)).join('')}
                    </div>
                    ${completedGoals.length > 5 ? `
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn btn-info btn-small" onclick="showAllCompletedGoals()">
                                Bekijk alle ${completedGoals.length} voltooide doelen
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        if (goals.length === 0) {
            html += `
                <div style="text-align: center; padding: 3rem; color: #666;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">🎯</div>
                    <h3>Nog geen persoonlijke doelen</h3>
                    <p style="margin: 1rem 0;">Stel je eerste leerdoel op om je voortgang bij te houden!</p>
                    <button class="btn btn-success" onclick="showPersonalGoalModal()" style="padding: 12px 24px; font-size: 1.1rem;">
                        ➕ Eerste Doel Toevoegen
                    </button>
                </div>
            `;
        }

        return html;
    }

  function renderGoalCard(goal) {
    const isOverdue = goal.deadline && new Date(goal.deadline) < new Date() && goal.status === 'active';
    const isCompleted = goal.status === 'completed';
    
    // Check voor bestaande content
    const hasLogbook = goal.logbookEntries && goal.logbookEntries.length > 0;
    const hasEvaluations = goal.evaluations && goal.evaluations.length > 0;
    const hasReflections = goal.reflections && goal.reflections.length > 0;
	const hasEvidence = goal.evidence && goal.evidence.length > 0;
    
    // Check of doel bijna voltooid is gebaseerd op laatste evaluatie
    const lastEvaluation = hasEvaluations ? goal.evaluations[goal.evaluations.length - 1] : null;
    const isNearCompletion = lastEvaluation && lastEvaluation.progress >= 90;
    
    const categoryIcons = {
        academic: '📚',
        skill: '🎯', 
        personal: '💡',
        social: '🤝',
        creative: '🎨',
        other: '📌'
    };

    const priorityColors = {
        low: '#48bb78',
        medium: '#ed8936', 
        high: '#f56565'
    };

    const priorityLabels = {
        low: '🟢 Laag',
        medium: '🟡 Gemiddeld',
        high: '🔴 Hoog'
    };

    let cardClass = 'personal-goal-card';
    if (isCompleted) cardClass += ' completed';
    else if (isOverdue) cardClass += ' overdue';

    return `
        <div class="${cardClass}" onclick="editPersonalGoal('${goal.id}')">
            ${isCompleted ? '<div class="goal-status completed">✅ Voltooid</div>' : 
              isOverdue ? '<div class="goal-status overdue">⚠️ Verlopen</div>' : 
              isNearCompletion ? '<div class="goal-status" style="background: #ffd700; color: #2d3748;">🎯 Bijna klaar!</div>' :
              '<div class="goal-status">🎯 Actief</div>'}
            
            <div class="goal-main-actions">
                <button class="goal-action-btn" onclick="event.stopPropagation(); editPersonalGoal('${goal.id}')" title="Bewerken">✏️</button>
                <button class="goal-action-btn" onclick="event.stopPropagation(); deletePersonalGoal('${goal.id}')" title="Verwijderen">🗑️</button>
            </div>

            <div class="goal-header">
                <div>
                    <div class="goal-title">${goal.title}</div>
                    <div class="goal-category">
                        ${categoryIcons[goal.category] || '📌'} ${getCategoryName(goal.category)}
                    </div>
                </div>
            </div>

            ${goal.description ? `<div class="goal-description">${goal.description}</div>` : ''}
            
            ${isNearCompletion ? `
                <div style="background: rgba(255, 215, 0, 0.2); border: 2px solid #ffd700; border-radius: 8px; padding: 10px; margin: 10px 0; text-align: center;">
                    <div style="color: #856404; font-weight: bold; margin-bottom: 5px;">🎯 Laatste evaluatie: ${lastEvaluation.progress}%</div>
                    <div style="color: #856404; font-size: 0.9rem;">Dit doel lijkt bijna voltooid!</div>
                </div>
            ` : ''}

            <div class="goal-meta">
                <div class="goal-priority" style="color: ${priorityColors[goal.priority] || '#48bb78'};">
                    ${priorityLabels[goal.priority] || '🟢 Laag'}
                </div>
                ${goal.deadline ? `
                    <div class="goal-deadline">
                        📅 ${new Date(goal.deadline).toLocaleDateString('nl-NL')}
                    </div>
                ` : ''}
            </div>

            <!-- NIEUWE ACTIE KNOPPEN -->
            <div class="goal-extra-actions" onclick="event.stopPropagation();">
                ${!isCompleted ? `
                    <button class="goal-extra-btn complete-btn" onclick="completePersonalGoalWithConfirmation('${goal.id}')" 
                            title="Markeer dit doel als voltooid">
                        ✅ Doel Voltooien
                    </button>
                ` : ''}
                <button class="goal-extra-btn ${hasLogbook ? 'has-content' : ''}" 
                        onclick="showGoalLogbook('${goal.id}')" 
                        title="Logboek bijhouden">
                    📝 Logboek ${hasLogbook ? `(${goal.logbookEntries.length})` : ''}
                </button>
                <button class="goal-extra-btn ${hasEvaluations ? 'has-content' : ''}" 
                        onclick="showGoalEvaluation('${goal.id}')" 
                        title="Voortgang evalueren">
                    📊 Evaluatie ${hasEvaluations ? `(${goal.evaluations.length})` : ''}
                </button>
                <button class="goal-extra-btn ${hasReflections ? 'has-content' : ''}" 
                        onclick="showGoalReflection('${goal.id}')" 
                        title="Reflecteren op doel">
                    🤔 Reflectie ${hasReflections ? `(${goal.reflections.length})` : ''}
                </button>
				<button class="goal-extra-btn ${hasEvidence ? 'has-content' : ''}" 
        onclick="showGoalEvidence('${goal.id}')" 
        title="Bewijsstukken uploaden">
    📎 Bewijsstukken ${hasEvidence ? `(${goal.evidence.length})` : ''}
</button>
                <button class="goal-extra-btn" 
                        onclick="showGoalTimeline('${goal.id}')" 
                        title="Bekijk alle activiteiten voor dit doel">
                    📅 Tijdlijn
                </button>
            </div>
            </div>
        </div>
    `;
}

    function getCategoryName(category) {
        const categoryNames = {
            academic: 'Academisch',
            skill: 'Vaardigheid',
            personal: 'Persoonlijk', 
            social: 'Sociaal',
            creative: 'Creatief',
            other: 'Anders'
        };
        return categoryNames[category] || 'Anders';
    }
	 // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async () => {
    await init();
});
	// === PERSOONLIJKE DOELEN PORTFOLIO FUNCTIES ===

function showGoalLogbook(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (!goal.logbookEntries) {
        goal.logbookEntries = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">📝 Logboek - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>🎯 ${goal.logbookEntries.length} entries</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>✍️ Nieuwe Logboek Entry</h4>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Wat heb je gedaan voor dit doel?</label>
                    <textarea id="goalLogbookContent" style="width: 100%; height: 80px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Beschrijf wat je vandaag hebt gedaan om dit doel te bereiken..."></textarea>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Hoe voel je je over je voortgang?</label>
                    <textarea id="goalLogbookReflection" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat ging goed? Wat was moeilijk? Hoe voel je je?"></textarea>
                </div>
                <button class="btn btn-success" onclick="saveGoalLogbookEntry('${goalId}', this.closest('.modal'))">
                    💾 Entry Opslaan
                </button>
            </div>
            
            <div class="goal-content-section">
                <h4>📚 Eerdere Logboek Entries (${goal.logbookEntries.length})</h4>
                <div class="goal-entries-list">
                    ${goal.logbookEntries.length > 0 ? 
                        goal.logbookEntries.slice().reverse().map(entry => `
                            <div class="goal-entry">
                                <div class="goal-entry-header">
                                    <span class="goal-entry-date">📅 ${new Date(entry.date).toLocaleDateString('nl-NL')} om ${entry.time}</span>
                                    <div class="goal-entry-actions">
                                        <button class="goal-action-btn" onclick="deleteGoalEntry('${goalId}', '${entry.id}', 'logbookEntries', this.closest('.modal'))" title="Verwijderen">🗑️</button>
                                    </div>
                                </div>
                                <div class="goal-entry-content">
                                    <strong>Activiteit:</strong><br>${entry.content}<br><br>
                                    ${entry.reflection ? `<strong>Reflectie:</strong><br>${entry.reflection}` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen logboek entries</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function showGoalEvaluation(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (!goal.evaluations) {
        goal.evaluations = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">📊 Evaluatie - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>📊 ${goal.evaluations.length} evaluaties</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>📈 Nieuwe Voortgang Evaluatie</h4>
                
                <div class="evaluation-rating">
                    <label style="font-weight: bold;">Hoe schat je je voortgang in? (1-5 sterren)</label>
                    <div class="rating-stars" id="goalProgressRating">
                        <span class="rating-star" onclick="setGoalRating(1)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(2)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(3)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(4)">⭐</span>
                        <span class="rating-star" onclick="setGoalRating(5)">⭐</span>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Voortgang percentage (0-100%)</label>
                    <input type="range" id="goalProgressSlider" class="progress-slider" min="0" max="100" value="50" 
                           onchange="updateProgressDisplay(this.value)">
                    <div class="progress-display" id="progressDisplay">50%</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Wat gaat goed?</label>
                    <textarea id="goalEvalPositive" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat loopt goed met dit doel? Welke vooruitgang zie je?"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Wat kan beter?</label>
                    <textarea id="goalEvalChallenges" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat zijn de uitdagingen? Waar loop je tegenaan?"></textarea>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Volgende stappen</label>
                    <textarea id="goalEvalNextSteps" style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Wat ga je de komende tijd doen om verder te komen?"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="saveGoalEvaluation('${goalId}', this.closest('.modal'))">
                    📊 Evaluatie Opslaan
                </button>
            </div>
            
            <div class="goal-content-section">
                <h4>📈 Eerdere Evaluaties (${goal.evaluations.length})</h4>
                <div class="goal-entries-list">
                    ${goal.evaluations.length > 0 ? 
                        goal.evaluations.slice().reverse().map(evaluation => `
                            <div class="goal-entry">
                                <div class="goal-entry-header">
                                    <span class="goal-entry-date">📅 ${new Date(evaluation.date).toLocaleDateString('nl-NL')} om ${evaluation.time}</span>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="color: #ffd700;">${'⭐'.repeat(evaluation.rating || 3)}</span>
                                        <span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem;">${evaluation.progress || 0}%</span>
                                        <button class="goal-action-btn" onclick="deleteGoalEntry('${goalId}', '${evaluation.id}', 'evaluations', this.closest('.modal'))" title="Verwijderen">🗑️</button>
                                    </div>
                                </div>
                                <div class="goal-entry-content">
                                    ${evaluation.positive ? `<strong>✅ Gaat goed:</strong><br>${evaluation.positive}<br><br>` : ''}
                                    ${evaluation.challenges ? `<strong>⚠️ Uitdagingen:</strong><br>${evaluation.challenges}<br><br>` : ''}
                                    ${evaluation.nextSteps ? `<strong>🎯 Volgende stappen:</strong><br>${evaluation.nextSteps}` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen evaluaties</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    setGoalRating(3);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function showGoalReflection(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (!goal.reflections) {
        goal.reflections = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">🤔 Reflectie - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>🤔 ${goal.reflections.length} reflecties</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>💭 Nieuwe Reflectie</h4>
                <p style="color: #667eea; font-style: italic; margin-bottom: 15px;">
                    Neem de tijd om na te denken over je doel en je ervaring ermee.
                </p>
                
                <div class="reflection-questions">
                    <div class="reflection-question">
                        <label>🎯 Waarom is dit doel belangrijk voor jou?</label>
                        <textarea id="goalReflectionWhy" placeholder="Wat motiveert je om dit doel te bereiken? Wat betekent het voor je?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>📈 Wat heb je geleerd tijdens het werken aan dit doel?</label>
                        <textarea id="goalReflectionLearned" placeholder="Welke inzichten heb je gekregen? Wat heb je over jezelf ontdekt?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>💪 Welke sterke punten heb je gebruikt?</label>
                        <textarea id="goalReflectionStrengths" placeholder="Welke talenten, vaardigheden of eigenschappen hebben je geholpen?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>🌟 Wat zou je anders doen als je opnieuw begon?</label>
                        <textarea id="goalReflectionDifferent" placeholder="Welke aanpak zou je kiezen? Wat zou je eerder weten?"></textarea>
                    </div>
                    
                    <div class="reflection-question">
                        <label>🚀 Hoe ga je deze ervaring gebruiken voor toekomstige doelen?</label>
                        <textarea id="goalReflectionFuture" placeholder="Wat neem je mee? Hoe past dit in je verdere ontwikkeling?"></textarea>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveGoalReflection('${goalId}', this.closest('.modal'))" style="margin-top: 15px;">
                    💭 Reflectie Opslaan
                </button>
            </div>
            
            <div class="goal-content-section">
                <h4>🤔 Eerdere Reflecties (${goal.reflections.length})</h4>
                <div class="goal-entries-list">
                    ${goal.reflections.length > 0 ? 
                        goal.reflections.slice().reverse().map(reflection => `
                            <div class="goal-entry">
                                <div class="goal-entry-header">
                                    <span class="goal-entry-date">📅 ${new Date(reflection.date).toLocaleDateString('nl-NL')} om ${reflection.time}</span>
                                    <div class="goal-entry-actions">
                                        <button class="goal-action-btn" onclick="deleteGoalEntry('${goalId}', '${reflection.id}', 'reflections', this.closest('.modal'))" title="Verwijderen">🗑️</button>
                                    </div>
                                </div>
                                <div class="goal-entry-content">
                                    ${reflection.why ? `<strong>🎯 Waarom belangrijk:</strong><br>${reflection.why}<br><br>` : ''}
                                    ${reflection.learned ? `<strong>📈 Geleerd:</strong><br>${reflection.learned}<br><br>` : ''}
                                    ${reflection.strengths ? `<strong>💪 Sterke punten:</strong><br>${reflection.strengths}<br><br>` : ''}
                                    ${reflection.different ? `<strong>🌟 Anders doen:</strong><br>${reflection.different}<br><br>` : ''}
                                    ${reflection.future ? `<strong>🚀 Voor de toekomst:</strong><br>${reflection.future}` : ''}
                                </div>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen reflecties</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Bewijsstukken functie voor doelen
function showGoalEvidence(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    // Ensure evidence array exists
    if (!goal.evidence) {
        goal.evidence = [];
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">📎 Bewijsstukken - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>📎 ${goal.evidence.length} bewijsstukken</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>📤 Nieuw Bewijsstuk Uploaden</h4>
                <p style="color: #667eea; font-style: italic; margin-bottom: 15px;">
                    Upload foto's, documenten of andere bestanden die aantonen dat je aan dit doel werkt.
                </p>
                
                <div class="evidence-upload-area" onclick="document.getElementById('evidenceFileInput-${goalId}').click()" 
                     ondrop="handleEvidenceDrop(event, '${goalId}')" 
                     ondragover="handleEvidenceDragOver(event)" 
                     ondragleave="handleEvidenceDragLeave(event)">
                    <h3>📁 Bestand Uploaden</h3>
                    <p>Klik hier of sleep bestanden naar dit gebied</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">
                        Ondersteunde formaten: JPG, PNG, PDF, DOC, TXT | Max 5MB per bestand
                    </p>
                    <input type="file" id="evidenceFileInput-${goalId}" style="display: none;" 
                           multiple accept="image/*,.pdf,.doc,.docx,.txt" 
                           onchange="handleEvidenceFiles(this.files, '${goalId}')">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: bold; margin-bottom: 5px;">Beschrijving van dit bewijsstuk</label>
                    <textarea id="evidenceDescription-${goalId}" 
                              style="width: 100%; height: 60px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px; resize: vertical;" 
                              placeholder="Leg uit wat dit bewijsstuk laat zien en hoe het relateert aan je doel..."></textarea>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>📎 Mijn Bewijsstukken (${goal.evidence.length})</h4>
                <div class="evidence-grid">
                    ${goal.evidence.length > 0 ? 
                        goal.evidence.map(evidence => `
                            <div class="evidence-item">
                                <button class="evidence-remove" onclick="removeGoalEvidence('${goalId}', '${evidence.id}', this.closest('.modal'))" title="Verwijderen">×</button>
                                
                                ${evidence.fileType && evidence.fileType.startsWith('image/') ? `
                                    <img src="${evidence.fileData}" alt="${evidence.title}" class="evidence-preview">
                                ` : `
                                    <div class="evidence-file-icon">
                                        ${getFileIcon(evidence.fileType)}
                                    </div>
                                `}
                                
                                <div class="evidence-title">${evidence.title}</div>
                                <div class="evidence-meta">
                                    📅 ${new Date(evidence.uploadedAt).toLocaleDateString('nl-NL')}<br>
                                    📄 ${evidence.fileName}
                                </div>
                                
                                ${evidence.description ? `
                                    <div style="font-size: 0.8rem; color: #555; margin: 8px 0; font-style: italic;">
                                        "${evidence.description}"
                                    </div>
                                ` : ''}
                                
                                <button class="evidence-download" onclick="downloadEvidence('${evidence.id}', '${evidence.fileName}', '${evidence.fileData}')">
                                    💾 Download
                                </button>
                            </div>
                        `).join('') 
                        : '<p style="text-align: center; color: #666; font-style: italic;">Nog geen bewijsstukken geüpload</p>'
                    }
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
// Helper functies voor bewijsstukken
function handleEvidenceFiles(files, goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (!goal.evidence) goal.evidence = [];
    
    Array.from(files).forEach(file => {
        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            showNotification(`Bestand "${file.name}" is te groot (max 5MB)`, 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const evidence = {
                id: generateId(),
                title: file.name.split('.')[0], // Filename without extension
                fileName: file.name,
                fileType: file.type,
                fileData: e.target.result,
                description: document.getElementById(`evidenceDescription-${goalId}`)?.value.trim() || '',
                uploadedAt: new Date().toISOString()
            };
            
            goal.evidence.push(evidence);
            
            addToTimeline(`📎 Bewijsstuk geüpload voor doel: ${goal.title} (${file.name})`, currentStudent.id);
            saveData();
            updatePortfolioSummary();
            
            showNotification(`Bewijsstuk "${file.name}" geüpload!`, 'success');
            
            // Refresh modal
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
                setTimeout(() => showGoalEvidence(goalId), 100);
            }
        };
        
        reader.onerror = function() {
            showNotification(`Fout bij uploaden van "${file.name}"`, 'error');
        };
        
        reader.readAsDataURL(file);
    });
}

function handleEvidenceDrop(e, goalId) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    handleEvidenceFiles(e.dataTransfer.files, goalId);
}

function handleEvidenceDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleEvidenceDragLeave(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
}

function getFileIcon(fileType) {
    if (!fileType) return '📄';
    
    if (fileType.startsWith('image/')) return '🖼️';
    if (fileType.includes('pdf')) return '📕';
    if (fileType.includes('word') || fileType.includes('document')) return '📘';
    if (fileType.includes('text')) return '📝';
    if (fileType.includes('video')) return '🎥';
    if (fileType.includes('audio')) return '🎵';
    
    return '📄';
}

function removeGoalEvidence(goalId, evidenceId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (confirm('Weet je zeker dat je dit bewijsstuk wilt verwijderen?')) {
        const evidence = goal.evidence.find(e => e.id === evidenceId);
        goal.evidence = goal.evidence.filter(e => e.id !== evidenceId);
        
        addToTimeline(`🗑️ Bewijsstuk verwijderd voor doel: ${goal.title} (${evidence?.fileName || 'Onbekend bestand'})`, currentStudent.id);
        saveData();
        updatePortfolioSummary();
        
        showNotification('Bewijsstuk verwijderd!', 'success');
        
        // Refresh modal
        modal.remove();
        setTimeout(() => showGoalEvidence(goalId), 100);
    }
}

function downloadEvidence(evidenceId, fileName, fileData) {
    try {
        const link = document.createElement('a');
        link.href = fileData;
        link.download = fileName;
        link.click();
        
        showNotification(`Download gestart: ${fileName}`, 'success');
    } catch (error) {
        console.error('Download error:', error);
        showNotification('Fout bij downloaden bestand', 'error');
    }
}
// Tijdlijn functie voor doelen
function showGoalTimeline(goalId) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    // Verzamel alle activiteiten voor dit doel
    const timelineEvents = [];
    
    // Doel aangemaakt
    timelineEvents.push({
        date: goal.createdAt,
        type: 'created',
        icon: '🎯',
        title: 'Doel aangemaakt',
        description: `Persoonlijk doel "${goal.title}" is toegevoegd`
    });
    
    // Logboek entries
    if (goal.logbookEntries && goal.logbookEntries.length > 0) {
        goal.logbookEntries.forEach(entry => {
            timelineEvents.push({
                date: entry.date,
                type: 'logbook',
                icon: '📝',
                title: 'Logboek entry',
                description: entry.content.substring(0, 100) + (entry.content.length > 100 ? '...' : ''),
                fullContent: entry.content,
                reflection: entry.reflection
            });
        });
    }
    
    // Evaluaties
    if (goal.evaluations && goal.evaluations.length > 0) {
        goal.evaluations.forEach(evaluation => {
            timelineEvents.push({
                date: evaluation.date,
                type: 'evaluation',
                icon: '📊',
                title: `Voortgang geëvalueerd`,
                description: `${evaluation.progress}% voortgang, ${evaluation.rating} sterren`,
                details: {
                    progress: evaluation.progress,
                    rating: evaluation.rating,
                    positive: evaluation.positive,
                    challenges: evaluation.challenges,
                    nextSteps: evaluation.nextSteps
                }
            });
        });
    }
    
    // Reflecties
    if (goal.reflections && goal.reflections.length > 0) {
        goal.reflections.forEach(reflection => {
            timelineEvents.push({
                date: reflection.date,
                type: 'reflection',
                icon: '🤔',
                title: 'Reflectie toegevoegd',
                description: 'Diepgaande reflectie op persoonlijke ontwikkeling',
                details: {
                    why: reflection.why,
                    learned: reflection.learned,
                    strengths: reflection.strengths,
                    different: reflection.different,
                    future: reflection.future
                }
            });
        });
    }
    
    // Bewijsstukken
    if (goal.evidence && goal.evidence.length > 0) {
        goal.evidence.forEach(evidence => {
            timelineEvents.push({
                date: evidence.uploadedAt,
                type: 'evidence',
                icon: '📎',
                title: 'Bewijsstuk geüpload',
                description: `"${evidence.title}" - ${evidence.fileName}`,
                details: {
                    fileName: evidence.fileName,
                    description: evidence.description
                }
            });
        });
    }
    
    // Doel voltooid (als van toepassing)
    if (goal.status === 'completed' && goal.completedAt) {
        timelineEvents.push({
            date: goal.completedAt,
            type: 'completed',
            icon: '✅',
            title: 'Doel voltooid!',
            description: `Doel "${goal.title}" succesvol afgerond`
        });
    }
    
    // Sorteer op datum (nieuwste eerst)
    timelineEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // Toon modal
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.zIndex = '1500';
    
    modal.innerHTML = `
        <div class="modal-content goal-detail-modal">
            <div class="goal-info-header">
                <div class="goal-info-title">📅 Tijdlijn - ${goal.title}</div>
                <div class="goal-info-meta">
                    <span>📂 ${getCategoryName(goal.category)}</span>
                    <span>📅 ${goal.deadline ? new Date(goal.deadline).toLocaleDateString('nl-NL') : 'Geen deadline'}</span>
                    <span>📋 ${timelineEvents.length} activiteiten</span>
                </div>
            </div>
            
            <div class="goal-content-section">
                <h4>📅 Chronologisch Overzicht</h4>
                <p style="color: #667eea; font-style: italic; margin-bottom: 20px;">
                    Alle activiteiten en mijlpalen voor dit persoonlijke doel op een rij.
                </p>
                
                <div class="goal-timeline-container" style="max-height: 400px; overflow-y: auto;">
                    ${timelineEvents.length > 0 ? timelineEvents.map((event, index) => `
                        <div class="goal-timeline-item" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: ${getTimelineItemColor(event.type)}; border-radius: 12px; border-left: 4px solid ${getTimelineItemBorderColor(event.type)};">
                            <div style="font-size: 2rem; min-width: 40px; text-align: center;">${event.icon}</div>
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                    <h5 style="margin: 0; color: #2d3748; font-weight: bold;">${event.title}</h5>
                                    <span style="color: #666; font-size: 0.8rem; white-space: nowrap; margin-left: 15px;">
                                        ${new Date(event.date).toLocaleDateString('nl-NL')} ${event.date.includes('T') ? 'om ' + new Date(event.date).toLocaleTimeString('nl-NL', {hour: '2-digit', minute: '2-digit'}) : ''}
                                    </span>
                                </div>
                                <div style="color: #555; margin-bottom: 10px; line-height: 1.4;">
                                    ${event.description}
                                </div>
                                
                                ${event.details ? `
                                    <div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 8px; font-size: 0.9rem;">
                                        ${renderTimelineEventDetails(event)}
                                    </div>
                                ` : ''}
                                
                                ${event.fullContent ? `
                                    <details style="margin-top: 8px;">
                                        <summary style="cursor: pointer; color: #667eea; font-weight: 600;">📖 Volledige inhoud</summary>
                                        <div style="margin-top: 8px; padding: 10px; background: rgba(255,255,255,0.7); border-radius: 6px; font-size: 0.9rem; line-height: 1.4;">
                                            ${event.fullContent.replace(/\n/g, '<br>')}
                                            ${event.reflection ? `<br><br><strong>Reflectie:</strong><br>${event.reflection.replace(/\n/g, '<br>')}` : ''}
                                        </div>
                                    </details>
                                ` : ''}
                            </div>
                        </div>
                    `).join('') : '<p style="text-align: center; color: #666;">Nog geen activiteiten voor dit doel</p>'}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="this.closest('.modal').remove()" style="background: #666; color: white;">
                    ✖️ Sluiten
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Helper functies voor tijdlijn
function getTimelineItemColor(type) {
    const colors = {
        created: '#f0f9ff',
        logbook: '#f8f9ff',
        evaluation: '#fff3cd',
        reflection: '#faf5ff',
        evidence: '#f0fff4',
        completed: '#d4edda'
    };
    return colors[type] || '#f8f9fa';
}

function getTimelineItemBorderColor(type) {
    const colors = {
        created: '#667eea',
        logbook: '#667eea',
        evaluation: '#fbbf24',
        reflection: '#9333ea',
        evidence: '#48bb78',
        completed: '#28a745'
    };
    return colors[type] || '#6c757d';
}

function renderTimelineEventDetails(event) {
    if (event.type === 'evaluation') {
        return `
            <strong>Details:</strong><br>
            • Voortgang: ${event.details.progress}%<br>
            • Beoordeling: ${'⭐'.repeat(event.details.rating)} (${event.details.rating}/5)<br>
            ${event.details.positive ? `• Positief: ${event.details.positive}<br>` : ''}
            ${event.details.challenges ? `• Uitdagingen: ${event.details.challenges}<br>` : ''}
            ${event.details.nextSteps ? `• Volgende stappen: ${event.details.nextSteps}` : ''}
        `;
    }
    
    if (event.type === 'reflection') {
        const details = event.details;
        let html = '<strong>Reflectie samenvatting:</strong><br>';
        if (details.why) html += `• Waarom belangrijk: ${details.why.substring(0, 80)}${details.why.length > 80 ? '...' : ''}<br>`;
        if (details.learned) html += `• Geleerd: ${details.learned.substring(0, 80)}${details.learned.length > 80 ? '...' : ''}<br>`;
        if (details.strengths) html += `• Sterke punten: ${details.strengths.substring(0, 80)}${details.strengths.length > 80 ? '...' : ''}`;
        return html;
    }
    
    if (event.type === 'evidence') {
        return `
            <strong>Bestand details:</strong><br>
            • Bestandsnaam: ${event.details.fileName}<br>
            ${event.details.description ? `• Beschrijving: ${event.details.description}` : ''}
        `;
    }
    
    return '';
}

function saveGoalLogbookEntry(goalId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    const content = document.getElementById('goalLogbookContent').value.trim();
    const reflection = document.getElementById('goalLogbookReflection').value.trim();
    
    if (!content) {
        showNotification('Voer in wat je hebt gedaan!', 'error');
        document.getElementById('goalLogbookContent').focus();
        return;
    }
    
    const now = new Date();
    const entry = {
        id: generateId(),
        content: content,
        reflection: reflection,
        date: now.toISOString(),
        time: now.toTimeString().split(' ')[0].substring(0, 5)
    };
    
    if (!goal.logbookEntries) goal.logbookEntries = [];
    goal.logbookEntries.push(entry);
    
    addToTimeline(`📝 Logboek entry toegevoegd voor doel: ${goal.title}`, currentStudent.id);
    saveData();
    updatePortfolioSummary();
    
    showNotification('Logboek entry opgeslagen!', 'success');
    
    modal.remove();
    setTimeout(() => showGoalLogbook(goalId), 100);
}

function saveGoalEvaluation(goalId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    const rating = window.currentGoalRating || 3;
    const progress = document.getElementById('goalProgressSlider').value;
    const positive = document.getElementById('goalEvalPositive').value.trim();
    const challenges = document.getElementById('goalEvalChallenges').value.trim();
    const nextSteps = document.getElementById('goalEvalNextSteps').value.trim();
    
    if (!positive && !challenges && !nextSteps) {
        showNotification('Vul minimaal één evaluatie veld in!', 'error');
        return;
    }
    
    const now = new Date();
    const evaluation = {
        id: generateId(),
        rating: rating,
        progress: parseInt(progress),
        positive: positive,
        challenges: challenges,
        nextSteps: nextSteps,
        date: now.toISOString(),
        time: now.toTimeString().split(' ')[0].substring(0, 5)
    };
    
    if (!goal.evaluations) goal.evaluations = [];
    goal.evaluations.push(evaluation);
    
    addToTimeline(`📊 Voortgang geëvalueerd voor doel: ${goal.title} (${progress}%, ${rating}⭐)`, currentStudent.id);
    saveData();
    updatePortfolioSummary();
    
    showNotification('Evaluatie opgeslagen!', 'success');
    
    modal.remove();
    setTimeout(() => showGoalEvaluation(goalId), 100);
}

function saveGoalReflection(goalId, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    const why = document.getElementById('goalReflectionWhy').value.trim();
    const learned = document.getElementById('goalReflectionLearned').value.trim();
    const strengths = document.getElementById('goalReflectionStrengths').value.trim();
    const different = document.getElementById('goalReflectionDifferent').value.trim();
    const future = document.getElementById('goalReflectionFuture').value.trim();
    
    if (!why && !learned && !strengths && !different && !future) {
        showNotification('Vul minimaal één reflectie vraag in!', 'error');
        return;
    }
    
    const now = new Date();
    const reflection = {
        id: generateId(),
        why: why,
        learned: learned,
        strengths: strengths,
        different: different,
        future: future,
        date: now.toISOString(),
        time: now.toTimeString().split(' ')[0].substring(0, 5)
    };
    
    if (!goal.reflections) goal.reflections = [];
    goal.reflections.push(reflection);
    
    addToTimeline(`🤔 Reflectie toegevoegd voor doel: ${goal.title}`, currentStudent.id);
    saveData();
    updatePortfolioSummary();
    
    showNotification('Reflectie opgeslagen!', 'success');
    
    modal.remove();
    setTimeout(() => showGoalReflection(goalId), 100);
}

function deleteGoalEntry(goalId, entryId, arrayName, modal) {
    if (!currentStudent) return;
    
    const goal = currentStudent.personalGoals?.find(g => g.id === goalId);
    if (!goal) return;
    
    if (confirm('Weet je zeker dat je deze entry wilt verwijderen?')) {
        if (goal[arrayName]) {
            goal[arrayName] = goal[arrayName].filter(entry => entry.id !== entryId);
            
            saveData();
            updatePortfolioSummary();
            
            showNotification('Entry verwijderd!', 'success');
            
            const goalIdForRefresh = goalId;
            modal.remove();
            setTimeout(() => {
                if (arrayName === 'logbookEntries') showGoalLogbook(goalIdForRefresh);
                else if (arrayName === 'evaluations') showGoalEvaluation(goalIdForRefresh);
                else if (arrayName === 'reflections') showGoalReflection(goalIdForRefresh);
            }, 100);
        }
    }
}

function setGoalRating(rating) {
    window.currentGoalRating = rating;
    
    const stars = document.querySelectorAll('#goalProgressRating .rating-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.style.color = '#ffd700';
            star.classList.add('active');
        } else {
            star.style.color = '#ddd';
            star.classList.remove('active');
        }
    });
}

function updateProgressDisplay(value) {
    document.getElementById('progressDisplay').textContent = value + '%';
}
	

        // ✅ UPDATE BESTAANDE GROEP FUNCTIE
        function assignTokenToGroup(tokenId, groupId, modal) {
            assignTokenToGroupSafely(tokenId, groupId).then(success => {
                if (success && modal) {
                    modal.remove();
                }
            });
        }
		// ✅ PRESENTATIE MODUS FUNCTIES
function renderPresentationView() {
    console.log('🎯 Rendering presentation view with mode:', currentPresentationView);
    const container = document.getElementById('presentationStudents');
    
    if (!container) {
        console.error('❌ Presentation container not found');
        return;
    }

    // Update grid size class
    container.className = `presentation-students-grid grid-${currentGridSize}`;
    
    let studentsToShow = [];
    
    switch (currentPresentationView) {
        case 'individual':
            studentsToShow = students.map(student => ({ 
                type: 'student', 
                student: student 
            }));
            break;
            
        case 'groups':
            studentsToShow = groups.map(group => ({
                type: 'group',
                group: group,
                members: group.members.map(memberId => students.find(s => s.id === memberId)).filter(Boolean)
            }));
            break;
            
        case 'mixed':
            // Individual students without groups
            const studentsWithoutGroup = students.filter(s => !s.groupId).map(student => ({ 
                type: 'student', 
                student: student 
            }));
            // Groups
            const groupItems = groups.map(group => ({
                type: 'group',
                group: group,
                members: group.members.map(memberId => students.find(s => s.id === memberId)).filter(Boolean)
            }));
            studentsToShow = [...studentsWithoutGroup, ...groupItems];
            break;
    }

    if (studentsToShow.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 3rem;">Geen leerlingen of groepen om te tonen</p>';
        return;
    }

    container.innerHTML = studentsToShow.map(item => {
        if (item.type === 'student') {
            return renderPresentationStudent(item.student);
        } else {
            return renderPresentationGroup(item.group, item.members);
        }
    }).join('');
    
    console.log('✅ Presentation view rendered with', studentsToShow.length, 'items');
}

function renderPresentationStudent(student) {
    const tokens = student.tokens || [];
    const recentTokens = tokens.slice(-10); // Show last 10 tokens (shield formation)
    const totalMilestones = student.achievedMilestones?.length || 0;
    const avgSkill = Math.round(Object.values(student.skills || {}).reduce((sum, val) => sum + val, 0) / 5);

    return `
        <div class="presentation-student-card" onclick="showPresentationTokenModal('${student.id}')">
            <div class="presentation-student-name">${student.name}</div>
            
            <div class="presentation-tokens">
                ${recentTokens.map(token => {
                    const tokenType = tokenTypes.find(t => t.id === token.type);
                    return tokenType ? `
                        <div class="presentation-token" style="background: ${tokenType.color};" title="${tokenType.name}">
                            ${tokenType.emoji}
                        </div>
                    ` : '';
                }).join('')}
                ${recentTokens.length < 10 ? 
                    Array(9 - recentTokens.length).fill().map(() => 
                        '<div class="presentation-token" style="background: #e2e8f0; color: #666;">+</div>'
                    ).join('') 
                    : ''
                }
            </div>
            
            <div class="presentation-stats">
                🎨 ${tokens.length} tokens | 🏆 ${totalMilestones} mijlpalen | 📊 ${avgSkill}%
            </div>
        </div>
    `;
}
function renderPresentationGroup(group, members) {
    const totalTokens = members.reduce((sum, member) => sum + (member.tokens?.length || 0), 0);
    const totalMilestones = members.reduce((sum, member) => sum + (member.achievedMilestones?.length || 0), 0);
    const avgSkill = members.length > 0 ? 
        Math.round(members.reduce((sum, member) => 
            sum + Object.values(member.skills || {}).reduce((skillSum, val) => skillSum + val, 0) / 5, 0
        ) / members.length) : 0;

    const memberNames = members.map(m => m.name).join(', ');

    return `
        <div class="presentation-student-card" onclick="showGroupTokenModal('${group.id}')">
            <div class="presentation-student-name">
                ${group.icon || '👥'} ${group.name}
                <div style="font-size: 0.8rem; margin-top: 5px; opacity: 0.8;">
                    ${members.length} leden: ${memberNames}
                </div>
            </div>
            
            <div class="presentation-tokens">
                ${members.slice(0, 3).map(member => {
                    const recentToken = member.tokens?.slice(-1)[0];
                    const tokenType = recentToken ? tokenTypes.find(t => t.id === recentToken.type) : null;
                    const bgColor = tokenType ? tokenType.color : '#e2e8f0';
                    const content = tokenType ? tokenType.emoji : member.name.charAt(0);
                    
                    return `<div class="presentation-token" style="background: ${bgColor};" title="${member.name}">${content}</div>`;
                }).join('')}
            </div>
            
            <div class="presentation-stats">
                🎨 ${totalTokens} tokens | 🏆 ${totalMilestones} mijlpalen | 📊 ${avgSkill}%
            </div>
        </div>
    `;
}
function setGridSize(size) {
    currentGridSize = size;
    
    // Update button states
    document.querySelectorAll('[onclick^="setGridSize("]').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#e2e8f0';
        btn.style.color = '#2d3748';
    });
    
    const activeBtn = document.querySelector(`[onclick="setGridSize(${size})"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.background = '#667eea';
        activeBtn.style.color = 'white';
    }
    
    renderPresentationView();
    saveData(); // Save the preference
}

function setPresentationView(viewType) {
    currentPresentationView = viewType;
    
    // Update button states
    document.querySelectorAll('.presentation-view-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#e2e8f0';
        btn.style.color = '#2d3748';
    });
    
    const activeBtn = document.querySelector(`[onclick="setPresentationView('${viewType}')"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.style.background = '#667eea';
        activeBtn.style.color = 'white';
    }
    
    renderPresentationView();
    saveData(); // Save the preference
}

    </script>

</body>
</html>